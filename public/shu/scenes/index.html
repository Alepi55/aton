<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<link rel="icon" href="../appicon.png" sizes="512x512" type="image/png">

<!-- Add iOS meta tags and icons -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<meta name="apple-mobile-web-app-title" content="New Scene">
<link rel="apple-touch-icon" href="../appicon.png">
<meta name="description" content="Users">
<!-- Add meta theme-color -->
<meta name="theme-color" content="#000000" />

<title>Scenes</title>
<link rel="stylesheet" type="text/css" href="../../res/css/aton.css">
<script type="text/javascript" src="../../vendors/vendors.min.js"></script>
<script type="text/javascript" src="../../dist/THREE.bundle.js"></script>
<script type="text/javascript" src="../../dist/ATON.min.js"></script>
<script type="text/javascript" src="../shu.js"></script>

<script>

let renderGallery = ()=>{

    let htmlcontent = "";
    htmlcontent += "<div class='atonTitle'>Your Scenes</div><br>";
    htmlcontent += "<div id='btn-newscene' class='atonBTN atonBTN-green' style='width: 90%;'><img src='"+ATON.PATH_RES+"icons/scene.png'>New Scene</div>";
    htmlcontent += "<br><br>";

    $('#idContent').append(htmlcontent);

    $("#btn-newscene").click(()=>{
        window.location.href = "/shu/newscene/";
    });

    $.getJSON( ATON.PATH_RESTAPI+"scenes/own", (data)=>{


        for (let i in data){
            let scene = data[i];
            let sid = scene.sid;

            let urlCover = (scene.cover)? ATON.PATH_SCENES+sid+"/cover.png" : ATON.PATH_RES+"scenecover.png";

            let shtml = "";
            shtml += "<div id='s"+i+"' class='atonGalleryItem' style='position:relative; width:250px; margin:10px'>";

            shtml += "<div class='atonBlurBG' style='width:250px; height:320px; background-image: url(\""+urlCover+"\")'></div>";

            shtml += "<div style='width:250px; height:320px; position:absolute; top:0; left:0'>";
            shtml += "<div class='atonBlockSubTitle'>"+sid+"</div><br>";
            

            shtml += "<a class='atonCover' href='/s/"+sid+"'>";
            shtml += "<img src='"+urlCover+"'>";
            shtml += "</a>";

            shtml += "<br>";
            shtml += "<a class='atonBTN' href='/shu/scenes/?s="+sid+"' style='width:60%; background-color:rgba(0,0,0,0.2)'><img src='"+ATON.PATH_RES+"icons/settings.png'>Edit</a>";
            shtml += "</div>";
            
/*
            shtml += "<div id='delAsk-"+i+"' class='atonBTN atonBTN-red'><img src='"+ATON.PATH_RES+"icons/trash.png'></div>";

            shtml += "<div id='clone-"+i+"' class='atonBTN'><img src='"+ATON.PATH_RES+"icons/clone.png'></div>";
            
            shtml += "<div id='delConf-"+i+"' style='display:none;'>Delete this scene: are you sure?<br>";
            shtml += "<div id='del-"+i+"' class='atonBTN atonBTN-red'>YES</div><div id='delNo-"+i+"' class='atonBTN'>NO</div>";
            shtml += "</div>";
*/     
            shtml += "</div>";

            $('#idContent').append(shtml);

/*
            $('#clone-'+i).click(()=>{
                ATON.Utils.postJSON(ATON.PATH_RESTAPI+"clone/scene", {sid: sid}, (newsid)=>{
                    console.log(newsid);
                });
            });

            $('#delAsk-'+i).click(()=>{
                $('#delConf-'+i).show();
                $('#go-'+i).hide();
                $('#delAsk-'+i).hide();
                $('#clone-'+i).hide();

                $("#s"+i).css("background-color","rgba(127,0,0,0.3)");

                $('#del-'+i).click(()=>{
                    ATON.Utils.postJSON(ATON.PATH_RESTAPI+"del/scene", {sid: sid}, (b)=>{
                        if (b) $("#s"+i).hide();
                    });
                });

                $('#delNo-'+i).click(()=>{
                    $('#delConf-'+i).hide();
                    $("#s"+i).css("background-color","");
                    $('#go-'+i).show();
                    $('#delAsk-'+i).show();
                    $('#clone-'+i).show();
                });
            });
*/
        }
        
    });
};

let renderScene = (sid)=>{
    $('#idContent').html("");

    let htmlcontent = "";
    htmlcontent += "<div class='atonTitle'>"+sid+"</div><br>";

    $('#idContent').append(htmlcontent);

    $.getJSON( ATON.PATH_RESTAPI+"scene/"+sid, (data)=>{
        console.log(data);

        let shtml = "";
        shtml += "<div id='idSceneBlock' class='atonBlockRound' style='background-color: rgba(0,0,0,0.3); text-align:justify; min-width:50%'>";
        if (data.title) shtml += "<div class='atonBlockTitle'>"+data.title+"</div><br>";
        else shtml += "<div class='atonBlockTitle'>No Title</div><br>";

        shtml += "<div style='display:block; width:90%; min-height:250px; vertical-align:top'>";

        // cover
        shtml += "<a href='/s/"+sid+"' class='atonCover' style='display:inline-block; width:250px; float:left' >";
        shtml += "<img src='"+ATON.PATH_SCENES+sid+"/cover.png' onerror='SHU.onCoverNotFound(this);'>";
        shtml += "</a>";

        // Scene fields
        shtml +="<div style='text-align:left; padding:20px'>";
        if (data.status) shtml += "<b>Status:</b><span class='atonKeyword'>"+data.status+"</span><br>";
        if (data.scenegraph){
            shtml += "<b>Scene-graph nodes:</b> ";
            for (let n in data.scenegraph.nodes) shtml += "<span class='atonKeyword'>"+n+"</span>";
            shtml += "<br>";
        }
        if (data.semanticgraph){
            shtml += "<b>Semantic-graph nodes:</b> ";
            for (let n in data.semanticgraph.nodes) shtml += "<span class='atonKeyword'>"+n+"</span>";
            shtml += "<br>"; 
        }
        if (data.environment){
            shtml += "<b>Main panorama:</b> ";
            if (data.environment.mainpano) shtml += "<span class='atonKeyword'>yes</span>";
            else shtml += "<span class='atonKeyword'>no</span>";
            shtml += "<br>"; 
        }
        if (data.description) shtml += "<b>Description:</b> "+JSON.parse(data.description);
        shtml += "</div>";
        
        shtml += "</div>";

        // Actions
        shtml += "<div style='text-align:center'>";
        shtml += "<div id='idActions'>";
        shtml += "<a id='idOpen' href='/s/"+sid+"' class='atonBTN atonBTN-green' style='width:150px'><img src='"+ATON.PATH_RES+"icons/hathor.png'>Open</a>";
        shtml += "<div id='idClone' class='atonBTN' style='width:150px'><img src='"+ATON.PATH_RES+"icons/clone.png'>Clone</div>";
        shtml += "<div id='delAsk' class='atonBTN atonBTN-red' style='width:150px'><img src='"+ATON.PATH_RES+"icons/trash.png'>Delete</div>";
        shtml += "</div><br>";

        shtml += "<div id='idConfirmDel' style='display:none'>";
        shtml += "Are you sure to DELETE this scene? ";
        shtml += "<div id='delYES' class='atonBTN atonBTN-red'>YES</div>";
        shtml += "<div id='delNO' class='atonBTN'>NO</div>";
        shtml += "</div>";
        shtml += "</div>";

        shtml += "</div>";

        $('#idContent').append(shtml);

        $('#delAsk').click(()=>{
            $("#idActions").hide();
            $("#idConfirmDel").show();
            $("#idSceneBlock").css("background-color","rgba(127,0,0,0.3)");
        });

        $('#delYES').click(()=>{
            ATON.Utils.postJSON(ATON.PATH_RESTAPI+"del/scene", {sid: sid}, (b)=>{
                if (b) window.location.href = "/shu/scenes";
            });
        });

        $('#delNO').click(()=>{
            $("#idActions").show();
            $("#idConfirmDel").hide(); 
            $("#idSceneBlock").css("background-color","rgba(0,0,0,0.3)");     
        });

        $('#idClone').click(()=>{
            ATON.Utils.postJSON(ATON.PATH_RESTAPI+"clone/scene", {sid: sid}, (newsid)=>{
                if (newsid) window.location.href = "/s/"+newsid;
            });
        });

    });
};

window.addEventListener( 'load', ()=>{

    SHU.uiAddMainToolbar("idTopToolbar");

    let urlParams = new URLSearchParams(window.location.search);
    let sid = urlParams.get('s');

    ATON.Utils.checkAuth((data)=>{
        if (data.username){
            if (sid && sid.startsWith(data.username)) renderScene(sid);
            else renderGallery();
        }
        else {
            window.location.href = "/shu/auth/?url="+window.location.href;
        }
    });

});

</script>
</head>

<body class="atonDefaultBody">
    <div id="idTopToolbar" class="atonToolbar atonToolbar-top-left scrollableX shuTopToobar"></div>

    <div id='idContent' class='shuMainContainer'>
<!--
        <div class="atonTitle">Your Scenes</div><br>
        <div id="btn-newscene" class="atonBTN atonBTN-green" style="width: 90%;"><img src='../../res/icons/scene.png'>New Scene</div>
        <br><br>

        <div class="" id='idOwnScenes'></div>
-->
    </div>
    
</body>