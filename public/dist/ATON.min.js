/*! For license information please see ATON.min.js.LICENSE.txt */
(()=>{"use strict";class e extends THREE.Group{constructor(e,t){super(),this.type=t||ATON.NTYPES.SCENE,this.enablePicking(),this.type===ATON.NTYPES.SCENE&&(this._rootG=ATON._rootVisible,this._nodes=ATON.snodes),this.type===ATON.NTYPES.SEM&&(this._rootG=ATON._rootSem,this._nodes=ATON.semnodes),this.type===ATON.NTYPES.UI&&(this._rootG=ATON._rootUI,this._nodes=ATON.uinodes),this.as(e),this.kwords=void 0,this._bCloneOnLoadHit=!0,this._tlist=void 0,this._aniMixers=void 0,this.castShadow=!1,this.receiveShadow=!1,this._bs=new THREE.Sphere,this.autocenter=!1,this.onHover=void 0,this.onLeave=void 0,this.onSelect=void 0}as(e){if(void 0!==e&&e!==ATON.ROOT_NID)return this._nodes[e]=this,this.nid=e,this.name=e,this}setAsRoot(){return this._nodes[ATON.ROOT_NID]=this,this.nid=ATON.ROOT_NID,this}setCloneOnLoadHit(e){return this._bCloneOnLoadHit=e,this}addKeywords(e){let t=e.split(",");void 0===this.kwords&&(this.kwords={});for(let e in t){let o=t[e].trim();o.length>0&&(this.kwords[o]=!0)}for(let t in this.children){let o=this.children[t];void 0!==o.type&&o.addKeywords(e)}return this}hasKeyword(e){if(void 0!==this.kwords)return void 0!==this.kwords[e]}setDescription(e){return this.userData.description=e,this}getDescription(){return this.userData.description}setAudio(e){return this.userData.audio=e,this}getAudio(){return this.userData.audio}hide(){return this.visible=!1,ATON.Utils.setPicking(this,this.type,!1),ATON._renderer.shadowMap.enabled&&(ATON._dMainL.shadow.needsUpdate=!0),this}show(){return this.visible=!0,ATON.Utils.setPicking(this,this.type,this.bPickable),ATON._renderer.shadowMap.enabled&&void 0!==ATON._dMainL&&void 0!==ATON._dMainL.shadow&&(ATON._dMainL.shadow.needsUpdate=!0),this}toggle(e){return void 0===e?this.visible?this.hide():this.show():e?this.show():this.hide()}disablePicking(){return this.bPickable=!1,ATON.Utils.setPicking(this,this.type,this.bPickable),this}enablePicking(){return this.bPickable=!0,ATON.Utils.setPicking(this,this.type,this.bPickable),this}setPickable(e){return e?this.enablePicking():this.disablePicking(),this}setMaterial(e){this.userData.cMat=e,this.traverse((t=>{t.isMesh&&(t.material=e),t.type&&(this.userData.cMat=e)}));for(let t in this.children){let o=this.children[t];o.setMaterial&&o.setMaterial(e)}return this}getMaterial(){return this.userData.cMat}setDefaultAndHighlightMaterials(e,t){return this.userData.matSTD=e,this.userData.matHL=t,this}highlight(){return this.userData.matHL&&this.setMaterial(this.userData.matHL),this}restoreDefaultMaterial(){return this.userData.matSTD&&this.setMaterial(this.userData.matSTD),this}setOpacity(e){return this.traverse((t=>{t.isMesh&&(t.material.opacity=e)})),this}setShadowCast(e){return this.castShadow=e,this.traverse((t=>{t.isMesh&&(t.castShadow=e)})),this}setShadowReceive(e){return this.receiveShadow=e,this.traverse((t=>{t.isMesh&&(t.receiveShadow=e)})),this}setEnvMap(e){return this.traverse((t=>{t.isMesh&&(t.material.envMap=e)})),this}assignLightProbe(e){return this.traverse((t=>{t.isMesh&&t.geometry&&ATON.Utils.assignLightProbeToMesh(e,t)})),this}assignLightProbesByProximity(){return 0===ATON._lps.length||this.traverse((e=>{if(e.isMesh&&e.geometry){let t,o,i=new THREE.Vector3;(new THREE.Box3).setFromObject(e).getCenter(i);for(let e in ATON._lps){let r=ATON._lps[e],n=i.distanceToSquared(r.pos);(void 0===t||n<o)&&(o=n,t=r)}t&&ATON.Utils.assignLightProbeToMesh(t,e)}})),this}clearLightProbing(){return this.traverse((e=>{e.isMesh&&e.geometry&&(ATON.Utils.clearLightProbeFromMesh(e),e.material&&(e.material.envMap.dispose(),e.material.needsUpdate=!0))})),this}updateLightProbes=()=>(this.traverse((e=>{if(e.isMesh&&e.geometry){let t=e.userData.LP;void 0!==t&&(t.update(),e.material.envMap=t.getEnvTex(),e.material.needsUpdate=!0)}})),this);duplicate(){let e=this.clone();return e.traverse((e=>{e.isMesh&&(e.material=e.material.clone())})),e}delete(){let e=this.parent;void 0!==e&&void 0!==e.nid&&e.removeChild(this)}removeChild(e){if(void 0!==e)return e.nid,void 0!==e.nid&&(this._nodes[e.nid]=void 0),e.parent=void 0,e.traverse((e=>{e.geometry&&e.geometry.dispose(),e.material&&e.material.dispose()})),this.remove(e),this}removeChildren(){for(let e=this.children.length-1;e>=0;e--)this.removeChild(this.children[e]);return this}attachTo(e){let t="string"==typeof e?this._nodes[e]:e;return t&&(t.add(this),void 0!==t.userData.cMat&&(this.userData.cMat=t.userData.cMat),void 0!==t.bPickable&&(this.bPickable=t.bPickable)),t}attachToRoot(){return this._rootG.add(this),void 0!==this._rootG.userData.cMat&&(this.userData.cMat=this._rootG.userData.cMat),void 0!==this._rootG.bPickable&&(this.bPickable=this._rootG.bPickable),this._rootG}getBound(){return this.dirtyBound(),this._bs}dirtyBound(){return(new THREE.Box3).setFromObject(this).getBoundingSphere(this._bs),this}setPosition(e,t,o){return e instanceof THREE.Vector3?this.position.copy(e):this.position.set(e,t,o),this}setScale(e,t,o){return e instanceof THREE.Vector3?this.scale.copy(e):(void 0===t&&(t=e,o=e),this.scale.set(e,t,o)),this}setRotation(e,t,o){return e instanceof THREE.Vector3?this.rotation.copy(e):this.rotation.set(e,t,o),this}orientToCamera(){return this.quaternion.copy(ATON.Nav._qOri),this}setYup(){return this.rotation.set(-1.57079632679,0,0),this}addTransform(e){let t;return"string"==typeof e&&(t=ATON.Utils.parseTransformString(e)),void 0===t||(void 0===this._tlist&&(this._tlist=[]),this._tlist.push(t)),this}load(e,t){if(void 0===e)return this;let o=this;if(e=ATON.Utils.resolveCollectionURL(e),ATON.Utils.tryLoadFromService(e,o))return t&&t(),o;let i=ATON.Utils.getFileExtension(e);if("json"===i)return ATON.MRes.loadTileSetFromURL(e,o),t&&t(),o;if("ifc"===i)return o;if(ATON._resHandler&&ATON._resHandler[i])return ATON._resHandler[i](e,o),o;if(o._bCloneOnLoadHit&&void 0!==ATON._assetsManager[e])return ATON._assetsManager[e].then((e=>{let i=e.clone();if(ATON.Utils.modelVisitor(o,i),void 0!==o._tlist)for(let e in o._tlist)o._tlist[e].add(i.clone()),o.add(o._tlist[e]);else o.add(i);t&&t()})),o;ATON._assetReqNew(e);let r=new Promise(((i,r)=>{ATON._aLoader.load(e,(r=>{let n=r.scene||r.scene[0];if(ATON.Utils.modelVisitor(o,n),void 0!==o._tlist)for(let e in o._tlist)o._tlist[e].add(n.clone()),o.add(o._tlist[e]);else o.add(n);ATON.Utils.registerAniMixers(o,r),ATON.CC.extract(r),i(n),console.log("%cModel loaded","color:green"),ATON._assetReqComplete(e),o.type===ATON.NTYPES.SCENE&&(ATON._bqScene=!0),o.type===ATON.NTYPES.SEM&&(ATON._bqSem=!0),o.bPickable&&o.enablePicking(),o.dirtyBound(),t&&t()}),void 0,(o=>{console.log("%cError loading model "+e,"color:red"),ATON._assetReqComplete(e),t&&t()}))}));return o._bCloneOnLoadHit&&(ATON._assetsManager[e]=r),this}exportAs(e){return ATON.Utils.exportNode(this,e),this}setOnHover(e){return this.onHover=e,this}setOnLeave(e){return this.onLeave=e,this}setOnSelect(e){return this.onSelect=e,this}loadCesiumIONAsset(e){return ATON.MRes.loadCesiumIONAsset(e,this),this}loadSketchfabAsset(e){let t=ATON.getAPIToken("sketchfab"),o=this;return null==t&&(console.log("A valid Sketchfab token is required"),t=prompt("Please enter a valid Sketchfab token:"),null==t||""==t)||fetch("https://api.sketchfab.com/v3/models/"+e+"/download",{method:"GET",headers:{Authorization:"Token "+t},mode:"cors"}).then((function(e){return e.json()})).then((function(e){if(ATON.setAPIToken("sketchfab",t),e.glb){let t=e.glb.url;return o.load(t),o}})),this}}const t=e;let o={init:()=>{o.evLocal={},o.evNetwork={},ATON.on=o.on,ATON.fireEvent=o.fireEvent,ATON.clearEventHandlers=o.clearEventHandlers},clearEventHandlers:e=>{o.evLocal[e]=[],o.evNetwork[e]=[]},executeHandlers:(e,t)=>{if(e)for(let o=0;o<e.length;o++){const i=e[o];i&&i(t)}},on:(e,t,i)=>{if(void 0!==t){const i=o.evLocal;void 0===i[e]&&(i[e]=[]),i[e].push(t)}void 0!==i&&ATON.VRoadcast.on(e,i)},fireEvent:(e,t,i)=>{const r=o.evLocal[e];o.executeHandlers(r,t),i&&ATON.VRoadcast.fireEvent(e,t)}};const i=o;let r={init:()=>{r.materials={},r.colors={},r._loader=new THREE.MaterialLoader,r._uSem={time:{type:"float",value:0},tint:{type:"vec4",value:new THREE.Vector4(.2,.2,1,.2)}},r.addDefaults()},getDefVertexShader:()=>"\n        varying vec3 vPositionW;\n        varying vec3 vNormalW;\n        varying vec3 vNormalV;\n\n        void main(){\n            vPositionW = vec3( vec4( position, 1.0 ) * modelMatrix);\n            vNormalW   = normalize( vec3( vec4( normal, 0.0 ) * modelMatrix ) );\n            vNormalV   = normalize( vec3( normalMatrix * normal ));\n\n            gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n        }\n    ",addDefaults:()=>{r.colors.white=new THREE.Color(1,1,1),r.colors.black=new THREE.Color(0,0,0),r.colors.green=new THREE.Color(0,1,0),r.colors.yellow=new THREE.Color(1,1,0),r.colors.red=new THREE.Color(1,0,0),r.colors.blue=new THREE.Color(0,0,1),r.colors.orange=new THREE.Color(1,.5,0),r.colors.defUI=new THREE.Color(.85,1,.95),r.colors.sem=new THREE.Color(0,1,.5),r.colors.darksem=new THREE.Color(0,0,.1),r.materials.fullyTransparent=new THREE.MeshBasicMaterial({transparent:!0,depthWrite:!1,opacity:0}),r.materials.defUI=new THREE.ShaderMaterial({uniforms:{tint:{type:"vec3",value:r.colors.defUI},opacity:{type:"float",value:.8}},vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            uniform vec3 tint;\n            //uniform vec3 base;\n            uniform float opacity;\n\n\t\t    void main(){\n\t\t        //vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                float f;\n\t\t        //f = dot(vNormalV, viewDirectionW);\n                f = dot(vNormalV, vec3(0,0,1));\n\t\t        f = clamp(1.0-f, 0.0, 1.0);\n                f *= f;\n\n                //vec3 col = mix(base,tint, f);\n\t\t        //gl_FragColor = vec4(col, f * opacity);\n\n                gl_FragColor = vec4(tint, f * opacity);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.selector=r.materials.defUI.clone(),r.materials.outline=new THREE.MeshBasicMaterial({color:r.colors.black,side:THREE.BackSide,transparent:!0,depthWrite:!1,opacity:.2}),r.materials.controllerRay=r.materials.defUI.clone(),r.materials.controllerRay.uniforms.tint.value=r.colors.white,r.materials.xray=r.materials.defUI.clone(),r.materials.xray.uniforms.tint.value=r.colors.white,r.materials.xray.uniforms.opacity.value=.5,r.materials.teleportLoc=new THREE.MeshBasicMaterial({transparent:!0,opacity:1,depthWrite:!1,side:THREE.DoubleSide}),ATON.Utils.textureLoader.load(ATON.PATH_RES+"grad.png",(e=>{r.materials.teleportLoc.map=e})),r.materials.measurement=new THREE.MeshBasicMaterial({color:r.colors.white,transparent:!0,depthWrite:!1,opacity:.5,depthTest:!1}),r.materials.semanticShape=new THREE.ShaderMaterial({uniforms:r._uSem,vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n            uniform float time;\n            uniform vec4 tint;\n\n\t\t    void main(){\n\t\t        //vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                //float ff = dot(vNormalV, vec3(0,0,1));\n\t\t        //ff = clamp(1.0-ff, 0.0, 1.0);\n\n                float f = (1.0 * cos(time*2.0)); // - 0.5;\n                //f = cos(time + (vPositionW.y*10.0));\n                f = clamp(f, 0.0,1.0);\n\n\t\t        gl_FragColor = vec4(tint.rgb, tint.a * f);\n                //gl_FragColor = vec4(tint.rgb, ff);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.semanticShapeHL=new THREE.MeshBasicMaterial({color:r.colors.sem,transparent:!0,depthWrite:!1,opacity:.2}),r.materials.semanticShapeEdit=new THREE.MeshBasicMaterial({color:r.colors.orange,transparent:!0,depthWrite:!1,opacity:.5}),r.materials.transWhite=new THREE.MeshBasicMaterial({color:r.colors.white,transparent:!0,depthWrite:!1,side:THREE.DoubleSide,opacity:.2}),r.materials.transBlack=new THREE.MeshBasicMaterial({color:r.colors.black,transparent:!0,depthWrite:!1,side:THREE.DoubleSide,opacity:.2}),r.materials.wireframe=new THREE.MeshBasicMaterial({color:r.colors.black,transparent:!0,depthWrite:!1,opacity:.1,wireframe:!0}),r.materials.normSlope=new THREE.ShaderMaterial({vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n\n\t\t    void main(){\n                vec4 A = vec4(0,1,0, 1.0);\n                vec4 B = vec4(1,0,0, 1.0);\n\n                float f;\n                f = dot(vNormalW, vec3(0,1,0));\n\n\t\t        gl_FragColor = mix(B,A, f);\n\t\t    }\n        "}),r.materials.lp=new THREE.ShaderMaterial({vertexShader:r.getDefVertexShader(),fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n\n\t\t    void main(){\n\t\t        vec3 viewDirectionW = normalize(cameraPosition - vPositionW);\n\n                float f;\n\t\t        //f = dot(viewDirectionW, vNormalW);\n                f = dot(vNormalV, vec3(0,0,1));\n\t\t        f = clamp(1.0 - f, 0.0, 1.0);\n\n\t\t        gl_FragColor = vec4(1.0,1.0,1.0, f);\n\t\t    }\n        ",transparent:!0,depthWrite:!1}),r.materials.point=new THREE.PointsMaterial({vertexColors:!0,depthTest:!0,transparent:!1,size:.005,sizeAttenuation:!0})},addMaterial:(e,t)=>{r.materials[e]?console.log("MatHub: material "+e+" already registered"):r.materials[e]=t},loadMaterial:(e,t)=>{r._loader.load(t,(t=>{r.addMaterial(e,t)}),void 0,(e=>{console.log(e)}))},getMaterial:e=>r.materials[e],update:()=>{r._uSem.time.value+=ATON._dt}};const n=r;let s={TSTRING_SEPARATOR:" ",init:()=>{ATON.device={},s.geomUnitSphere=new THREE.SphereGeometry(1,16,16),s.geomUnitCube=new THREE.BoxGeometry,s.exporterGLTF=void 0,s.exporterOBJ=void 0,s.exporterUSDZ=void 0,s._dlink=document.createElement("a"),s._dlink.style.display="none",document.body.appendChild(s._dlink),s.textureLoader=new THREE.TextureLoader,s._bvhBounds=0,s.stats={},s.stats.numVertices=0,s.stats.numTris=0,s.tsSchedCB=e=>{ATON._tsTasks.push(e)}},generateID:e=>(void 0===e&&(e="id"),e+"-"+Math.random().toString(36).substr(2,9)),goToURL:e=>{window.location.href=e},goToScene:(e,t)=>{if(void 0===e)return;if(e.length<2)return;let o=ATON.PATH_FE+e;void 0!==t&&(o+="&vrc="+t),window.location.href=o},isConnectionSecure:()=>window.isSecureContext,showBVHbounds:e=>{e>0&&(s._bvhBounds=e)},_addBVHbounds:(e,t)=>{if(void 0===e)return;let o=new ThreeMeshBVH.MeshBVHVisualizer(e,t);o.displayParents=!0,o.update(),e.parent.add(o)},profileDevice:()=>{ATON.device.isMobile=!1,ATON.device.isMobile=!(!/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|ipad|iris|kindle|Android|Silk|lge |maemo|midp|mmp|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows (ce|phone)|xda|xiino/i.test(navigator.userAgent)&&!/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(navigator.userAgent.substr(0,4))),ATON.device.xrSupported={},ATON.device.xrSupported["immersive-vr"]=!1,ATON.device.xrSupported["immersive-ar"]=!1,"xr"in navigator&&(navigator.xr.isSessionSupported("immersive-vr").then((e=>{ATON.device.xrSupported["immersive-vr"]=!!e,console.log("WebXR VR session support: "+ATON.device.xrSupported["immersive-vr"]),ATON.fireEvent("XR_support",{type:"immersive-vr",v:ATON.device.xrSupported["immersive-vr"]})})),navigator.xr.isSessionSupported("immersive-ar").then((e=>{ATON.device.xrSupported["immersive-ar"]=!!e,console.log("WebXR AR session support: "+ATON.device.xrSupported["immersive-ar"]),ATON.fireEvent("XR_support",{type:"immersive-ar",v:ATON.device.xrSupported["immersive-ar"]})})))},profileRenderingCapabilities:()=>{if(void 0===ATON._renderer)return;let e=ATON._renderer.capabilities;void 0!==e&&(ATON.device.lowGPU=!1,e.isWebGL2||(ATON.device.lowGPU=!0),e.maxTextureSize<8192&&(ATON.device.lowGPU=!0),console.log(e))},isMobile:()=>ATON.device.isMobile,isVRsupported:()=>ATON.device.xrSupported["immersive-vr"],isARsupported:()=>ATON.device.xrSupported["immersive-ar"],getFileExtension:e=>e.substr(e.lastIndexOf(".")+1).toLowerCase(),removeFileExtension:e=>e.replace(/\.[^/.]+$/,""),isVideo:e=>{let t=s.getFileExtension(e);return"mp4"===t||"webm"===t||void 0},getBaseFolder:e=>{var t=e.lastIndexOf("/");return-1!==t?e.substring(0,t+1):""},getFilename:e=>e.split(/(\\|\/)/g).pop(),isResourceURL:e=>!!e.startsWith("http://")||!!e.startsWith("https://"),URLify:e=>{if("string"!=typeof e)return e;const t=e.match(/(((ftp|https?):\/\/)[\-\w@:%_\+.~#?,&\/\/=]+)/g);return t&&t.forEach((function(t){e=e.replace(t,"<a target='_blank' href='"+t+"'><img class='atonSmallIcon' src='"+ATON.PATH_RES+"icons/link.png'></a>")})),e},resolveCollectionURL:e=>e?(ATON._collMod&&(e=ATON._collMod(e)),e.startsWith("http")?e:ATON.PATH_COLLECTION+e):"",tryLoadFromService:(e,t)=>{if(!t)return!1;if(e.startsWith("https://cesium.com/ion/assets/")){let o=e.split("/"),i=o[o.length-1];return t.loadCesiumIONAsset(i),!0}if(e.startsWith("https://sketchfab.com/3d-models/")){let o=e.split("-"),i=o[o.length-1];return t.loadSketchfabAsset(i),!0}return!1},postJSON:(e,t,o,i)=>{$.ajax({url:e,type:"POST",xhrFields:{withCredentials:!0},data:JSON.stringify(t),contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{o&&o(e)}}).fail((e=>{console.log(e),i&&i()}))},runAsync:e=>{const t=new Worker(URL.createObjectURL(new Blob([`postMessage((${e})());`]),{type:"application/javascript; charset=utf-8"}));return new Promise(((e,o)=>{t.onmessage=({data:o})=>{e(o),t.terminate()},t.onerror=e=>{o(e),t.terminate()}}))},mergeObject:e=>{e.updateMatrixWorld(!0);const t=[];e.traverse((e=>{if(e.isMesh){const o=e.geometry;o.applyMatrix4(e.matrixWorld),t.push(o.toNonIndexed())}}));const o=THREE.BufferGeometryUtils.mergeBufferGeometries(t,!1),i=THREE.BufferGeometryUtils.mergeVertices(o).center(),r=new THREE.Group,n=new THREE.Mesh(i);return r.add(n),r},setPicking:(e,t,o)=>{void 0===o&&(o=!0),e.traverse((e=>{o?e.layers.enable(t):e.layers.disable(t)}))},graphPostVisitor:e=>{e.visible?console.log(e):s.setPicking(e,e.type,!1)},rotationBetweenDirections:(e,t)=>{const o=new THREE.Quaternion,i=(new THREE.Vector3).crossVectors(e,t);return o.x=i.x,o.y=i.y,o.z=i.z,o.w=1+e.clone().dot(t),o.normalize(),o},modelVisitor:(e,t)=>{if(void 0===t)return;if(void 0===e)return;let o=e.type;t.traverse((t=>{t.isMesh&&(o===ATON.NTYPES.SCENE&&(t.castShadow=!0,t.receiveShadow=!0,t.geometry&&(t.geometry.computeBoundsTree(),console.log("Computed visible BVH"),s._bvhBounds>0&&s._addBVHbounds(t,s._bvhBounds)),s.processMaterial(t.material)),o===ATON.NTYPES.SEM&&(t.material=ATON.MatHub.materials.semanticShape,t.geometry&&(t.geometry.computeBoundsTree(),console.log("Computed semantic BVH"))),e.userData.cMat&&(t.material=e.userData.cMat))}))},processMaterial:e=>{void 0!==e&&null!==e.map&&void 0!==e.map&&(e.map.generateMipmaps=!0,e.map.anisotropy=ATON.device.isMobile?0:ATON._maxAnisotropy,e.map.minFilter=THREE.LinearMipmapLinearFilter,e.map.magFilter=THREE.LinearFilter,e.map.encoding=ATON._stdEncoding)},cleanupVisitor:e=>{e.traverse((e=>{if(e.material)if(e.material.length)for(let t=0;t<e.material.length;++t)e.material[t].map&&e.material[t].map.dispose(),e.material[t].envMap&&e.material[t].envMap.dispose(),e.material[t].alphaMap&&e.material[t].alphaMap.dispose(),e.material[t].emissiveMap&&e.material[t].emissiveMap.dispose(),e.material[t].lightMap&&e.material[t].lightMap.dispose(),e.material[t].dispose();else e.material.map&&e.material.map.dispose(),e.material.envMap&&e.material.envMap.dispose(),e.material.alphaMap&&e.material.alphaMap.dispose(),e.material.emissiveMap&&e.material.emissiveMap.dispose(),e.material.lightMap&&e.material.lightMap.dispose(),e.material.dispose();e.userData&&e.userData.cMat&&e.userData.cMat.dispose(),e.geometry&&(e.geometry.disposeBoundsTree(),e.geometry.dispose())})),e=null},registerAniMixers:(e,t)=>{let o=t.scene||t.scene[0],i=!1;if(void 0===t.animations)return;let r=new THREE.AnimationMixer(o);t.animations.forEach((e=>{r.clipAction(e).play(),i=!0})),i&&(ATON._aniMixers.push(r),void 0===e._aniMixers&&(e._aniMixers=[]),e._aniMixers.push(r))},parseTransformString:e=>{let t=new THREE.Group,o=e.split(s.TSTRING_SEPARATOR),i=o.length;return i<3||(t.position.set(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2])),i<6||(t.rotation.set(parseFloat(o[3]),parseFloat(o[4]),parseFloat(o[5])),i<9||t.scale.set(parseFloat(o[6]),parseFloat(o[7]),parseFloat(o[8])))),t},setVectorPrecision:(e,t)=>(e.x=parseFloat(e.x.toPrecision(t)),e.y=parseFloat(e.y.toPrecision(t)),e.z=parseFloat(e.z.toPrecision(t)),e),parseMD:e=>(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.replace(/^\s*\n\*/gm,"<ul>\n*")).replace(/^(\*.+)\s*\n([^\*])/gm,"$1\n</ul>\n\n$2")).replace(/^\*(.+)/gm,"<li>$1</li>")).replace(/^\s*\n\d\./gm,"<ol>\n1.")).replace(/^(\d\..+)\s*\n([^\d\.])/gm,"$1\n</ol>\n\n$2")).replace(/^\d\.(.+)/gm,"<li>$1</li>")).replace(/^\>(.+)/gm,"<blockquote>$1</blockquote>")).replace(/[\#]{6}(.+)/g,"<h6>$1</h6>")).replace(/[\#]{5}(.+)/g,"<h5>$1</h5>")).replace(/[\#]{4}(.+)/g,"<h4>$1</h4>")).replace(/[\#]{3}(.+)/g,"<h3>$1</h3>")).replace(/[\#]{2}(.+)/g,"<h2>$1</h2>")).replace(/[\#]{1}(.+)/g,"<h1>$1</h1>")).replace(/^(.+)\n\=+/gm,"<h1>$1</h1>")).replace(/^(.+)\n\-+/gm,"<h2>$1</h2>")).replace(/\!\[([^\]]+)\]\(([^\)]+)\)/g,'<img src="$2" alt="$1" />')).replace(/[\[]{1}([^\]]+)[\]]{1}[\(]{1}([^\)\"]+)(\"(.+)\")?[\)]{1}/g,'<a href="$2" title="$4">$1</a>')).replace(/[\*\_]{2}([^\*\_]+)[\*\_]{2}/g,"<b>$1</b>")).replace(/[\*\_]{1}([^\*\_]+)[\*\_]{1}/g,"<i>$1</i>")).replace(/[\~]{2}([^\~]+)[\~]{2}/g,"<del>$1</del>")).replace(/^\s*\n\`\`\`(([^\s]+))?/gm,'<pre class="$2">')).replace(/^\`\`\`\s*\n/gm,"</pre>\n\n")).replace(/[\`]{1}([^\`]+)[\`]{1}/g,"<code>$1</code>")).replace(/^\s*(\n)?(.+)/gm,(function(e){return/\<(\/)?(h\d|ul|ol|li|blockquote|pre|img)/.test(e)?e:"<p>"+e+"</p>"}))).replace(/(\<pre.+\>)\s*\n\<p\>(.+)\<\/p\>/gm,"$1$2"),checkAuth:e=>{$.ajax({type:"GET",url:ATON.PATH_RESTAPI+"user",xhrFields:{withCredentials:!0},dataType:"json",success:t=>{e(t)}})},getHumanReadableDistance:e=>{let t=" m";return e<.01?(t=" mm",t=(e*=1e3).toPrecision(3)+t,t):e<1?(t=" cm",t=(e*=100).toPrecision(3)+t,t):e>1e3?(t=" km",t=e.toPrecision(3)+t,t):(t=e.toPrecision(3)+t,t)},stripHTMLtagsFromString:e=>e.replace(/(<([^>]+)>)/gi,""),requestFullscreen:()=>{let e=document.documentElement;return e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.msRequestFullscreen&&e.msRequestFullscreen(),!0},downloadBlob:(e,t)=>{void 0!==t&&(s._dlink.href=URL.createObjectURL(e),s._dlink.download=t,s._dlink.click())},downloadText:(e,t)=>{s.downloadBlob(new Blob([e],{type:"text/plain"}),t)},downloadJSONobj:(e,t)=>{s.downloadText(JSON.stringify(e),t)},downloadArrayBuffer:(e,t)=>{s.downloadBlob(new Blob([e],{type:"application/octet-stream"}),t)},exportNode:(e,t)=>{let o=s.getFileExtension(t);if(!(o.length<1)){if("glb"===o||"gltf"===o){let i={binary:"glb"===o};void 0===s.exporterGLTF&&(s.exporterGLTF=new THREE.GLTFExporter),s.exporterGLTF.parse(e,(e=>{e instanceof ArrayBuffer?s.downloadArrayBuffer(e,t):(console.log(e),s.downloadJSONobj(e,t))}),i)}if("obj"===o){void 0===s.exporterOBJ&&(s.exporterOBJ=new THREE.OBJExporter);let o=s.exporterOBJ.parse(e);s.downloadText(o,t)}"usdz"===o&&(void 0===s.exporterUSDZ&&(s.exporterUSDZ=new THREE.USDZExporter),$("#idLoader").show(),s.exporterUSDZ.parse(e).then((e=>{s.downloadArrayBuffer(e,t),$("#idLoader").hide()})))}},takeScreenshot:(e,t)=>{let o=new Image;console.log("Screenshot with size:"+e),ATON.Nav._camera.aspect=1,ATON.Nav._camera.updateProjectionMatrix(),ATON._renderer.setSize(e,e),ATON._renderer.render(ATON._mainRoot,ATON.Nav._camera);let i=ATON._renderer.domElement;if(ATON.FX.composer){if(ATON.FX.composer.setSize(e,e),ATON.FX.passes[ATON.FX.PASS_AA]){let t=ATON.FX.passes[ATON.FX.PASS_AA].material.uniforms;t&&t.resolution.value.set(1/e,1/e)}ATON.FX.composer.render(),i=ATON.FX.composer.renderer.domElement}let r=ATON._renderer.domElement.toDataURL();return o.src=r,t&&(s._dlink.href=r.replace("image/png","image/octet-stream"),s._dlink.download=t,s._dlink.click()),ATON._onResize(),o},assignLightProbeToMesh:(e,t)=>{void 0!==e&&void 0!==t&&(t.noLP||(t.userData.LP=e))},clearLightProbeFromMesh:e=>{void 0!==e&&(e.noLP||(e.userData.LP=null))},vibrate:e=>{void 0===e&&(e=100),window.navigator.vibrate(e)},createATONCube:e=>{let t=new THREE.BoxBufferGeometry(1,1,1),o=new THREE.MeshStandardMaterial;s.textureLoader.load(ATON.PATH_RES+"models/aton-cube.jpg",(e=>{e.encoding=ATON._stdEncoding,o.map=e}));let i=ATON.createSceneNode(e);return i.add(new THREE.Mesh(t)),i.setMaterial(o),i.enablePicking(),i},createATONCubePBR:e=>{let t=new THREE.BoxBufferGeometry(1,1,1),o=new THREE.MeshStandardMaterial;o.metalness=1,s.textureLoader.load(ATON.PATH_RES+"models/aton-cube.jpg",(e=>{e.encoding=ATON._stdEncoding,o.map=e})),s.textureLoader.load(ATON.PATH_RES+"models/aton-cube-pbr.jpg",(e=>{e.encoding=ATON._stdEncoding,o.metalnessMap=e,o.roughnessMap=e})),s.textureLoader.load(ATON.PATH_RES+"models/aton-cube-nrm.png",(e=>{e.encoding=ATON._stdEncoding,o.normalMap=e}));let i=ATON.createSceneNode(e);return i.add(new THREE.Mesh(t)),i.setMaterial(o),i.enablePicking(),i},createGround:(e,t,o)=>{void 0===t&&(t=1),void 0===o&&(o=1);let i=new THREE.PlaneBufferGeometry(t,o),r=new THREE.MeshStandardMaterial;void 0!==e&&s.textureLoader.load(e,(e=>{e.encoding=ATON._stdEncoding,r.map=e}));let n=ATON.createSceneNode().rotateX(.5*-Math.PI);return n.add(new THREE.Mesh(i,r)),n.enablePicking(),n}};const a=s;let d={MODE_ADD:0,MODE_DEL:1,FLOAT_PREC:5,init:()=>{d.currID=void 0,d.currData=void 0,d._bEdit=!1,d._bLoading=!1,d._title=void 0,d._descr=void 0,d.initBaseParsers()},setEditMode:e=>{d._bEdit=e,console.log("Edit mode:"+e)},load:(e,t,o)=>(d._bLoading=!0,console.log("Loading Scene: "+t),$.getJSON(e,(e=>{d.currData=e,d.currID=t,d._bLoading=!1,d.parseScene(e),o&&o(),ATON.fireEvent("SceneJSONLoaded",t)}))),clearScene:()=>{if(!(ATON._rootVisible.children.length<=0)){ATON._rootVisible.removeChildren();for(let e in ATON.snodes)e!==ATON.ROOT_NID&&delete ATON.snodes[e];ATON.MRes.clear(),ATON.XPFNetwork.clear()}},clearSemantics:()=>{if(!(ATON._rootSem.children.length<=0)){ATON._rootSem.removeChildren();for(let e in ATON.semnodes)e!==ATON.ROOT_NID&&delete ATON.semnodes[e];ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.removeChildren()}},clear:()=>{d.clearScene(),d.clearSemantics(),ATON.Nav.clear()},parseScene:e=>{if(void 0!==(e=void 0===e?d.currData:e))for(let t in e)d._jsonParsers[t]&&d._jsonParsers[t](e[t])},getJSONchildren:(e,t)=>{let o;void 0===t&&(t=ATON.NTYPES.SCENE);let i=[];if(t===ATON.NTYPES.SEM&&(o=ATON.getSemanticNode(e)),t===ATON.NTYPES.SCENE&&(o=ATON.getSceneNode(e)),void 0!==o){for(let e in o.children){let t=o.children[e];void 0!==t.nid&&i.push(t.nid)}return i}},getJSONgraphEdges:e=>{void 0===e&&(e=ATON.NTYPES.SCENE);let t=ATON.snodes;e===ATON.NTYPES.SEM&&(t=ATON.semnodes),e===ATON.NTYPES.UI&&(t=ATON.uinodes);let o={};for(let e in t){let i=t[e];i&&i.parent&&i.parent.nid&&(void 0===o[i.parent.nid]&&(o[i.parent.nid]=[]),o[i.parent.nid].push(i.nid))}return o},getJSONsemanticSpheresList:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=[];for(let e in t.children){let i=t.children[e];i.type&&o.push([parseFloat(i.position.x.toPrecision(d.FLOAT_PREC)),parseFloat(i.position.y.toPrecision(d.FLOAT_PREC)),parseFloat(i.position.z.toPrecision(d.FLOAT_PREC)),parseFloat(i.scale.x.toPrecision(d.FLOAT_PREC))])}return o},getJSONsemanticConvexShapes:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=[];for(let e in t.children){let i=t.children[e];i.userData._convexPoints&&o.push(i.userData._convexPoints)}return o},_applyJSONTransformToNode:(e,t)=>{if(void 0!==e&&void 0!==t){if(e.bUseGeoCoords)return t.bUseGeoCoords=!0,void(e.scale&&t.setScale(e.scale[0],e.scale[1],e.scale[2]));e.autocenter?t.autocenter=!0:e.position&&t.setPosition(e.position[0],e.position[1],e.position[2]),e.rotation&&t.setRotation(e.rotation[0],e.rotation[1],e.rotation[2]),e.scale&&t.setScale(e.scale[0],e.scale[1],e.scale[2]),e.list&&Array.isArray(e.list)}},initBaseParsers:()=>{d._jsonParsers={},d._jsonParsers.title=e=>{void 0!==e&&d.setTitle(e)},d._jsonParsers.description=e=>{void 0!==e&&d.setDescription(e)},d._jsonParsers.fx=e=>{e.ao&&(ATON.FX.togglePass(ATON.FX.PASS_AO,!0),e.ao.i&&ATON.FX.setAOintensity(parseFloat(e.ao.i))),e.bloom&&(ATON.FX.togglePass(ATON.FX.PASS_BLOOM,!0),e.bloom.i&&ATON.FX.setBloomStrength(parseFloat(e.bloom.i)),e.bloom.t&&ATON.FX.setBloomThreshold(parseFloat(e.bloom.t))),e.dof&&(ATON.FX.togglePass(ATON.FX.PASS_DOF,!0),e.dof.f&&ATON.FX.setDOFfocus(parseFloat(e.dof.f)))},d._jsonParsers.environment=e=>{let t=e.mainpano;if(e.mainpano&&(t.url&&ATON.setMainPanorama(t.url),t.rotation&&ATON.setMainPanoramaRotation(t.rotation)),e.bgcolor){let t=new THREE.Color(e.bgcolor[0],e.bgcolor[1],e.bgcolor[2]);ATON.setBackgroundColor(t)}let o=e.mainlight;o?(o.direction&&ATON.setMainLightDirection(new THREE.Vector3(o.direction[0],o.direction[1],o.direction[2])),ATON._dMainL?(o.color&&(ATON._dMainL.color=new THREE.Color(o.color[0],o.color[1],o.color[2])),o.intensity&&(ATON._dMainL.intensity=o.intensity),void 0!==o.shadows?ATON.toggleShadows(o.shadows):ATON.toggleShadows(!1)):ATON.toggleMainLight(!1)):ATON.toggleMainLight(!1);let i=e.lightprobes;if(i&&(void 0!==i.auto&&ATON.setAutoLP(i.auto),i.list))for(let e in i.list){let t=i.list[e],o=new ATON.LightProbe;t.pos&&o.setPosition(parseFloat(t.pos[0]),parseFloat(t.pos[1]),parseFloat(t.pos[2])),t.near&&o.setNear(parseFloat(t.near)),t.far&&o.setFar(parseFloat(t.far)),ATON.addLightProbe(o),console.log(o)}e.exposure&&ATON.setExposure(e.exposure)},d._jsonParsers.soundscape=e=>{void 0!==e&&e.global&&ATON.setGlobalAudio(e.global.url,e.global.loop)},d._jsonParsers.navmode=e=>{void 0!==e&&ATON.Nav.setNavMode(e)},d._jsonParsers.locomotionGraph=e=>{if(void 0!==e){for(let t in e){let o=e[t];o.pos&&ATON.Nav.addLocomotionNode(parseFloat(o.pos[0]),parseFloat(o.pos[1]),parseFloat(o.pos[2]),!0)}ATON.Nav.setFirstPersonControl(),ATON.Nav.toggleLocomotionValidator(!1)}},d._jsonParsers.measurements=e=>{if(void 0!==e)for(let t in e){let o=e[t];if(o.points&&6===o.points.length){let e=new THREE.Vector3(parseFloat(o.points[0]),parseFloat(o.points[1]),parseFloat(o.points[2])),t=new THREE.Vector3(parseFloat(o.points[3]),parseFloat(o.points[4]),parseFloat(o.points[5]));ATON.SUI.addMeasurementPoint(e),ATON.SUI.addMeasurementPoint(t)}}},d._jsonParsers.viewpoints=e=>{if(void 0!==e)for(let t in e){let o=e[t];"home"===t?ATON.Nav.setHomePOV((new ATON.POV).setPosition(o.position[0],o.position[1],o.position[2]).setTarget(o.target[0],o.target[1],o.target[2]).setFOV(o.fov)):new ATON.POV(t).setPosition(o.position[0],o.position[1],o.position[2]).setTarget(o.target[0],o.target[1],o.target[2]).setFOV(o.fov)}},d._jsonParsers.scenegraph=e=>{if(void 0===e)return;let t=e.nodes,o=e.edges;for(let e in t){let o=t[e],i=ATON.getOrCreateSceneNode(e).removeChildren();d._applyJSONTransformToNode(o.transform,i);let r=o.urls;if(r&&(Array.isArray(r)?r.forEach((e=>{i.load(e)})):i.load(r)),o["cesium.ion"]){let e=o["cesium.ion"];ATON.MRes.loadCesiumIONAsset(e,i)}o.shadowcast&&i.setShadowCast(o.shadowcast),o.shadowreceive&&i.setShadowCast(o.shadowreceive),o.toYup&&i.setYup(),o.keywords&&(i.kwords=o.keywords)}for(let e in o){let t=o[e],i=ATON.getSceneNode(e);if(void 0!==i)for(let e in t){let o=t[e],r=ATON.getSceneNode(o);void 0!==r&&r.attachTo(i)}}for(let e in t){let o=t[e],i=ATON.getSceneNode(e);if(void 0!==i&&(void 0!==o.show&&(o.show?(i.show(),console.log("show "+e)):(i.hide(),console.log("hide "+e))),o.material)){let e;e="string"==typeof o.material?ATON.MatHub.materials[o.material]:new THREE.MeshStandardMaterial(o.material),e&&i.setMaterial(e)}}},d._jsonParsers.semanticgraph=e=>{if(void 0===e)return;let t=e.nodes,o=e.edges;for(let e in t){let o=t[e],i=ATON.getOrCreateSemanticNode(e).removeChildren(),r=o.urls;r&&(Array.isArray(r)?r.forEach((e=>{i.load(e)})):i.load(r)),o.toYup&&i.setYup(),o.description&&i.setDescription(o.description),o.audio&&i.setAudio(o.audio),o.keywords&&(i.kwords=o.keywords);let n=o.spheres;if(Array.isArray(n))for(let t in n){let o=n[t],i=new THREE.Vector3(parseFloat(o[0]),parseFloat(o[1]),parseFloat(o[2]));ATON.SemFactory.createSphere(e,i,parseFloat(o[3]))}let s=o.convexshapes;if(Array.isArray(s))for(let t in s){let o=s[t],i=[];for(let e=0;e<o.length;e+=3){let t=new THREE.Vector3(o[e],o[e+1],o[e+2]);i.push(t)}ATON.SemFactory.createConvexShape(e,i)}}for(let e in o){let t=o[e],i=ATON.getSemanticNode(e);if(void 0!==i)for(let e in t){let o=t[e],r=ATON.getSemanticNode(o);void 0!==r&&r.attachTo(i)}}for(let e in t){let o=t[e],i=ATON.getSemanticNode(e);if(void 0!==i&&(void 0!==o.show&&(o.show?(i.show(),console.log("show "+e)):(i.hide(),console.log("hide "+e))),o.nopicking&&i.disablePicking(),o.material)){let e=new THREE.MeshStandardMaterial(o.material);i.setMaterial(e)}}},d._jsonParsers.xpfnet=e=>{if(ATON.Nav.setFirstPersonControl(),e.list){let t=e.list,o=t.length;for(let e=0;e<o;e++){let o=t[e],i=new ATON.XPF;i.realizeSUI(),o.location&&i.setLocation(o.location[0],o.location[1],o.location[2]),o.rotation&&i.setRotation(o.rotation[0],o.rotation[1],o.rotation[2]),o.baselayer&&i.setBaseLayer(o.baselayer),ATON.XPFNetwork.add(i)}}e.photoscanOPKfile&&XPFNetwork.loadFromPhotoscanFile(e.photoscanOPKfile,(()=>{ATON.XPFNetwork.setHomeXPF(0),ATON.XPFNetwork.requestTransitionByIndex(0,0)}))}},addSceneParser:(e,t)=>{d._jsonParsers[e]=t},sendEdit:(e,t,o)=>{if(d._bLoading||!d._bEdit)return;if(void 0===e)return;void 0===t&&(t=d.MODE_ADD);let i=d.currID,r={};r.sid=i,r.data=e,r.mode=t===d.MODE_DEL?"DEL":"ADD";let n=JSON.stringify(r);e=null,r=null,$.ajax({url:ATON.PATH_RESTAPI+"edit/scene",type:"POST",data:n,contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{e&&(d.currData=e),o&&o()}})},currSceneHasHomeConfig:()=>void 0!==d.currData&&void 0!==d.currData.viewpoints&&void 0!==d.currData.viewpoints.home,setTitle:e=>{d._title=e},getTitle:()=>d._title,setDescription:e=>{d._descr=e},getDescription:()=>d._descr};const l=d;let c={init:()=>{c._listener=new THREE.AudioListener,c._loader=new THREE.AudioLoader,c._bGenAuPlaying=!1},playOnceGlobally:(e,t)=>{if(t&&c._bGenAuPlaying)return;e=ATON.Utils.resolveCollectionURL(e);let o=new THREE.Audio(ATON.AudioHub._listener);return c._loader.load(e,(e=>{o.setBuffer(e),o.play(),t&&(c._bGenAuPlaying=!0)})),t&&(o.onEnded=()=>{c._bGenAuPlaying=!1}),o}};const u=c;class _ extends THREE.EventDispatcher{constructor(e){super(),!1===window.isSecureContext&&console.error("DeviceOrientationEvent is only available in secure contexts (https)"),this._zee=new THREE.Vector3(0,0,1),this._euler=new THREE.Euler,this._q0=new THREE.Quaternion,this._q1=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5)),this._changeEvent={type:"change"};const t=this,o=new THREE.Quaternion;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0;const i=function(e){t.deviceOrientation=e},r=function(){t.screenOrientation=window.orientation||0};this.connect=function(){r(),void 0!==window.DeviceOrientationEvent&&"function"==typeof window.DeviceOrientationEvent.requestPermission?window.DeviceOrientationEvent.requestPermission().then((function(e){"granted"==e&&(window.addEventListener("orientationchange",r),window.addEventListener("deviceorientation",i))})).catch((function(e){console.error("Unable to use DeviceOrientation API:",e)})):(window.addEventListener("orientationchange",r),window.addEventListener("deviceorientation",i)),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r),window.removeEventListener("deviceorientation",i),t.enabled=!1},this.update=function(){if(!1===t.enabled)return;const e=t.deviceOrientation;if(e){const i=e.alpha?THREE.MathUtils.degToRad(e.alpha)+t.alphaOffset:0,r=e.beta?THREE.MathUtils.degToRad(e.beta):0,n=e.gamma?THREE.MathUtils.degToRad(e.gamma):0,s=t.screenOrientation?THREE.MathUtils.degToRad(t.screenOrientation):0;!function(e,o,i,r,n){t._euler.set(i,o,-r,"YXZ"),e.setFromEuler(t._euler),e.multiply(t._q1),e.multiply(t._q0.setFromAxisAngle(t._zee,-n))}(t.object.quaternion,i,r,n,s),8*(1-o.dot(t.object.quaternion))>1e-6&&(o.copy(t.object.quaternion),t.dispatchEvent(t._changeEvent))}},this.dispose=function(){t.disconnect()},this.connect()}}const p=_;let h={STD_FOV:50,STD_NEAR:.01,STD_FAR:800,FP_EPS:.01,STD_POV_TRANS_DURATION:2,STD_LOCNODE_SIZE:.5,MIN_LOC_VALID_DIST:1.5,MODE_ORBIT:0,MODE_FP:1,MODE_DEVORI:2,LocomotionNode:class{constructor(e){this.pos=new THREE.Vector3(0,0,0),this.id=e,this._iXPF=void 0,this._sui=void 0}setLocation(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this._sui&&this._sui.position.copy(this.pos),this}getLocation(){return this.pos}realizeSUI(e){return void 0===ATON.SUI.gLocNodes||(this._sui=new THREE.Sprite(ATON.SUI.getOrCreateSpriteWalk()),this._sui.position.copy(this.pos),this._sui.scale.set(ATON.Nav.STD_LOCNODE_SIZE,ATON.Nav.STD_LOCNODE_SIZE,ATON.Nav.STD_LOCNODE_SIZE),ATON.SUI.gLocNodes.add(this._sui)),this}toggleSUI(e){return void 0===this._sui||(this._sui.visible=e),this}},init:()=>{h._mode=void 0,h.POVtransitionDuration=h.STD_POV_TRANS_DURATION,h._rotSpeedOrbit=.4,h._rotSpeedFP=-.2,h._inertia=.08,h._bControl=!0,h._bLocValidator=!0,h._bInteracting=!1,h._prevMode=void 0,h.setOrbitControl(),h._currPOV=(new ATON.POV).setPosition(0,0,0).setTarget(1,0,0).setFOV(ATON.Nav.STD_FOV),h._fromPOV=new ATON.POV,h._reqPOV=new ATON.POV,h.homePOV=void 0,h._tPOVcall=-1,h._tPOVprogress=0,h.povlist={},h._vDir=new THREE.Vector3(1,0,0),h._qOri=new THREE.Quaternion,h._lastPos=new THREE.Vector3(0,0,0),h._lastOri=new THREE.Quaternion,h._dOri=0,h._dPos=0,h._motionAmt=0,h._motionDir=new THREE.Vector3(0,1,0),h._bValidLocomotion=!1,h._locNodes=[],h._prevLN=void 0},getCurrentEyeLocation:()=>h._currPOV.pos,getCurrentDirection:()=>h._vDir,copyCurrentPOV:()=>{let e=new ATON.POV;return e.pos.copy(h._currPOV.pos),e.target.copy(h._currPOV.target),e.fov=h._currPOV.fov,e},addPOV:(e,t)=>{if(void 0!==e)return e.as(t),e},clearPOVs:()=>{for(let e in ATON.Nav.povlist)delete h.povlist[e]},isTransitioning:()=>h._tPOVcall>=0,currentQueryValidForLocomotion:()=>h._bValidLocomotion,locomotionValidator:()=>{if(void 0===ATON._queryDataScene)return void(h._bValidLocomotion=!1);let e=ATON._queryDataScene,t=(e.p,e.n);e.d<=h.MIN_LOC_VALID_DIST?h._bValidLocomotion=!1:t?t.y<=.7?h._bValidLocomotion=!1:h._bValidLocomotion=!0:h._bValidLocomotion=!1},toggleLocomotionValidator:e=>{e?h._bLocValidator=!0:(h._bLocValidator=!1,h._bValidLocomotion=!1)},addLocomotionNode:(e,t,o,i)=>{let r=(new h.LocomotionNode).setLocation(e,t,o);return i&&r.realizeSUI(),h._locNodes.push(r),ATON.fireEvent("LocomotionNodeAdded",r),r},getLocomotionNodeByIndex:e=>h._locNodes[e],clearLocomotionNodes:()=>{h._locNodes=[],h._prevLN=void 0,ATON.SUI.gLocNodes&&ATON.SUI.gLocNodes.removeChildren()},getLocomotionNodeInSight:()=>{let e=h._locNodes.length;if(e<=0)return;if(h.isTransitioning())return;let t,o,i=h._currPOV.pos,r=h._vDir;void 0===h._dirLNode&&(h._dirLNode=new THREE.Vector3);for(let n=0;n<e;n++)if(h._posLNode=h._locNodes[n].pos,h._dirLNode.x=h._posLNode.x-i.x,h._dirLNode.y=h._posLNode.y-i.y,h._dirLNode.z=h._posLNode.z-i.z,h._dirLNode=h._dirLNode.normalize(),h._dirLNode.dot(r)>.8){let e=i.distanceToSquared(h._posLNode);e>.3&&(void 0===o||e<o)&&(o=e,t=n)}return t},requestTransitionToLocomotionNode:(e,t)=>{if(void 0===e)return;if(h._mode===h.MODE_ORBIT)return;let o=ATON.Nav._vDir,i=(new ATON.POV).setPosition(e.pos).setTarget(e.pos.x+o.x,e.pos.y+o.y,e.pos.z+o.z).setFOV(h._currPOV.fov);e.toggleSUI(!1),void 0!==h._prevLN&&h._prevLN.toggleSUI(!0),h.requestPOV(i,t),h._prevLN=e,ATON.fireEvent("LocomotionNodeRequested",e)},requestTransitionToLocomotionNodeInSightIfAny:e=>{let t=ATON.XPFNetwork.getNextXPFindex();if(void 0!==t)return h.requestTransitionToLocomotionNode(ATON.XPFNetwork._list[t]._lnode,e),!0;let o=ATON.Nav.getLocomotionNodeInSight();if(void 0===o)return!1;let i=h._locNodes[o];return h.requestTransitionToLocomotionNode(i,e),!0},requestDeltaRotation:(e,t,o)=>{if(ATON.XR._bPresenting)return;let i=new THREE.Vector3,r=new THREE.Vector3;i.crossVectors(h._vDir,THREE.Object3D.DefaultUp),r.x=h._currPOV.target.x+i.x*e,r.y=h._currPOV.target.y+t,r.z=h._currPOV.target.z+i.z*e;let n=new ATON.POV;n.setTarget(r),n.setPosition(ATON.Nav._currPOV.pos),ATON.Nav.requestPOV(n,o)},setUserControl:e=>{void 0!==e&&e!==h._bControl&&(h._bControl=e,void 0!==h._controls&&(h._controls.enabled=e),h._cOrbit&&(h._cOrbit.enabled=e),h._cFirstPerson&&(h._cFirstPerson.enabled=e),console.log("Nav controls: "+h._bControl))},toggleUserControl:()=>{h.setUserControl(!h._bControl)},isUserControlEnabled:()=>h._bControl,isOrbit:()=>!ATON.XR._bPresenting&&h._mode===h.MODE_ORBIT,isFirstPerson:()=>!ATON.XR._bPresenting&&h._mode===h.MODE_FP,isDevOri:()=>!ATON.XR._bPresenting&&h._mode===h.MODE_DEVORI,setNavMode:e=>{void 0!==e&&(e===h.MODE_ORBIT&&h.setOrbitControl(),e===h.MODE_FP&&h.setFirstPersonControl(),e===h.MODE_DEVORI&&h.setDeviceOrientationControl())},restorePreviousNavMode:()=>{void 0===h._prevMode&&h.setOrbitControl(),h.setNavMode(h._prevMode)},_updCamera:e=>{if(void 0===e&&(e=h._camera),ATON.FX.composer){let t=ATON.FX.composer.passes;if(t)for(let o=0;o<t.length;o++)t[o].camera&&(t[o].camera=e)}h._currPOV&&(e.fov=h._currPOV.fov,e.updateProjectionMatrix()),ATON._setupGizmo(),ATON.MRes.updateTSetsCamera(e)},setOrbitControl:()=>{if(!ATON.XR.isPresenting()){if(h._prevMode=h._mode,h._mode=h.MODE_ORBIT,h._bInteracting=!1,void 0===h._cOrbit){h._camOrbit=new THREE.PerspectiveCamera(h.STD_FOV,window.innerWidth/window.innerHeight,h.STD_NEAR,h.STD_FAR),h._camOrbit.layers.enableAll(),h._cOrbit=new THREE.OrbitControls(h._camOrbit,ATON._renderer.domElement);let e=h._cOrbit;e.rotateSpeed=h._rotSpeedOrbit,e.enablePan=!0,h._inertia>0&&(e.enableDamping=!0,e.dampingFactor=h._inertia),e.screenSpacePanning=!0,e.enableZoom=!0,e.minDistance=.03,e.maxDistance=100,h._bControl||(e.enabled=!1),e.addEventListener("start",(()=>{h._bInteracting=!0})),e.addEventListener("end",(()=>{h._bInteracting=!1}))}h._controls=h._cOrbit,h._camera=h._camOrbit,ATON.AudioHub._listener&&h._camera.children.length<1&&h._camera.add(ATON.AudioHub._listener),h._updCamera(),h._controls.update(),h._currPOV&&h.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!1),ATON.fireEvent("NavMode",h._mode)}},setFirstPersonControl:()=>{if(!ATON.XR.isPresenting()){if(h._prevMode=h._mode,ATON.SUI.getSelectorRadius()>.1&&ATON.SUI.setSelectorRadius(.1),h._mode=h.MODE_FP,h._bInteracting=!1,void 0===h._cFirstPerson){h._camFP=new THREE.PerspectiveCamera(h.STD_FOV,window.innerWidth/window.innerHeight,h.STD_NEAR,h.STD_FAR),h._camFP.layers.enableAll(),h._cFirstPerson=new THREE.OrbitControls(h._camFP,ATON._renderer.domElement);let e=h._cFirstPerson;e.enableZoom=!1,e.enablePan=!1,e.rotateSpeed=h._rotSpeedFP,h._inertia>0&&(e.enableDamping=!0,e.dampingFactor=h._inertia),e.target.copy(h._camera.position),e.minDistance=.01,e.maxDistance=.01,h._bControl||(e.enabled=!1)}h._controls=h._cFirstPerson,h._camera=h._camFP,ATON.AudioHub._listener&&h._camera.children.length<1&&h._camera.add(ATON.AudioHub._listener),h._updCamera(),h._controls.update(),h._currPOV&&h.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!1),ATON.fireEvent("NavMode",h._mode)}},setDeviceOrientationControl:()=>{ATON.Utils.isMobile()&&(h._prevMode=h._mode,h._mode=h.MODE_DEVORI,h._bInteracting=!1,ATON._screenPointerCoords.set(0,0),void 0===h._cDevOri&&(h._camDevOri=new THREE.PerspectiveCamera(h.STD_FOV,window.innerWidth/window.innerHeight,h.STD_NEAR,h.STD_FAR),h._camDevOri.layers.enableAll(),h._cDevOri=new p(h._camDevOri,ATON._renderer.domElement),h._cDevOri.alphaOffset=0),h._controls=h._cDevOri,h._camera=h._camDevOri,ATON.AudioHub._listener&&h._camera.children.length<1&&h._camera.add(ATON.AudioHub._listener),h._updCamera(),h._controls.update(),h._currPOV&&h.syncCurrCamera(),ATON._onResize(),ATON.toggleCenteredQuery(!0),ATON.fireEvent("NavMode",h._mode))},useAbsoluteOrientation:e=>{h._cDevOri},setMotionAmount:e=>{h._motionAmt=e},setMotionDirection:e=>{h._motionDir.copy(e)},stop:()=>{h._motionAmt=0},setFOV:e=>{if(ATON.XR.isPresenting())return;h._currPOV.fov=e;let t=h._camera;t.fov=e,t.updateProjectionMatrix()},getFOV:()=>h._currPOV.fov,_deltaMotions:()=>{h._dOri=h._lastOri.angleTo(ATON.Nav._qOri),h._dPos=h._lastPos.distanceToSquared(h._currPOV.pos),h._lastPos.copy(h._currPOV.pos),h._lastOri.copy(ATON.Nav._qOri)},syncCurrPOV:()=>{if(ATON.XR.isPresenting())return ATON.XR._cam=ATON._renderer.xr.getCamera(h._camera),ATON.XR._cam.getWorldPosition(h._currPOV.pos),ATON.XR._cam.getWorldQuaternion(h._qOri),ATON.XR._cam.getWorldDirection(h._vDir),void h._deltaMotions();const e=h._controls,t=h._camera;if(t.getWorldDirection(h._vDir),t.getWorldQuaternion(h._qOri),h._deltaMotions(),h._mode!==h.MODE_DEVORI){if(h._mode===h.MODE_FP)return h._currPOV.pos.copy(e.target),h._currPOV.target.x=h._currPOV.pos.x+h._vDir.x,h._currPOV.target.y=h._currPOV.pos.y+h._vDir.y,void(h._currPOV.target.z=h._currPOV.pos.z+h._vDir.z);h._currPOV.pos.copy(t.position),h._currPOV.target.copy(e.target)}else h._currPOV.pos.copy(t.position)},handlePOV:()=>{ATON.XR.isPresenting()?h.handleXRtransition():h.handlePOVtransition()},handleMotion:()=>{if(!h.isTransitioning()&&0!=h._motionAmt){ATON.XR.controller0&&ATON.XR.controller0.visible?(ATON.XR.controller0.getWorldDirection(h._motionDir),h._motionDir.negate()):h._motionDir.copy(h._vDir);let e=h._motionDir.clone();e.multiplyScalar(h._motionAmt*ATON._dt),h._currPOV.pos.add(e),h._currPOV.target.add(e)}},handlePOVtransition:()=>{if(!(h._tPOVcall<0)){if(h.POVtransitionDuration<=0?h._tPOVprogress=1:h._tPOVprogress=(ATON._clock.elapsedTime-h._tPOVcall)/h.POVtransitionDuration,h._tPOVprogress>=1)return h._tPOVcall=-1,h._currPOV.pos.copy(h._reqPOV.pos),h._currPOV.target.copy(h._reqPOV.target),h._currPOV.fov=h._reqPOV.fov,void ATON.fireEvent("POVTransitionCompleted",h._reqPOV.id);var e;h._tPOVprogress=(e=h._tPOVprogress,(1-Math.cos(e*Math.PI))/2),h._currPOV.pos.lerpVectors(h._fromPOV.pos,h._reqPOV.pos,h._tPOVprogress),h._currPOV.target.lerpVectors(h._fromPOV.target,h._reqPOV.target,h._tPOVprogress),h._fromPOV.fov&&h._reqPOV.fov&&(h._currPOV.fov=THREE.MathUtils.lerp(h._fromPOV.fov,h._reqPOV.fov,h._tPOVprogress),h._camera.fov=h._currPOV.fov,h._camera.updateProjectionMatrix())}},handleXRtransition:()=>{if(!(h._tPOVcall<0)){if(h.POVtransitionDuration<=0?h._tPOVprogress=1:h._tPOVprogress=(ATON._clock.elapsedTime-h._tPOVcall)/h.POVtransitionDuration,h._tPOVprogress>=1)return h._tPOVcall=-1,ATON.XR._currPos.copy(ATON.XR._reqPos),void ATON.fireEvent("POVTransitionCompleted",h._reqPOV.id);ATON.XR._currPos.lerpVectors(ATON.XR._fromPos,ATON.XR._reqPos,h._tPOVprogress)}},syncCurrCamera:()=>{if(ATON.XR.isPresenting())return;let e=h._controls,t=h._camera,o=h._currPOV.pos,i=h._currPOV.target;h._mode!==h.MODE_DEVORI?(h._vDir.subVectors(i,o),h._vDir.normalize(),h._mode===h.MODE_FP?(e.target.copy(o),t.position.x=e.target.x-h._vDir.x*h.FP_EPS,t.position.y=e.target.y-h._vDir.y*h.FP_EPS,t.position.z=e.target.z-h._vDir.z*h.FP_EPS):(t.position.copy(o),e.target.copy(i))):t.position.copy(o)},update:()=>{h.syncCurrPOV(),h.handlePOV(),h.syncCurrCamera()},requestPOV:(e,t)=>{ATON._tPOVcall>=0||void 0!==e&&(ATON.fireEvent("POVTransitionRequested",e.id),h.POVtransitionDuration=void 0!==t?t:h.STD_POV_TRANS_DURATION,h._tPOVcall=ATON._clock.elapsedTime,ATON.XR.isPresenting()?(h._reqPOV.pos.copy(e.pos?e.pos:h._currPOV.pos),h._fromPOV.pos.copy(h._currPOV.pos),ATON.XR._reqPos.copy(e.pos?e.pos:h._currPOV.pos),ATON.XR._fromPos.copy(ATON.XR._currPos)):(h._reqPOV.pos.copy(e.pos?e.pos:h._currPOV.pos),h._reqPOV.target.copy(e.target?e.target:h._currPOV.target),h._reqPOV.fov=e.fov?e.fov:h._currPOV.fov,h._fromPOV.pos.copy(h._currPOV.pos),h._fromPOV.target.copy(h._currPOV.target),h._fromPOV.fov=h._currPOV.fov))},requestPOVbyBound:(e,t)=>{if(void 0===e)return;let o=new THREE.Vector3,i=3*e.radius;o.x=e.center.x-i*h._vDir.x,o.y=e.center.y-i*h._vDir.y,o.z=e.center.z-i*h._vDir.z;let r=(new ATON.POV).setPosition(o).setTarget(e.center);h.requestPOV(r,t)},requestPOVbyNode:(e,t)=>{if(void 0===e)return;let o=e.getBound();h.requestPOVbyBound(o,t)},requestPOVbyID:(e,t)=>{if(void 0===e)return;let o=h.povlist[e];void 0!==o&&h.requestPOV(o,t)},requestRetarget:(e,t,o)=>{let i=new THREE.Vector3;if(void 0===t)i.lerpVectors(e,h._currPOV.pos,.8);else{let o=e.distanceTo(h._currPOV.pos);o*=.5,i.x=e.x+t.x*o,i.y=e.y+t.y*o,i.z=e.z+t.z*o}let r=e.distanceTo(i);ATON.FX.setDOFfocus(r);let n=(new ATON.POV).setPosition(i).setTarget(e).setFOV(h._currPOV.fov);h.requestPOV(n,o),console.log(n)},computeDefaultHome:(e,t)=>{void 0===e&&(e=new THREE.Vector3(1,.7,1)),void 0===t&&(t=ATON.getRootScene().getBound());let o=new THREE.Vector3(t.center.x+t.radius*e.x*1.5,t.center.y+t.radius*e.y*1.5,t.center.z+t.radius*e.z*1.5);h.homePOV=(new ATON.POV).setPosition(o).setTarget(t.center)},setHomePOV:e=>{h.homePOV=e},computeAndRequestDefaultHome:(e,t,o)=>{h.computeDefaultHome(t,o),h.requestPOV(h.homePOV,e)},requestHome:e=>{h.requestPOV(h.homePOV,e)},setAndRequestHomePOV:(e,t)=>{h.setHomePOV(e),h.requestPOV(e,t)},clear:()=>{h.clearPOVs(),h.clearLocomotionNodes()},DeviceOrientationControls:function(e){let t=this;this.object=e,this.object.rotation.reorder("YXZ"),this.enabled=!0,this.deviceOrientation={},this.screenOrientation=0,this.alphaOffset=0,this.absolute=!1,this.alphaOffsetDevice=void 0,this.alphaOffsetScreen=void 0;let o=function(e){t.absolute||(t.deviceOrientation=e)},i=function(e){t.deviceOrientation=e,t.absolute=!0},r=function(){t.screenOrientation=window.orientation||0},n=function(){let e=new THREE.Vector3(0,0,1),t=new THREE.Euler,o=new THREE.Quaternion,i=new THREE.Quaternion(-Math.sqrt(.5),0,0,Math.sqrt(.5));return function(r,n,s,a,d){t.set(s,n,-a,"YXZ"),r.setFromEuler(t),r.multiply(i),r.multiply(o.setFromAxisAngle(e,-d))}}();this.connect=function(){r(),window.addEventListener("orientationchange",r,!1),window.addEventListener("deviceorientation",o,!1),window.addEventListener("deviceorientationabsolute",i,!1),t.enabled=!0},this.disconnect=function(){window.removeEventListener("orientationchange",r,!1),window.removeEventListener("deviceorientation",o,!1),window.removeEventListener("deviceorientationabsolute",i,!1),t.enabled=!1},this.update=function(){if(!1===t.enabled)return;let e;if(e=t.deviceOrientation,e){let o=this.getDirection()?THREE.Math.degToRad(this.getDirection())+t.alphaOffset:0,i=e.beta?THREE.Math.degToRad(e.beta):0,r=e.gamma?THREE.Math.degToRad(e.gamma):0,s=t.screenOrientation?THREE.Math.degToRad(t.screenOrientation):0;n(t.object.quaternion,o,i,r,s)}},this.dispose=()=>{t.disconnect()},this.iOSOrientationPermission=()=>{"function"==typeof DeviceOrientationEvent.requestPermission&&DeviceOrientationEvent.requestPermission().then((e=>{console.log(e)})).catch(console.error)},this.getDirection=()=>void 0!==t.deviceOrientation.webkitCompassHeading?t.deviceOrientation.webkitCompassHeading:t.deviceOrientation.alpha,this.getDirectionMap=()=>void 0!==t.deviceOrientation.webkitCompassHeading?360-t.deviceOrientation.webkitCompassHeading:t.deviceOrientation.alpha,this.connect()}};const T=h;let m={STD_TELEP_DURATION:.03,HAND_R:0,HAND_L:1,MOBILE_DENSITY_F:.5,MAX_QUERY_DISTANCE:40,init:()=>{ATON._renderer.xr.enabled=!0,ATON._renderer.xr.setReferenceSpaceType("local"),ATON.device.isMobile?ATON._renderer.xr.setFramebufferScaleFactor(ATON._stdpxd*m.MOBILE_DENSITY_F):ATON._renderer.xr.setFramebufferScaleFactor(ATON._stdpxd),m._bPresenting=!1,m.currSession=null,m._sessionType="immersive-vr",m._bReqPresenting=!1,m.rig=new THREE.Group,m.rig.add(ATON.Nav._camera),ATON._rootUI.add(m.rig),m._cam=void 0,m._currPos=m.rig.position,m._fromPos=new THREE.Vector3,m._reqPos=new THREE.Vector3,m.gControllers=void 0,m.controller0=void 0,m.controller1=void 0,m.controller0pos=new THREE.Vector3,m.controller1pos=new THREE.Vector3,m.controller0dir=new THREE.Vector3,m.controller1dir=new THREE.Vector3,m._lastPosR=void 0,m._lastPosL=void 0,m._pointerLineGeom=void 0,m._pointerLineMesh=void 0,m.gpad0=void 0,m.gpad1=void 0,m._urlHand=ATON.PATH_RES+"models/hand/hand.glb",ATON.on("XRselectStart",(e=>{e===m.HAND_R&&ATON._stdActivation()})),ATON.on("XRselectEnd",(e=>{})),ATON.on("XRsqueezeStart",(e=>{e===m.HAND_R&&ATON.VRoadcast.setFocusStreaming(!0)})),ATON.on("XRsqueezeEnd",(e=>{e===m.HAND_R&&ATON.VRoadcast.setFocusStreaming(!1)})),ATON.on("VRC_IDassigned",(e=>{let t=ATON.getUINode("Rhand"),o=ATON.getUINode("Lhand"),i=ATON.MatHub.materials.avatars,r=i[e%i.length];o&&o.setMaterial(r),t&&t.setMaterial(r)}))},setSessionType:e=>{void 0!==e&&("immersive-vr"!==e&&"immersive-ar"!==e||(m._sessionType=e,console.log("Session type: "+e)))},isPresenting:()=>m._bPresenting,teleportOnQueriedPoint:()=>{if(!ATON.Nav.currentQueryValidForLocomotion())return!1;const e=ATON._queryDataScene.p;return ATON.Nav.requestPOV((new ATON.POV).setPosition(e.x,e.y+ATON.userHeight,e.z),m.STD_TELEP_DURATION),!0},setupQueryRay:e=>{void 0!==e&&(m.controller0?e.set(m.controller0pos,m.controller0dir):e.set(ATON.Nav.getCurrentEyeLocation(),ATON.Nav.getCurrentDirection()))},setRefSpaceLocation:e=>{m.rig.position.copy(e)},_setupControllerR:(e,t)=>{m.controller0||(m.controller0=e,console.log("R controller"),e.addEventListener("selectstart",(()=>{ATON.fireEvent("XRselectStart",m.HAND_R)})),e.addEventListener("selectend",(()=>{ATON.fireEvent("XRselectEnd",m.HAND_R)})),e.addEventListener("squeezestart",(()=>{ATON.fireEvent("XRsqueezeStart",m.HAND_R)})),e.addEventListener("squeezeend",(()=>{ATON.fireEvent("XRsqueezeEnd",m.HAND_R)})),m.setupControllerUI(m.HAND_R,t),ATON.fireEvent("XRcontrollerConnected",m.HAND_R))},_setupControllerL:(e,t)=>{m.controller1||(m.controller1=e,console.log("L controller"),e.addEventListener("selectstart",(()=>{ATON.fireEvent("XRselectStart",m.HAND_L)})),e.addEventListener("selectend",(()=>{ATON.fireEvent("XRselectEnd",m.HAND_L)})),e.addEventListener("squeezestart",(()=>{ATON.fireEvent("XRsqueezeStart",m.HAND_L)})),e.addEventListener("squeezeend",(()=>{ATON.fireEvent("XRsqueezeEnd",m.HAND_L)})),m.setupControllerUI(m.HAND_L,t),ATON.fireEvent("XRcontrollerConnected",m.HAND_L))},onSessionStarted:e=>{m.currSession||(m._bReqPresenting=!1,e.addEventListener("end",m.onSessionEnded),console.log(m._sessionType+" session started."),ATON.MediaRec.stopMediaStreaming(),"immersive-ar"===m._sessionType&&ATON._renderer.xr.setReferenceSpaceType("local"),ATON._renderer.xr.setSession(e).then((()=>{m.currSession=e,console.log(m.currSession),"immersive-ar"===m._sessionType&&(ATON._mainRoot.background=null,ATON._mMainPano&&(ATON._mMainPano.visible=!1));for(let e=0;e<2;e++){const t=ATON._renderer.xr.getController(e);void 0===t||t.userData.bXRconfig||(t.visible=!1,t.userData.bXRconfig=!0,t.addEventListener("connected",(e=>{let o=e.data.handedness;t.gm=e.data.gamepad,console.log("Hand "+o),console.log("GamePad "+t.gm),"left"===o?m._setupControllerL(t,!0):"right"===o?m._setupControllerR(t,!0):(t.addEventListener("selectstart",(()=>{ATON.fireEvent("XRselectStart",m.HAND_R),console.log("Head-aligned select")})),t.addEventListener("selectend",(()=>{ATON.fireEvent("XRselectEnd",m.HAND_R)})),ATON.fireEvent("XRcontrollerConnected",m.HAND_R))})))}m.rig.add(ATON.Nav._camera),m.setRefSpaceLocation(ATON.Nav._currPOV.pos),console.log(ATON.Nav._currPOV.pos),m._bPresenting=!0,ATON.Nav._bInteracting=!1,console.log("XR now presenting"),ATON.fireEvent("XRmode",!0),ATON.toggleShadows(!1),ATON.SUI.getSelectorRadius()>ATON.FE.STD_SEL_RAD&&ATON.SUI.setSelectorRadius(ATON.FE.STD_SEL_RAD),ATON._qSyncInt=2;let t=ATON._renderer.xr.getCamera(ATON.Nav._camera);ATON.Nav._updCamera(t),ATON.XPFNetwork.getNumXPFs()>0?ATON.setQueryRange(0,100):ATON.setQueryRange(0,m.MAX_QUERY_DISTANCE),ATON.MRes.estimateTSErrorTarget(),setTimeout((()=>{ATON.SUI.getSelectorRadius()>ATON.FE.STD_SEL_RAD&&ATON.SUI.setSelectorRadius(ATON.FE.STD_SEL_RAD)}),2e3)})))},onSessionEnded:()=>{m.currSession.removeEventListener("end",m.onSessionEnded),m.currSession=null,m._bReqPresenting=!1,m._bPresenting=!1,ATON.Nav._bInteracting=!1,m.setRefSpaceLocation(new THREE.Vector3(0,0,0)),ATON.fireEvent("XRmode",!1),ATON._qSyncInt=1,ATON.MediaRec.stopMediaStreaming(),ATON.Nav.requestHome(),ATON.Nav._updCamera(),ATON.setQueryRange(0,1/0),ATON.MRes.estimateTSErrorTarget(),console.log("Quit XR")},toggle:e=>{if(m.setSessionType(e),ATON.device.xrSupported[m._sessionType])if(null===m.currSession){let e={optionalFeatures:["high-refresh-rate"]};if("immersive-ar"===m._sessionType){e.requiredFeatures=["hit-test"];let t=document.createElement("div");t.style.display="none",document.body.appendChild(t),e.optionalFeatures.push("dom-overlay"),e.domOverlay={root:t}}m._bReqPresenting=!0,navigator.xr.requestSession(m._sessionType,e).then(m.onSessionStarted)}else m.currSession.end()},setupControllerUI:(e,t)=>{let o,i;if(void 0===m.gControllers&&(m.gControllers=ATON.createUINode(),m.gControllers.disablePicking(),m.rig.add(m.gControllers)),e===m.HAND_L?(m.gControllers.add(m.controller1),t&&(i=ATON.createUINode("Lhand").load(m._urlHand).setMaterial(ATON.MatHub.materials.controllerRay).setScale(-1,1,1),m.controller1.add(i))):(m.gControllers.add(m.controller0),t&&(m._pointerLineGeom=new THREE.CylinderBufferGeometry(.003,.003,1,4),m._pointerLineGeom.rotateX(-Math.PI/2),m._pointerLineGeom.translate(0,0,-.5),m._pointerLineMesh=new THREE.Mesh(m._pointerLineGeom,ATON.MatHub.materials.controllerRay),m.controller0.add(m._pointerLineMesh),m._pointerLineMesh.visible=!1,o=ATON.createUINode("Rhand").load(m._urlHand).setMaterial(ATON.MatHub.materials.controllerRay),m.controller0.add(o))),void 0!==ATON.VRoadcast.uid&&t){let t=ATON.MatHub.materials.avatars,r=t[ATON.VRoadcast.uid%t.length];e===m.HAND_L?i.setMaterial(r):o.setMaterial(r)}},switchHands:()=>{let e=m.controller1;m.controller1=m.controller0,m.controller0=e;for(let e in m.controller0.children)m.controller0.remove(m.controller0.children[e]);for(let e in m.controller1.children)m.controller1.remove(m.controller1.children[e]);m.gControllers.removeChildren(),m.setupControllerUI(m.HAND_L),m.setupControllerUI(m.HAND_R),console.log("VR controllers switched")},getControllerSpace:e=>{1===e?m.getControllerGrip(1):m.getControllerGrip(0)},getControllerWorldLocation:e=>1===e?m.controller1pos:m.controller0pos,getControllerWorldDirection:e=>1===e?m.controller1dir:m.controller0dir,_deltaMotionController:e=>{if(e===m.HAND_L&&void 0===m._lastPosL)return;if(e===m.HAND_R&&void 0===m._lastPosR)return;let t=e===m.HAND_L?m.controller1pos:m.controller0pos,o=e===m.HAND_L?m._lastPosL:m._lastPosR;THREE.Vector3(t.x-o.x,t.y-o.y,t.z-o.z).lengthSq(),e===m.HAND_L?m._lastPosL=t:m._lastPosR=t},update:()=>{m.controller0&&m.controller0.visible&&(m.controller0.getWorldPosition(m.controller0pos),m.controller0.getWorldDirection(m.controller0dir),m.controller0dir.negate()),m.controller1&&m.controller1.visible&&(m.controller1.getWorldPosition(m.controller1pos),m.controller1.getWorldDirection(m.controller1dir),m.controller1dir.negate())},getAxisValue:e=>{let t=new THREE.Vector2(0,0),o=e===m.HAND_L?m.controller1:m.controller0;if(void 0===o)return t;if(void 0===o.gm||void 0===o.gm.axes)return t;let i=o.gm.axes[0],r=o.gm.axes[2],n=o.gm.axes[1],s=o.gm.axes[3];return t.x=i>0?-i:r,t.y=n>0?n:-s,t}};const v=m;let N={STD_BTN_SIZE:.1,STD_SELECTOR_TICKNESS:1.05};N.Button=class extends t{constructor(e,t=1,o=1){super(e,ATON.NTYPES.UI),this.baseColor=ATON.MatHub.colors.black,this.switchColor=ATON.MatHub.colors.green,this.baseOpacity=.5,this.hoverOpacity=.8,this._bSwitched=!1,this.container=new ThreeMeshUI.Block({width:.1*t,height:.1,padding:.01,borderRadius:.02,backgroundColor:this.baseColor,backgroundOpacity:this.baseOpacity,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),this.add(this.container),this.uiText=new ThreeMeshUI.Text({content:"",fontSize:.02*o,fontColor:ATON.MatHub.colors.white}),this.container.add(this.uiText);let i=.9*ATON.SUI.STD_BTN_SIZE*t,r=.9*ATON.SUI.STD_BTN_SIZE;this._trigger=new THREE.Mesh(new THREE.PlaneGeometry(i,r,2),ATON.MatHub.materials.fullyTransparent),this._trigger.position.set(0,0,.002),this.add(this._trigger),this.onHover=()=>{this.container.set({backgroundOpacity:this.hoverOpacity})},this.onLeave=()=>{this.container.set({backgroundOpacity:this.baseOpacity})},this.enablePicking(),ThreeMeshUI.update()}setBaseColor(e){return this.baseColor=e,this._bSwitched||this.container.set({backgroundColor:this.baseColor}),ThreeMeshUI.update(),this}setSwitchColor(e){return this.switchColor=e,this._bSwitched&&this.container.set({backgroundColor:this.switchColor}),ThreeMeshUI.update(),this}setBackgroundOpacity(e){return this.container.set({backgroundOpacity:e}),this.baseOpacity=e,ThreeMeshUI.update(),this}setText(e){return this.uiText.set({content:e}),ThreeMeshUI.update(),this}switch(e){return this._bSwitched=e,e?this.container.set({backgroundColor:this.switchColor}):this.container.set({backgroundColor:this.baseColor}),ThreeMeshUI.update(),this}setIcon(e,t){return ATON.Utils.textureLoader.load(e,(e=>{this._trigger.material=new THREE.MeshStandardMaterial({map:e,transparent:!0,depthWrite:!1}),t&&(this.setBackgroundOpacity(0),this.hoverOpacity=0),this.uiText.position.set(0,-.035,0)})),ThreeMeshUI.update(),this}},N.Label=class extends t{constructor(e,t,o){super(e,ATON.NTYPES.UI),this.baseColor=ATON.MatHub.colors.black,this.container=new ThreeMeshUI.Block({width:t||.2,height:o||.05,padding:.001,borderRadius:.01,backgroundColor:this.baseColor,backgroundOpacity:.5,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),this.container.position.z=.03,this.add(this.container),this.uiText=new ThreeMeshUI.Text({content:"Label",fontSize:.03,fontColor:ATON.MatHub.colors.white}),this.container.add(this.uiText),ThreeMeshUI.update()}setBaseColor(e){return this.baseColor=e,this.container.set({backgroundColor:this.baseColor}),ThreeMeshUI.update(),this}setTextColor(e){return this.uiText.set({fontColor:e}),ThreeMeshUI.update(),this}setText(e){return this.uiText.set({content:e}),ThreeMeshUI.update(),this}},N.init=()=>{N.initSelector(),N.fpTeleport=ATON.createUINode();let e=new THREE.CylinderBufferGeometry(.4,.4,.9,32,1,!0),t=new THREE.Mesh(e,ATON.MatHub.getMaterial("teleportLoc"));t.renderOrder=100,N.fpTeleport.add(t),N.fpTeleport.disablePicking(),N.fpTeleport.visible=!1,ATON._rootUI.add(N.fpTeleport),N.PATH_FONT_JSON=ATON.PATH_RES+"fonts/custom-msdf.json",N.PATH_FONT_TEX=ATON.PATH_RES+"fonts/custom.png",N.gMeasures=ATON.createUINode(),N._prevMPoint=void 0,N._measLabels=[],ATON._rootUI.add(N.gMeasures);let o=(new THREE.BufferGeometry).setFromPoints([new THREE.Vector3,new THREE.Vector3]);N._measLine=new THREE.Line(o,ATON.MatHub.getMaterial("measurement")),N._measLine.visible=!1,ATON._rootUI.add(N._measLine),N.gPoints=ATON.createUINode(),ATON._rootUI.add(N.gPoints),N.gLocNodes=ATON.createUINode(),ATON._rootUI.add(N.gLocNodes),N.buildInfoNode(),N.bShowInfo=!0,N._labelScale=ATON.Utils.isMobile()?80:90,N._labelScaleVR=2,N.sprites={},N._sync=0},N.getOrCreateSpritePointEdit=()=>(N.sprites.pointEdit||(N.sprites.pointEdit=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-point.png"),color:ATON.MatHub.colors.orange,transparent:!0,opacity:1,depthTest:!1})),N.sprites.pointEdit),N.getOrCreateSpriteSemIcon=()=>(N.sprites.semIcon||(N.sprites.semIcon=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-sem.png"),transparent:!0,opacity:1,depthWrite:!1,depthTest:!1})),N.sprites.semIcon),N.getOrCreateSpriteLP=()=>(N.sprites.lp||(N.sprites.lp=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-lp.png"),transparent:!0,opacity:1,depthWrite:!1}),N.sprites.lp.sizeAttenuation=!1),N.sprites.lp),N.getOrCreateSpriteWalk=()=>(N.sprites.walk||(N.sprites.walk=new THREE.SpriteMaterial({map:(new THREE.TextureLoader).load(ATON.PATH_RES+"sui-walk.png"),transparent:!0,opacity:1,depthWrite:!1})),N.sprites.walk),N.initSelector=()=>{N.mainSelector=ATON.createUINode(),N._mSelectorSphere=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("selector")),N._mSelectorSphere.renderOrder=100;let e=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.getMaterial("outline"));e.scale.set(N.STD_SELECTOR_TICKNESS,N.STD_SELECTOR_TICKNESS,N.STD_SELECTOR_TICKNESS),e.renderOrder=100,N.mainSelector.add(e),N.mainSelector.add(N._mSelectorSphere),N.mainSelector.disablePicking(),N.setSelectorRadius(.05),N.mainSelector.visible=!1,ATON._rootUI.add(N.mainSelector),N._selOffset=new THREE.Vector3,N._bShowSelector=!0},N.enableLPIcons=()=>{N.gLPIcons=ATON.createUINode(),N.gLPIcons.disablePicking(),ATON._rootUI.add(N.gLPIcons)},N.enableSemIcons=()=>{N.gSemIcons=ATON.createUINode(),N.gSemIcons.disablePicking(),ATON._rootUI.add(N.gSemIcons)},N.showSelector=e=>{N._bShowSelector=e},N.setSelectorRadius=e=>{N._selectorRad=e,N.mainSelector.scale.set(e,e,e)},N.setSelectorOffset=(e,t,o)=>{void 0!==e&&(N._selOffset.x=e),void 0!==t&&(N._selOffset.y=t),void 0!==o&&(N._selOffset.z=o);let i=ATON.getSceneQueriedPoint();void 0!==i&&(N.mainSelector.position.x=i.x+N._selOffset.x,N.mainSelector.position.y=i.y+N._selOffset.y,N.mainSelector.position.z=i.z+N._selOffset.z)},N.getSelectorRadius=()=>N._selectorRad,N.getSelectorLocation=()=>N.mainSelector.position,N.setSelectorModel=(e,t)=>{void 0!==e&&(N.mainSelector.removeChildren(),N.mainSelector.load(e).disablePicking(),t&&N.mainSelector.setMaterial(ATON.MatHub.getMaterial("selector")))},N.setSelectorColor=(e,t)=>{let o=ATON.MatHub.materials.selector;o.uniforms.tint.value=e,void 0!==t&&(o.uniforms.opacity.value=t)},N.addSemIcon=(e,t)=>{if(void 0===N.gSemIcons)return;let o=(new THREE.Box3).setFromObject(t),i=new THREE.Sphere;o.getBoundingSphere(i);let r=new THREE.Sprite(N.getOrCreateSpriteSemIcon());r.position.copy(i.center),r.scale.set(.8,.8,1),r.name=e,N.gSemIcons.add(r)},N.addLPIcon=e=>{if(void 0===N.gLPIcons)return;let t=e._near,o=new THREE.Sprite(N.getOrCreateSpriteLP());o.position.copy(e.pos),o.scale.set(.1,.1,.1);let i=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.materials.lp);i.scale.set(t,t,t),i.position.copy(e.pos),N.gLPIcons.add(o),N.gLPIcons.add(i)},N.setSemIconsOpacity=e=>{ATON.MatHub.spriteSemIcon.opacity=void 0===e?1:e},N.buildInfoNode=()=>{N.infoNode=ATON.createUINode(),N.infoNode.attachToRoot(),N.infoContainer=new ThreeMeshUI.Block({width:.2,height:.05,padding:.01,borderRadius:.02,backgroundColor:ATON.MatHub.colors.black,backgroundOpacity:.4,fontFamily:N.PATH_FONT_JSON,fontTexture:N.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),N.infoContainer.position.y=.03,N.infoNode.add(N.infoContainer),N.infoNodeText=new ThreeMeshUI.Text({content:"Info",fontSize:.02,fontColor:ATON.MatHub.colors.white}),N.infoContainer.add(N.infoNodeText),ThreeMeshUI.update()},N.getInfoNode=()=>N.infoNode,N.setInfoNodeText=e=>{N.bShowInfo&&(N.infoNodeText.set({content:e}),ThreeMeshUI.update())},N.createToolbar=(e,t)=>{let o=ATON.createUINode(),i=e.length,r=.3*N.STD_BTN_SIZE,n=new ThreeMeshUI.Block({width:N.STD_BTN_SIZE*i*1.1+r,height:N.STD_BTN_SIZE+r,padding:.01,borderRadius:.02,backgroundColor:t||ATON.MatHub.colors.black,backgroundOpacity:.3,fontFamily:N.PATH_FONT_JSON,fontTexture:N.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),s=.5*i*N.STD_BTN_SIZE*1.1;s-=.5*N.STD_BTN_SIZE;for(let t=0;t<i;t++){let o=e[t];o&&(o.position.set(t*N.STD_BTN_SIZE*1.1-s,0,.005),n.add(o))}return o.add(n),ThreeMeshUI.update(),o},N.buildPanelNode=(e,t,o,i)=>{void 0===o&&(o=1),void 0===i&&(i=1);let r=ATON.createUINode(e),n=new THREE.Mesh(new THREE.PlaneGeometry(o,i,2),ATON.MatHub.materials.fullyTransparent);return r.add(n),void 0!==t&&ATON.Utils.textureLoader.load(t,(e=>{n.material=new THREE.MeshStandardMaterial({map:e,transparent:!0,depthWrite:!1,side:THREE.DoubleSide})})),r},N.addMeasurementPoint=e=>{if(void 0===e)return;let t=.01,o=.001;if(void 0===N._prevMPoint){N._prevMPoint=e;let t=N._measLine.geometry.attributes.position.array;return t[0]=e.x,t[1]=e.y,void(t[2]=e.z)}N._measLine.visible=!1;let i=N._prevMPoint.distanceTo(e);t*=i,o*=i;let r=new THREE.Mesh(ATON.Utils.geomUnitCube,ATON.MatHub.getMaterial("measurement"));r.position.copy(N._prevMPoint),r.scale.set(t,t,t),N.gMeasures.add(r);let n=new THREE.Mesh(ATON.Utils.geomUnitCube,ATON.MatHub.getMaterial("measurement"));n.position.copy(e),n.scale.set(t,t,t),N.gMeasures.add(n);let s=2*i,a=(new THREE.BufferGeometry).setFromPoints([N._prevMPoint,e]);N.gMeasures.add(new THREE.Line(a,ATON.MatHub.getMaterial("measurement")));let d=new N.Label;d.setBaseColor(ATON.MatHub.colors.white).setTextColor(ATON.MatHub.colors.black),d.userData.vStart=new THREE.Vector3,d.userData.vEnd=new THREE.Vector3,d.userData.vStart.copy(N._prevMPoint),d.userData.vEnd.copy(e),d.userData.vSEdir=new THREE.Vector3,d.userData.vSEdir.x=d.userData.vStart.x-d.userData.vEnd.x,d.userData.vSEdir.y=d.userData.vStart.y-d.userData.vEnd.y,d.userData.vSEdir.z=d.userData.vStart.z-d.userData.vEnd.z,d.userData.vSEdir.normalize(),d.setPosition(.5*(N._prevMPoint.x+e.x),.5*(N._prevMPoint.y+e.y),.5*(N._prevMPoint.z+e.z)),d.setScale(s).setText(ATON.Utils.getHumanReadableDistance(i)),N.gMeasures.add(d),N._measLabels.push(d);let l={};return l.A=d.userData.vStart,l.B=d.userData.vEnd,N._prevMPoint=void 0,l},N.clearMeasurements=()=>{N.gMeasures.removeChildren(),N._measLabels=[]},N._updateMeasurements=()=>{if(N._measLabels.length<=0)return;ATON.Nav.getCurrentEyeLocation();let e=new THREE.Vector3,t=new THREE.Vector3,o=new THREE.Vector3;for(let i in N._measLabels){let r=N._measLabels[i],n=(r.userData.vStart,r.userData.vEnd,r.userData.vSEdir);e.crossVectors(n,ATON.Nav._vDir),t.crossVectors(n,e),o.set(r.position.x+t.x,r.position.y+t.y,r.position.z+t.z),r.lookAt(o)}e=null,t=null,o=null},N.update=()=>{if(ATON.Nav.isTransitioning()||ATON._bPauseQuery)N.infoNode.visible=!1;else{if(N._prevMPoint){if(ATON._queryDataScene){let e=N._measLine.geometry.attributes.position.array;e[3]=ATON._queryDataScene.p.x,e[4]=ATON._queryDataScene.p.y,e[5]=ATON._queryDataScene.p.z,N._measLine.geometry.attributes.position.needsUpdate=!0}N._measLine.visible=!0}else N._measLine.visible=!1;if(ATON._queryDataScene&&N._bShowSelector&&!ATON.Nav._bInteracting?(N.mainSelector.visible=!0,N.mainSelector.position.x=ATON._queryDataScene.p.x+N._selOffset.x,N.mainSelector.position.y=ATON._queryDataScene.p.y+N._selOffset.y,N.mainSelector.position.z=ATON._queryDataScene.p.z+N._selOffset.z):N.mainSelector.visible=!1,N.gSemIcons&&(ATON.Nav._bInteracting?N.gSemIcons.hide():void 0===ATON._hoveredSemNode&&N.gSemIcons.show()),ATON.Nav.isOrbit()&&!ATON.XR._bPresenting||!ATON.Nav.currentQueryValidForLocomotion()?N.fpTeleport.visible=!1:(N.fpTeleport.visible=!0,N.fpTeleport.position.copy(ATON._queryDataScene.p)),ATON.XR._pointerLineMesh){let e=0;ATON._queryDataScene&&(e=ATON._queryDataScene.d),ATON._queryDataUI&&(e<=0||ATON._queryDataUI.d<e)&&(e=ATON._queryDataUI.d,N.mainSelector.visible=!1,N.fpTeleport.visible=!1),e>0?(ATON.XR._pointerLineMesh.visible=!0,ATON.XR._pointerLineMesh.scale.set(1,1,e)):ATON.XR._pointerLineMesh.visible=!1}if(N._updateMeasurements(),ATON._queryDataSem)ATON.XR._bPresenting&&(N.bShowInfo&&(N.infoNode.visible=!0),ATON.XR.controller0?(N.infoNode.position.copy(ATON.XR.controller0pos),N.infoNode.position.x-=.1*ATON.XR.controller0dir.x,N.infoNode.position.y-=.1*ATON.XR.controller0dir.y,N.infoNode.position.z-=.1*ATON.XR.controller0dir.z):(N.infoNode.position.lerpVectors(ATON._queryDataSem.p,ATON.Nav._currPOV.pos,.5),N.infoNode.setScale(ATON._queryDataSem.d*N._labelScaleVR)),N.infoNode.orientToCamera()),ATON.VRoadcast._bStreamFocus||(N.mainSelector.visible=!1);else if(ATON.XR._bPresenting&&N.bShowInfo&&ATON._queryDataScene&&void 0!==ATON.XPFNetwork._semCurr){N.infoNode.position.lerpVectors(ATON._queryDataScene.p,ATON.Nav._currPOV.pos,.5);const e=ATON._queryDataScene.d*(ATON.Nav._currPOV.fov/N._labelScale);N.infoNode.setScale(e),N.infoNode.orientToCamera(),N.infoNode.visible=!0}else N.infoNode.visible=!1;if(N.mainSelector.visible&&ATON.VRoadcast._bStreamFocus){let e=N._selectorRad*(1+.2*Math.cos(10*ATON._clock.elapsedTime));N.mainSelector.scale.set(e,e,e);let t=ATON.getSceneFocalPoint();void 0!==t&&void 0!==ATON.plight&&(ATON.enablePointLight(),ATON.plight.position.copy(t),ATON.plight.distance=2*N._selectorRad)}}};const O=N;let g={POPUP_DT:500,init:()=>{g.PATH_RES_ICONS=ATON.PATH_RES+"icons/",g._setupBase()},_setupBase:()=>{document.body.oncontextmenu=()=>!1},basicSetup:()=>{},showSemLabel:e=>{$(g._elLabel).html(e),$(g._elLabel).show()},hideSemLabel:()=>{$(g._elLabel).hide(),$(g._elLabel).html("")},button:e=>{e.icon&&!e.icon.includes(".")&&(e.icon=ATON.UI.PATH_RES_ICONS+e.icon+".png");let t=document.createElement("div");e.id&&(t.id=e.id),t.className="atonBTN",e.icon&&(t.innerHTML="<img src='"+e.icon+"'>"),e.text&&(t.innerHTML+="<span>"+e.text+"</span>"),e.tooltip&&(t.title=e.tooltip);let o=$(t);return e.onpress&&o.bind("click",e.onpress),o},buttonFullscreen:()=>{},disclosureWidget:e=>{let t=document.createElement("details"),o=$(t);return o.append(e.content),o.prepend("<summary>"+e.summary+"</summary>"),o},popupShow:e=>!g._bPopup&&(g._tPopup=Date.now(),g._elPopupContent.innerHTML="",$(g._elPopupContent).append("<div class='atonPopupTitle'>"+e.title+"</div>"),$(g._elPopupContent).append(e.content),$(g._elPopup).show(),ATON._renderer&&ATON._renderer.domElement&&g.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="blur("+g.popupBlurBG+"px)"),ATON._bPauseQuery=!0,$("#idTopToolbar").hide(),$("#idBottomToolbar").hide(),$("#idBottomRToolbar").hide(),$("#idPoweredBy").hide(),!0),popupClose:()=>{Date.now()-g._tPopup<g.POPUP_DT||(g._bPopup=!1,ATON._bListenKeyboardEvents=!0,ATON._renderer&&ATON._renderer.domElement&&g.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="none"),$(g._elPopup).hide(),ATON._bPauseQuery=!1,$("#idTopToolbar").show(),$("#idBottomToolbar").show(),$("#idBottomRToolbar").show(),$("#idPoweredBy").show(),ATON.focusOn3DView())},createSearch:e=>{let t=e.id??"idScenes",o=e.inputId??"sid",i=e.className??"",r=e.datalist??"sidlist",n=e.placeholder??"Search by term, user or paste a scene-ID...",s=document.createElement("div");s.id=t,""!==i&&(s.className=i);let a=document.createElement("input");a.id=o,a.type="text",a.setAttribute("list",r),a.placeholder=n;let d=document.createElement("datalist");d.id=r;let l=document.createElement("button");return l.innerHTML="Go",l.disabled=!0,l.onclick=()=>ATON.Utils.goToScene(a.value),l.id="btn-go",l.className="atonBTN",l.style="display:inline; cursor:not-allowed",s.appendChild(a),s.appendChild(l),g._fetchData(`${ATON.PATH_RESTAPI}scenes`).then((e=>g._populateSceneList(d,e))),a.oninput=()=>{a.value.length>3&&(l.disabled=!1,l.className+=" atonBTN-green",l.style.cursor="pointer")},s.appendChild(d),s},_fetchData:async(e,t=null)=>{let o=new Request(e);null!==t&&(o=new Request(o,t));let i=await fetch(o);return await i.json()},_populateSceneList:(e,t)=>{t.forEach((t=>{let o=document.createElement("option");o.setAttribute("value",t.sid),e.appendChild(o)}))}};const A=g;let S={USER_STATE_FREQ:.25,REPLICATED_EVT:"EREP",THRES_STATE_POS:.01,THRES_STATE_ORI:.08};S.Avatar=class extends t{constructor(e){super(void 0,ATON.NTYPES.UI),this.userid=e,this.username=void 0,this.message="...",this.color=ATON.VRoadcast.ucolors[this.userid%ATON.VRoadcast.ucolors.length],this._auTalk=new THREE.PositionalAudio(ATON.AudioHub._listener),this._auTalk.setRefDistance(30),this.add(this._auTalk),this._bPlayingAudio=!1,this._auChunks=[],this._tStateCall=-1,this._tProgress=0,this._tFocCall=-1,this._currFocusPos=new THREE.Vector3,this._tgtFocusPos=new THREE.Vector3,this._currState={position:new THREE.Vector3,quaternion:new THREE.Quaternion},this._tgtState={position:new THREE.Vector3,quaternion:new THREE.Quaternion},this.userlabelnode=void 0,this.realize()}getColor(){return this.color}setTalkDistance(e){e>0&&this._auTalk.setRefDistance(e)}getAvatarMaterialByUID(e){let t=ATON.MatHub.materials.avatars;return t[e%t.length]}_buildLabel(){this.userlabelnode=ATON.createUINode(),this.labelcontainer=new ThreeMeshUI.Block({width:.7,height:.25,padding:.03,borderRadius:.05,backgroundColor:ATON.MatHub.colors.black,fontFamily:ATON.SUI.PATH_FONT_JSON,fontTexture:ATON.SUI.PATH_FONT_TEX,justifyContent:"center",textAlign:"center"}),this.userlabelnode.position.y=.4,this.userlabelnode.add(this.labelcontainer),this.usernametext=new ThreeMeshUI.Text({content:"User #"+this.userid,fontSize:.09,fontColor:this.color}),this.usernametext.position.y=0,this.usermessagetext=new ThreeMeshUI.Text({content:"\n...",fontSize:.03,fontColor:ATON.MatHub.colors.white}),this.usermessagetext.position.y=-.03,this.labelcontainer.add(this.usernametext),this.labelcontainer.add(this.usermessagetext),this.add(this.userlabelnode),ThreeMeshUI.update()}realize(){let e=new THREE.SphereGeometry(.2,16,16);this.usermaterial=this.getAvatarMaterialByUID(this.userid);let t=new THREE.Mesh(e,this.usermaterial);this.usermeshnode=ATON.createUINode(),this.usermeshnode.add(t),this.usermeshnode.setMaterial(this.usermaterial),this.usermeshnode.setCloneOnLoadHit(!1),this.add(this.usermeshnode),this.userauinode=new THREE.Sprite(ATON.VRoadcast.uspritemats[this.userid%ATON.VRoadcast.uspritemats.length]),this.userauinode.position.set(0,0,0),this.userauinode.visible=!1,this.add(this.userauinode),this.userfpnode=new THREE.Sprite(ATON.VRoadcast.ufocmats[this.userid%ATON.VRoadcast.ufocmats.length]),this.userfpnode.position.set(0,0,0),this.userfpnode.visible=!1,void 0===ATON.VRoadcast._focNodes[this.userid]&&(ATON.VRoadcast._focNodes[this.userid]=this.userfpnode,ATON.VRoadcast.focGroup.add(this.userfpnode)),this._buildLabel()}loadRepresentation(e){let t=this;return void 0!==t.usermeshnode.children[0]&&t.usermeshnode.remove(t.usermeshnode.children[0]),t.usermeshnode.load(e),this}setUsername(e){return void 0===this.userlabelnode||(this.username=e,this.usernametext.set({content:e}),ThreeMeshUI.update()),this}getUsername(){if(void 0!==this.userid)return void 0===this.username?"User #"+this.userid:this.username}setMessage(e){return void 0===this.userlabelnode||(this.message=e,this.usermessagetext.set({content:"\n"+e}),ThreeMeshUI.update()),this}setTalkVolume(e){if(void 0!==e)if(e>0){this.userauinode.visible=!0;let t=.1+.03*e;this.userauinode.scale.set(t,t,t)}else this.userauinode.visible=!1;else this.userauinode.visible=!1}hideFocalPoint(){this.userfpnode.visible=!1}requestFocus(e){void 0!==e&&(this._tFocCall>=0||(this._tFocCall=ATON._clock.elapsedTime,this._currFocusPos.copy(this.userfpnode.position),this._tgtFocusPos.set(parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])),this._tgtFocusRad=2*parseFloat(e[3]),this.userfpnode.scale.set(this._tgtFocusRad,this._tgtFocusRad,this._tgtFocusRad),this.userfpnode.visible=!0,ATON.enablePointLight(),ATON.plight.color=this.color,ATON.plight.position.copy(this._tgtFocusPos),ATON.plight.distance=this._tgtFocusRad))}handleFocusTransition(){if(this._tFocCall<0)return;let e=ATON.VRoadcast.USER_STATE_FREQ,t=(ATON._clock.elapsedTime-this._tFocCall)/e;if(t>=1)return this._tFocCall=-1,this.userfpnode.position.copy(this._tgtFocusPos),this.userfpnode.scale.set(this._tgtFocusRad,this._tgtFocusRad,this._tgtFocusRad),void(this.userfpnode.visible=!0);this.userfpnode.position.lerpVectors(this._currFocusPos,this._tgtFocusPos,t),ATON.plight.position.copy(this.userfpnode.position),this.userfpnode.visible=!0}requestStateTransition(e){this._tStateCall>=0||void 0!==e&&(this._tStateCall=ATON._clock.elapsedTime,this._currState.position.copy(this.position),this._currState.quaternion.copy(this.quaternion),this._tgtState.position.copy(e.position),this._tgtState.quaternion.copy(e.quaternion))}handleStateTransition(){if(this._tStateCall<0)return;let e=ATON.VRoadcast.USER_STATE_FREQ;this._tProgress=e<=0?1:(ATON._clock.elapsedTime-this._tStateCall)/e;let t=this._currState,o=this._tgtState;if(this._tProgress>=1)return this._tStateCall=-1,this.position.copy(o.position),void this.usermeshnode.quaternion.copy(o.quaternion);this.position.lerpVectors(t.position,o.position,this._tProgress),this.usermeshnode.quaternion.slerp(o.quaternion,this._tProgress)}update(){if(this.handleStateTransition(),this.userfpnode&&this.userfpnode.visible){this.handleFocusTransition();let e=this.userfpnode.scale.x;e>.001?(this.userfpnode.scale.set(.99*e,.99*e,.99*e),ATON.plight.intensity*=.99):(this.userfpnode.visible=!1,ATON.disablePointLight())}let e=ATON.Nav._camera,t=ATON.Nav._currPOV.pos;if(void 0===e||void 0===t)return;this.userlabelnode&&this.userlabelnode.orientToCamera();let o=this.userauinode.scale.x;o*=.99,o>.01?this.userauinode.scale.set(o,o,o):this.userauinode.visible=!1}_handleTalk(){if(this._bPlayingAudio)return;if(this._auChunks.length<1)return;let e=this._auChunks.shift(),t=new Audio;t.src=e.data,t.play(),this._bPlayingAudio=!0,t.onended=()=>{this._bPlayingAudio=!1},this.setTalkVolume(5)}},S.init=()=>{S.address=window.location.origin,S.initMaterials(),S.socket=void 0,S._connected=!1,S._reqSSID=void 0,S._username=void 0,S.uid=void 0,S.color=ATON.MatHub.colors.white,S._bStreamFocus=!1,S._numUsers=1,S.avatarList=[],S.avaGroup=ATON.createUINode("avatars"),S.avaGroup.attachToRoot(),S.focGroup=ATON.createUINode("focus"),S.focGroup.attachTo(S.avaGroup),S._focNodes=[],S.bSendState=!0,window.setInterval(S.sendState,1e3*S.USER_STATE_FREQ),S._lastStateSent=void 0,S._bShowAvaG=!0,console.log("VRoadcast initialized"),S.enableChatLog(),S._decS={quaternion:new THREE.Quaternion,position:new THREE.Vector3}},S.enableChatLog=()=>{S._elChat=$("<div></div>").text("")},S.getNumUsers=()=>S._numUsers,S.initMaterials=()=>{S.ucolorhex=[],S.ucolorhex.push("#F00"),S.ucolorhex.push("#FF0"),S.ucolorhex.push("#0F0"),S.ucolorhex.push("#0FF"),S.ucolorhex.push("#00F"),S.ucolorhex.push("#F0F"),S.ucolors=[],S.ucolors.push(new THREE.Color(S.ucolorhex[0])),S.ucolors.push(new THREE.Color(S.ucolorhex[1])),S.ucolors.push(new THREE.Color(S.ucolorhex[2])),S.ucolors.push(new THREE.Color(S.ucolorhex[3])),S.ucolors.push(new THREE.Color(S.ucolorhex[4])),S.ucolors.push(new THREE.Color(S.ucolorhex[5])),S.ucolorsdark=[],S.ucolorsdark.push(new THREE.Color(.2,0,0)),S.ucolorsdark.push(new THREE.Color(.2,.2,0)),S.ucolorsdark.push(new THREE.Color(0,.2,0)),S.ucolorsdark.push(new THREE.Color(0,.2,.2)),S.ucolorsdark.push(new THREE.Color(0,0,.2)),S.ucolorsdark.push(new THREE.Color(.2,0,.2));let e=ATON.MatHub.materials;e.avatars=[];for(let t=0;t<S.ucolors.length;t++){let o=ATON.MatHub.materials.defUI.clone();o.color=S.ucolors[t],o.uniforms.tint.value=S.ucolors[t],e.avatars.push(o)}S.uspritemats=[];let t=(new THREE.TextureLoader).load(ATON.PATH_RES+"useraui.png");for(let e=0;e<S.ucolors.length;e++){let o=new THREE.SpriteMaterial({map:t,depthWrite:!1,color:S.ucolors[e]});o.sizeAttenuation=!0,S.uspritemats.push(o)}S.ufocmats=[];let o=(new THREE.TextureLoader).load(ATON.PATH_RES+"focus.png");for(let e=0;e<S.ucolors.length;e++){let t=new THREE.SpriteMaterial({map:o,depthWrite:!1,depthTest:!1,color:S.ucolors[e]});t.sizeAttenuation=!0,S.ufocmats.push(t)}},S.fireEvent=(e,t)=>{if(!S._connected)return;let o=S.socket;o&&o.emit(S.REPLICATED_EVT,{e,d:t})},S.on=(e,t)=>{if(void 0===t)return;let o=ATON.EventHub.evNetwork;void 0===o[e]&&(o[e]=[]),o[e].push(t)},S.isConnected=()=>void 0!==S.socket&&S._connected,S.hasID=()=>void 0!==S.uid,S.log=e=>{if(!S._connected)return;let t=S.socket;t&&t.emit("LOG",e)},S.joinSession=e=>{S.socket&&(void 0===e&&(e=ATON.SceneHub.currID),void 0!==e?(console.log("Joining VRC session '"+e+"'..."),S.socket.emit("SENTER",e)):console.log("VRC ERROR: current session ID is undefined"))},S.requestSceneState=()=>{S.socket&&S.socket.emit("SSTATE")},S.setAvatarsVisibility=e=>{S._bShowAvaG=e,e?S.avaGroup.show():S.avaGroup.hide()},S.setAddress=e=>{e&&(S.address=e)},S.connect=e=>{if(S._connected)return;S._reqSSID=e;let t={};"https:"===window.location.protocol?(t.path="/svrc/socket.io",t.secure=!0,t.rejectUnauthorized=!1):t.path="/vrc/socket.io",S.socket=io.connect(S.address,t),void 0!==S.socket&&(S._connected=S.socket.connected,S._registerSocketHandlers())},S.disconnect=()=>{void 0!==S.socket&&(S._numUsers=1,S.socket.disconnect(),S.color=ATON.MatHub.colors.white,ATON.plight.color=ATON.MatHub.colors.white,S._connected=!1)},S._onConnected=()=>{},S.setUsername=e=>{S._username=e,void 0!==S.socket&&void 0!==S.uid&&(S._elChat&&S._elChat.append("<i>Your username is now: "+e+"</i><br>"),S.socket.emit("UNAME",e))},S.setMessage=e=>{S._msg=e,void 0!==S.socket&&void 0!==S.uid&&(S._elChat&&(S._elChat.append("<span style='color:"+S.ucolorhex[S.uid%6]+"'><b>YOU</b>: "+e+"</span><br>"),S._elChat.scrollTop(S._elChat.scrollHeight)),S.socket.emit("UMSG",e))},S._registerSocketHandlers=()=>{S.socket.on("connect",(()=>{S._connected=!0,void 0!==S._reqSSID?S.joinSession(S._reqSSID):S.joinSession(ATON.SceneHub.currID),console.log("Connected to VRC service!"),ATON.fireEvent("VRC_Connected"),S._onConnected()})),S.socket.on("disconnect",(()=>{S._connected=!1,S.uid=void 0,S.avaGroup.hide(),S._elChat&&S._elChat.append("<i>YOU disconnected from VRoadcast service</i><br>"),console.log("VRC disconnected!"),ATON.fireEvent("VRC_Disconnected")})),S.socket.on(S.REPLICATED_EVT,(e=>{let t=e.e,o=e.d,i=ATON.EventHub.evNetwork[t];ATON.EventHub.executeHandlers(i,o)})),S.socket.on("ID",(e=>{console.log("Your ID is "+e),S.uid=e,S.color=S.ucolors[S.uid%S.ucolors.length],S._bShowAvaG&&S.avaGroup.show(),S._elChat&&S._elChat.append("<i>Your ID is #"+e+"</i><br>"),S.requestSceneState(),ATON.fireEvent("VRC_IDassigned",e)})),S.socket.on("SSTATE",(e=>{S._numUsers=e.numUsers,console.log("Num. users: "+S._numUsers),ATON.fireEvent("VRC_SceneState",e)})),S.socket.on("UENTER",(e=>{let t=e;console.log("User #"+t+" entered the scene"),S._elChat&&S._elChat.append("<i>User #"+t+" entered the scene</i><br>"),S.touchAvatar(t),S.requestSceneState(),ATON.fireEvent("VRC_UserEnter",t)})),S.socket.on("ULEAVE",(e=>{let t=e;if(void 0===t)return;let o=S.avatarList[t];o&&o.hide(),console.log("User #"+t+" left the scene"),S._elChat&&S._elChat.append("<i>User #"+t+" left the scene</i><br>"),S.requestSceneState(),ATON.fireEvent("VRC_UserLeave",t)})),S.socket.on("USTATE",(e=>{if(!S._bShowAvaG)return;let t=S.decodeState(e),o=t.userid;S.touchAvatar(o).requestStateTransition(t)})),S.socket.on("UFOCUS",(e=>{let t=e.uid,o=e.fp;S.touchAvatar(t).requestFocus(o)})),S.socket.on("UNAME",(e=>{let t=e.uid,o=e.name;void 0!==t&&(S.touchAvatar(t).setUsername(o),console.log("User #"+t+" changed username to: "+o),S._elChat&&S._elChat.append("<i>User #"+t+" changed username to: "+o+"</i><br>"))})),S.socket.on("UMSG",(e=>{let t=e.uid,o=e.msg;if(void 0===t)return;let i=S.touchAvatar(t);i.setMessage(o),console.log("User #"+t+": "+o),S._elChat&&S._elChat.append("<span style='color:"+S.ucolorhex[t%6]+"'><b>"+i.getUsername()+"</b>: "+o+"</span><br>")})),S.socket.on("UTALK",(e=>{let t=e.uid;if(void 0===t)return;let o=e.audio,i=S.touchAvatar(t);i.setTalkVolume(5),i._auTalk.isPlaying&&i._auTalk.stop(),ATON.AudioHub._loader.load(o,(e=>{i._auTalk.setBuffer(e),i._auTalk.setLoop(!1),i._auTalk.play()})),o=null}))},S.encodeState=e=>{if(!e)return;let t=new Float32Array(6);t[0]=e.position.x,t[1]=e.position.y,t[2]=e.position.z;var o=new Int8Array(t.buffer);return o[16]=128*e.quaternion.x,o[17]=128*e.quaternion.y,o[18]=128*e.quaternion.z,o[19]=128*e.quaternion.w,o[20]=e.userid,o},S.decodeState=e=>{let t=new Int8Array(e);return S._decS.userid=t[20],S._decS.quaternion.set(parseFloat(t[16])/128,parseFloat(t[17])/128,parseFloat(t[18])/128,parseFloat(t[19])/128),t=new Float32Array(e),S._decS.position.set(parseFloat(t[0]),parseFloat(t[1]),parseFloat(t[2])),S._decS},S.update=()=>{if(S._connected)for(let e=0;e<S.avatarList.length;e++){let t=S.avatarList[e];t&&t.visible&&t.update()}},S.setFocusStreaming=e=>{if(void 0!==e){if(e)return S._bStreamFocus||(ATON.fireEvent("VRC_FocusStreamingStarted"),ATON.enablePointLight(),ATON.plight.color=ATON.VRoadcast.color),void(S._bStreamFocus=!0);{S._bStreamFocus&&(ATON.fireEvent("VRC_FocusStreamingStopped"),ATON.disablePointLight());let e=ATON.SUI._selectorRad;ATON.SUI.mainSelector.scale.set(e,e,e),S._bStreamFocus=!1}}},S.sendState=()=>{if(!S.bSendState)return;if(void 0===S.uid)return;if(!S.socket||!S._connected)return;let e=ATON.Nav._currPOV;if(!e)return;let t=ATON.getSceneFocalPoint();if(S._bStreamFocus&&void 0!==t){let e=t.x.toPrecision(5),o=t.y.toPrecision(5),i=t.z.toPrecision(5),r=ATON.SUI.getSelectorRadius().toPrecision(5);S.socket.emit("UFOCUS",[e,o,i,r])}if(!e.pos)return;if(!ATON.Nav._qOri)return;if(void 0!==S._lastStateSent){let t=S._lastStateSent.position,o=S._lastStateSent.quaternion,i=t.distanceToSquared(e.pos),r=o.angleTo(ATON.Nav._qOri);if(i<S.THRES_STATE_POS&&r<S.THRES_STATE_ORI)return}void 0===S._lastStateSent&&(S._lastStateSent={},S._lastStateSent.position=new THREE.Vector3,S._lastStateSent.quaternion=new THREE.Quaternion),S._lastStateSent.position.copy(e.pos),S._lastStateSent.quaternion.copy(ATON.Nav._qOri),S._lastStateSent.userid=S.uid;let o=S.encodeState(S._lastStateSent);S.socket.emit("USTATE",o)},S.getAvatar=e=>S.avatarList[e],S.touchAvatar=e=>{if(void 0===S.avatarList[e]){let t=new S.Avatar(e);t.attachTo(S.avaGroup),t.loadRepresentation(ATON.PATH_RES+"models/vrc/head.gltf"),S.avatarList[e]=t}let t=S.avatarList[e];return t.visible||(S._numUsers++,ATON.fireEvent("VRC_UserEnter",e)),S._bShowAvaG&&t.show(),t},S.destroyAvatar=e=>{let t=S.avatarList[e];void 0!==t&&t.destroy()},S.clearAllAvatars=()=>{for(let e in S.avatarList)S.avatarList[e].hide()};const E=S;let P={FLOAT_PREC:5,init:()=>{P.bConvexBuilding=!1,P.convexPoints=[],P.convexNode=void 0,P.currConvexMesh=void 0,P.currSemNode=ATON.createSemanticNode(),P.currSemNode.disablePicking(),P.currSemNode.attachToRoot(),P.resetMaterial(),P._numShapes=0},resetMaterial:()=>{P.currMaterial=ATON.MatHub.getMaterial("semanticShapeHL")},setMaterial:e=>{void 0!==e&&(P.currMaterial=e)},addConvexPoint:e=>{if(void 0===e)return!1;if(P.convexPoints.length>0){let t=P.convexPoints[P.convexPoints.length-1];if(e.equals(t))return!1}P.convexPoints.push(e);let t=P.convexPoints.length,o=new THREE.Sprite(ATON.SUI.getOrCreateSpritePointEdit()),i=.02*ATON.getSceneQueriedDistance();if(void 0===i&&(i=.02),o.position.copy(e),o.scale.set(i,i,i),ATON.SUI.gPoints.add(o),t<4)return!1;let r=new THREE.ConvexGeometry(P.convexPoints),n=new THREE.Mesh(r,ATON.MatHub.getMaterial("semanticShapeEdit"));if(P.bConvexBuilding){let t=P.currConvexMesh;t.geometry.dispose(),t.geometry=r,ATON.Utils.setVectorPrecision(e,4),t.userData._convexPoints.push(e.x),t.userData._convexPoints.push(e.y),t.userData._convexPoints.push(e.z)}else{P.currSemNode.add(n),n.userData._convexPoints=[];for(let e=0;e<t;e++)ATON.Utils.setVectorPrecision(P.convexPoints[e],P.FLOAT_PREC),n.userData._convexPoints.push(P.convexPoints[e].x),n.userData._convexPoints.push(P.convexPoints[e].y),n.userData._convexPoints.push(P.convexPoints[e].z);P.currConvexMesh=n,P.bConvexBuilding=!0}return!0},undoConvexPoint:()=>{if(0!==P.convexPoints.length&&(P.convexPoints.pop(),P.currConvexMesh)){let e=P.currConvexMesh.userData;e._convexPoints&&e._convexPoints.pop()}},stopCurrentConvex:()=>{P.convexPoints=[],P.bConvexBuilding=!1,P.currSemNode.removeChildren(),ATON.SUI.gPoints.removeChildren()},getCurrentConvexShape:()=>P.currSemNode,isBuildingShape:()=>P.convexPoints.length>0,completeConvexShape:e=>{if(P.convexPoints=[],P.bConvexBuilding=!1,void 0===P.currSemNode)return;void 0===e&&(e="sem"+P._numShapes);let t=ATON.getSemanticNode(e)||ATON.createSemanticNode(e),o=P.currSemNode.children[0];return ATON.SUI.addSemIcon(e,o),t.add(o),t.setMaterial(ATON.MatHub.materials.semanticShape),t.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,P.currMaterial),t.enablePicking(),P.currSemNode.removeChildren(),P._numShapes++,ATON.SUI.gPoints.removeChildren(),ATON._bqSem=!0,t},createConvexShape:(e,t)=>{let o=new THREE.ConvexGeometry(t),i=new THREE.Mesh(o,ATON.MatHub.materials.semanticShape);i.userData._convexPoints=[];for(let e=0;e<t.length;e++){let o=t[e];ATON.Utils.setVectorPrecision(o,4),i.userData._convexPoints.push(o.x),i.userData._convexPoints.push(o.y),i.userData._convexPoints.push(o.z)}ATON.SUI.addSemIcon(e,i);let r=ATON.getOrCreateSemanticNode(e);return r.add(i),r.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,P.currMaterial),r.enablePicking(),ATON._bqSem=!0,r},addSurfaceConvexPoint:e=>{if(void 0===ATON._queryDataScene)return!1;void 0===e&&(e=.02);let t=ATON._queryDataScene.p,o=ATON.Nav.getCurrentEyeLocation();return t.lerpVectors(t,o,e),P.addConvexPoint(t),t},createSphere:(e,t,o)=>{if(void 0===t)return;if(void 0===o)return;void 0===e&&(e="sem"+P._numShapes);let i=ATON.getOrCreateSemanticNode(e),r=new THREE.Mesh(ATON.Utils.geomUnitSphere,ATON.MatHub.materials.semanticShape),n=new THREE.Object3D;return n.position.copy(t),n.scale.set(o,o,o),n.add(r),ATON.SUI.addSemIcon(e,n),i.add(n),i.enablePicking(),i.setDefaultAndHighlightMaterials(ATON.MatHub.materials.semanticShape,P.currMaterial),P._numShapes++,ATON._bqSem=!0,i},createSurfaceSphere:e=>{if(!ATON._queryDataScene)return;let t=ATON._queryDataScene.p,o=ATON.SUI.getSelectorRadius();return P.createSphere(e,t,o)},deleteSemanticNode:e=>{let t=ATON.getSemanticNode(e);if(void 0===t)return!1;if(t.removeChildren(),void 0===ATON.SUI.gSemIcons)return!0;for(let t in ATON.SUI.gSemIcons.children){let o=ATON.SUI.gSemIcons.children[t];o&&o.name===e&&ATON.SUI.gSemIcons.removeChild(o)}return!0}};const f=P;let R={SEMSHAPE_SPHERE:0,SEMSHAPE_CONVEX:1,POPUP_DT:500,STD_SEL_RAD:.05,realize:()=>{R.PATH_RES_ICONS=ATON.PATH_RES+"icons/",R._bPopup=!1,R._tPopup=void 0,R.popupBlurBG=0,R._userAuth={},R._bControlLight=!1,R._bControlSelScale=!1,R._cLightDir=new THREE.Vector3,R._auSemNode=void 0,R._auSemNodePlaying=!1,R._bReqHome=!1,R._bVRCsetup=!1,R.urlParams=new URLSearchParams(window.location.search),R._uiSetupBase(),R._uiProfiles={},R._uiCurrProfile=void 0,R._selRanges=[.01,50],R._selRefRadius=.5,ATON.realize(),ATON.on("Fullscreen",(e=>{R.uiSwitchButton("fullscreen",e)}));let e=ATON.FE.urlParams.get("d");e&&e>0&&ATON.setDefaultPixelDensity(e);let t=ATON.FE.urlParams.get("dd");t&&t>0&&ATON.toggleDynamicDensity(!0),R._canvas=ATON._renderer.domElement,R._bSem=!1,R._bShowSemLabel=!0},_handleHomeReq:()=>{R._bReqHome||ATON.getRootScene().getBound().radius<=0||(R._bReqHome=!0,void 0!==ATON.Nav.homePOV?ATON.Nav.requestHome(1):ATON.Nav.computeAndRequestDefaultHome(.5))},addBasicLoaderEvents:()=>{ATON.on("NodeRequestFired",(()=>{$("#idLoader").show()})),ATON.on("SceneJSONLoaded",(()=>{ATON.SceneHub.getDescription()&&$("#btn-info").show(),void 0!==ATON.Nav.homePOV&&ATON.Nav.requestHome(1),ATON.XPFNetwork._list.length>0&&void 0===ATON.Nav.homePOV&&(ATON.XPFNetwork.setHomeXPF(0),ATON.XPFNetwork.requestTransitionByIndex(0))})),ATON.on("AllNodeRequestsCompleted",(()=>{$("#idLoader").hide(),ATON.CC.anyCopyrightFound()&&$("#btn-cc").show(),R.computeSelectorRanges(),ATON.SUI.setSelectorRadius(Math.min(R.STD_SEL_RAD,R._selRefRadius)),R._handleHomeReq()})),ATON.on("XR_support",(e=>{"immersive-vr"===e.type&&(e.v?$("#btn-vr").show():$("#btn-vr").hide())})),ATON.on("SemanticNodeHover",(e=>{let t=ATON.getSemanticNode(e);void 0!==t&&(R.showSemLabel(e),R._bSem=!0,t.highlight(),$("canvas").css({cursor:"crosshair"}),ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.hide())})),ATON.on("SemanticNodeLeave",(e=>{let t=ATON.getSemanticNode(e);void 0!==t&&(R.hideSemLabel(),R._bSem=!1,t.restoreDefaultMaterial(),$("canvas").css({cursor:"grab"}),ATON.SUI.gSemIcons&&ATON.SUI.gSemIcons.show())})),ATON.on("SemanticMaskHover",(e=>{R.showSemLabel(e),R._bSem=!0,$("canvas").css({cursor:"crosshair"})})),ATON.on("SemanticMaskLeave",(e=>{R.hideSemLabel(),R._bSem=!1,$("canvas").css({cursor:"grab"})})),ATON.addUpdateRoutine(R._update)},showSemLabel:e=>{R._bShowSemLabel&&($("#idPopupLabel").html(e),$("#idPopupLabel").show(),ATON.SUI.setInfoNodeText(e))},hideSemLabel:()=>{$("#idPopupLabel").hide(),$("#idPopupLabel").html("")},controlLight:e=>{R._bControlLight=e,ATON.Nav.setUserControl(!e)},controlSelectorScale:e=>{R._bControlSelScale=e,ATON._bPauseQuery=e,ATON.Nav.setUserControl(!e)},attachGizmoToNode:e=>{if(void 0===ATON._gizmo)return;let t=ATON.getSceneNode(e);void 0!==t&&ATON._gizmo.attach(t)},useMouseWheelToScaleSelector:e=>{void 0===e&&(e=.9),ATON.on("MouseWheel",(t=>{if(ATON._kModCtrl){let e=ATON.Nav.getFOV();return t>0?e+=1:e-=1,void ATON.Nav.setFOV(e)}if(ATON._kModShift){let o=ATON.SUI.mainSelector.scale.x;return t>0?o*=e:o/=e,o<R._selRanges[0]&&(o=R._selRanges[0]),o>R._selRanges[1]&&(o=R._selRanges[1]),void ATON.SUI.setSelectorRadius(o)}}))},loadSceneID:(e,t)=>{if(void 0===e)return;let o=ATON.PATH_RESTAPI_SCENE+e;ATON.SceneHub.load(o,e,t),console.log(o)},_update:()=>{if(R._bControlLight){const e=ATON._screenPointerCoords.x,t=ATON._screenPointerCoords.y;R._cLightDir.x=-Math.cos(e*Math.PI),R._cLightDir.y=4*-t,R._cLightDir.z=-Math.sin(e*Math.PI),R._cLightDir.normalize(),ATON.setMainLightDirection(R._cLightDir)}if(ATON.XR._bPresenting){let e=ATON.XR.getAxisValue(ATON.XR.HAND_R);if(!ATON.VRoadcast._bStreamFocus){let t=ATON.SUI._selectorRad;t+=.01*e.y,t>.001&&ATON.SUI.setSelectorRadius(t)}}else{if(ATON.Nav.isTransitioning()||ATON.Nav._bInteracting||ATON._bPauseQuery)return void $("#idPopupLabel").hide();if(R._bSem&&R._bShowSemLabel){$("#idPopupLabel").show();let e=.5*ATON._screenPointerCoords.x*window.innerWidth,t=.5*(1-ATON._screenPointerCoords.y)*window.innerHeight;t-=55,$("#idPopupLabel").css("transform","translate("+e+"px, "+t+"px)")}else $("#idPopupLabel").hide()}},uiBasicSetup:()=>{R.uiAddButton("idTopToolbar","fullscreen",ATON.toggleFullScreen),ATON.Utils.isConnectionSecure()&&R.uiAddButton("idTopToolbar","vr",ATON.XR.toggle),R.uiAddButton("idBottomToolbar","home",(()=>{ATON.Nav.requestHome(.1)}))},_uiSetupBase:()=>{$("#idPopup").click(R.popupClose),$("#idLoader").html("<img src='"+ATON.PATH_RES+"loader.png'>"),$("body").prepend("<div class='atonPopupLabelContainer'><div id='idPopupLabel' class='atonPopupLabel'></div></div>"),R.hideSemLabel()},uiAddButton:(e,t,o,i)=>{let r,n;t.endsWith(".png")?(r=t,n=t.slice(0,-4)):(r=R.PATH_RES_ICONS+t+".png",n=t);let s=$("<div id='btn-"+n+"' class='atonBTN' ><img src='"+r+"'></div>");$("#"+e).append(s),o&&s.click(o),i&&s.attr("title",i)},uiSwitchButton:(e,t)=>{t?$("#btn-"+e).addClass("switchedON"):$("#btn-"+e).removeClass("switchedON")},uiSetButtonHandler:(e,t)=>{$("#"+e).click(t)},uiAddButtonHome:e=>{R.uiAddButton(e,"home",(()=>{ATON.Nav.requestHome(.3)}),"Home viewpoint")},uiAddButtonFirstPerson:e=>{R.uiAddButton(e,"fp",(()=>{ATON.Nav.isFirstPerson()?(ATON.Nav.setOrbitControl(),R.uiSwitchButton("fp",!1)):(ATON.Nav.setFirstPersonControl(),R.uiSwitchButton("fp",!0))}),"First-person navigation mode"),ATON.Nav.isFirstPerson()?R.uiSwitchButton("fp",!0):R.uiSwitchButton("fp",!1)},uiAddButtonVR:e=>{ATON.Utils.isConnectionSecure()&&(R.uiAddButton(e,"vr",(()=>{ATON.XR.toggle("immersive-vr")}),"Immersive VR mode"),ATON.Utils.isVRsupported()||$("#btn-vr").hide())},uiAddButtonAR:e=>{ATON.Utils.isConnectionSecure()&&R.uiAddButton(e,"ar",(()=>{if(ATON.Utils.isARsupported())ATON.XR.toggle("immersive-ar");else{let e="scene.usdz";ATON.Utils.exportNode(ATON.getRootScene(),e)}}),"Immersive AR mode")},uiAddButtonDeviceOrientation:e=>{ATON.Utils.isConnectionSecure()&&ATON.Utils.isMobile()&&(R.uiAddButton(e,"devori",(()=>{ATON.Nav.isDevOri()?(ATON.Nav.restorePreviousNavMode(),R.uiSwitchButton("devori",!1)):(ATON.Nav.setDeviceOrientationControl(),R.uiSwitchButton("devori",!0))}),"Device-orientation mode"),ATON.Nav.isDevOri()?R.uiSwitchButton("devori",!0):R.uiSwitchButton("devori",!1))},uiAddButtonNav:e=>{R.uiAddButton(e,"nav",(()=>{R.popupNav()}),"Navigation")},uiAddButtonTalk:e=>{ATON.Utils.isConnectionSecure()&&(R.uiAddButton(e,"talk",(()=>{ATON.MediaRec.isAudioRecording()?(ATON.MediaRec.stopMediaStreaming(),$("#btn-talk").removeClass("atonBTN-rec")):(ATON.MediaRec.startMediaStreaming(),$("#btn-talk").addClass("atonBTN-rec"))}),"Talk ON/OFF"),ATON.MediaRec.isAudioRecording()?$("#btn-talk").addClass("atonBTN-rec"):$("#btn-talk").removeClass("atonBTN-rec"))},uiAddButtonStreamFocus:e=>{R.uiAddButton(e,"focus",(()=>{ATON.VRoadcast._bStreamFocus?(ATON.VRoadcast.setFocusStreaming(!1),$("#btn-focus").removeClass("atonBTN-rec")):(ATON.VRoadcast.setFocusStreaming(!0),$("#btn-focus").addClass("atonBTN-rec"))}),"Focus streaming ON/OFF"),ATON.VRoadcast._bStreamFocus?$("#btn-focus").addClass("atonBTN-rec"):$("#btn-focus").removeClass("atonBTN-rec")},uiAddButtonMainVideoPanoPlayPause:e=>{R.uiAddButton(e,"playpause",(()=>{ATON._vpanoPlaying?ATON._elPanoVideo&&ATON._elPanoVideo.pause():ATON._elPanoVideo&&ATON._elPanoVideo.play()}),"360 Video play/pause"),ATON._elPanoVideo?$("#btn-playpause").show():$("#btn-playpause").hide()},uiAddButtonQR:e=>{R.uiAddButton(e,"qr",R.popupQR,"QR-code")},uiAddButtonScreenshot:e=>{R.uiAddButton(e,"sshot",R.popupScreenShot,"Screenshot")},uiAddButtonInfo:e=>{R.uiAddButton(e,"info",ATON.FE.popupSceneInfo,"Scene information"),$("#btn-info").hide()},uiAddButtonFullScreen:e=>{R.uiAddButton(e,"fullscreen",(()=>{ATON.toggleFullScreen()}),"Fullscreen"),R.uiSwitchButton("fullscreen",ATON.isFullscreen())},uiAddKeywordsArea:(e,t,o,i)=>{let r="";r+="Add keyword: <input id='idKWordInput' list='lkwords' type='text' maxlength='100' size='20'><div class='atonBTN atonBTN-green' id='idKWadd'><img src='"+ATON.FE.PATH_RES_ICONS+"add.png'></div><br>",r+="<div id='idKWords'></div>",$("#"+e).html(r),R.uiAttachInputFilterID("idKWordInput"),$.getJSON(ATON.PATH_RESTAPI+"keywords/",(t=>{let o="<datalist id='lkwords'>";for(let e in t)o+="<option>"+e+"</option>";o+="</datalist>",$("#"+e).append(o)}));let n={},s=e=>{n[e]||(e=e.toLowerCase().trim(),$("#idKWordInput").val(""),n[e]=1,console.log("Added keyword "+e),o&&o(e),$("#idKWords").append("<div class='atonKeyword atonKeywordActivable' id='idkw-"+e+"'>"+e+"</div>"),$("#idkw-"+e).click((()=>{$("#idkw-"+e).remove(),n[e]=void 0,console.log("Removed keyword "+e),i&&i(e)})))};if(t)for(let e in t)s(t[e]);$("#idKWordInput").keypress((function(e){if("13"!=(e.keyCode?e.keyCode:e.which))return;let t=$("#idKWordInput").val().toLowerCase().trim();!t||t.length<3||s(t)})),$("#idKWadd").click((()=>{let e=$("#idKWordInput").val().toLowerCase().trim();!e||e.length<3||s(e)}))},uiAttachCollectionItemsToInput:(e,t)=>{let o="";$("#"+e).attr("list",e+"-list"),$("#"+e).attr("name",e+"-list"),$.getJSON(ATON.PATH_RESTAPI+"c/"+t+"/",(t=>{o+="<datalist id='"+e+"-list'>";for(let e in t){let i=t[e];o+="<option value='"+i+"'>"+i+"</option>"}o+="</datalist>",$("#"+e).html(o)}))},getVRCclassFromID:e=>"atonVRCu"+e%6,_setupVRCevents:()=>{R._bVRCsetup||(ATON.on("VRC_IDassigned",(e=>{$("#btn-vrc").addClass(R.getVRCclassFromID(e)),ATON.SUI.setSelectorColor(ATON.VRoadcast.color),ATON.plight.color=ATON.VRoadcast.color,R.checkAuth((e=>{void 0!==e.username&&ATON.VRoadcast.setUsername(e.username)}))})),ATON.on("VRC_SceneState",(e=>{let t=ATON.VRoadcast.getNumUsers();t>1?$("#idVRCnumusers").html(t):$("#idVRCnumusers").html(""),console.log("Users: "+t)})),ATON.on("VRC_Disconnected",(()=>{$("#btn-vrc").attr("class","atonBTN"),ATON.SUI.setSelectorColor(ATON.MatHub.colors.defUI),$("#idVRCnumusers").html("")})),R._bVRCsetup=!0)},uiAddButtonVRC:e=>{R.uiAddButton(e,"vrc",(()=>{ATON.VRoadcast.isConnected()?R.popupVRC():ATON.VRoadcast.connect()}),"VRoadcast (collaborative session)"),$("#btn-vrc").append("<span id='idVRCnumusers' class='atonVRCcounter'></span>"),R._setupVRCevents(),void 0!==ATON.VRoadcast.uid?$("#btn-vrc").addClass(R.getVRCclassFromID(ATON.VRoadcast.uid)):$("#btn-vrc").attr("class","atonBTN")},uiAddButtonUser:e=>{R.uiAddButton(e,"user",(()=>{R.popupUser()}),"User"),R.checkAuth((e=>{void 0!==e.username?$("#btn-user").addClass("switchedON"):$("#btn-user").removeClass("switchedON")}))},uiSetEditMode:(e,t)=>{ATON.SceneHub._bEdit=e,R.uiSwitchButton("edit",e),ATON._renderer.domElement,e?$("#"+t).addClass("atonToolbar-bg-edit"):$("#"+t).removeClass("atonToolbar-bg-edit")},uiAddButtonEditMode:e=>{R.uiAddButton(e,"edit",(()=>{R.checkAuth((t=>{void 0!==t.username?(ATON.SceneHub._bEdit?R.uiSetEditMode(!1,e):R.uiSetEditMode(!0,e),console.log("Persistent Edit Mode: "+ATON.SceneHub._bEdit)):R.popupUser()}))}),"Persistent Edit Mode"),ATON.SceneHub._bEdit?R.uiSwitchButton("edit",!0):R.uiSwitchButton("edit",!1)},uiAddProfile:(e,t)=>{"function"==typeof t&&(R._uiProfiles[e]=t)},uiLoadProfile:e=>{let t=R._uiProfiles[e];void 0!==t&&(t(),R._uiCurrProfile=e,console.log("Loaded UI Profile: "+R._uiCurrProfile))},getCurrentUIP:()=>R._uiCurrProfile,attachHandlerToButton:(e,t)=>{void 0!==t&&$("#"+e).click((()=>{t()}))},uiAttachInputFilterID:e=>{$("#"+e).on("keyup change input",(()=>{let t=$("#"+e).val(),o=new RegExp("[^A-Za-z0-9-_]","ig");$("#"+e).val(t.replace(o,""))}))},switchNode:(e,t,o)=>{let i;i=o===ATON.NTYPES.SEM?ATON.getSemanticNode(e):ATON.getSceneNode(e),void 0!==i&&(i.toggle(t),ATON.fireEvent("FE_NodeSwitch",{nid:e,t:o,v:t}))},uiCreateGraph:e=>{let t=ATON.snodes;e===ATON.NTYPES.SEM&&(t=ATON.semnodes);let o="";for(let i in t){let r=t[i].visible?"checked":"";"."!==i&&(o+="<input type='checkbox' "+r+" onchange=\"ATON.FE.switchNode('"+i+"',this.checked,"+e+');">'+i,o+="<br>")}return o},setupBasicUISounds:()=>{R.auLib={},R.auLib.switch=new Audio(ATON.PATH_RES+"audio/switch.wav"),R.auLib.switch.loop=!1},playAudioFromSemanticNode:e=>{if(void 0===e)return;let t=ATON.getSemanticNode(e);if(void 0===t)return;let o=t.getAudio();void 0!==o&&(void 0===R._auSemNode||null===R._auSemNode?R._auSemNode=new THREE.Audio(ATON.AudioHub._listener):R._auSemNode.stop(),ATON.AudioHub._loader.load(o,(e=>{R._auSemNode.setBuffer(e),R._auSemNode.setLoop(!1),R._auSemNode.play()})))},popupShow:(e,t)=>{if(R._bPopup)return!1;R._tPopup=Date.now();let o="atonPopup ";t&&(o+=t);let i="<div id='idPopupContent' class='"+o+"'>";return i+=e+"</div>",R._bPopup=!0,ATON._bListenKeyboardEvents=!1,$("#idPopup").html(i),$("#idPopupContent").click((e=>{e.stopPropagation()})),$("#idPopup").show(),R.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="blur("+R.popupBlurBG+"px)"),ATON._bPauseQuery=!0,$("#idTopToolbar").hide(),$("#idBottomToolbar").hide(),$("#idBottomRToolbar").hide(),$("#idPoweredBy").hide(),!0},popupClose:e=>{Date.now()-R._tPopup<R.POPUP_DT||(R._bPopup=!1,ATON._bListenKeyboardEvents=!0,R.popupBlurBG>0&&(ATON._renderer.domElement.style.filter="none"),$("#idPopup").hide(),ATON._bPauseQuery=!1,$("#idTopToolbar").show(),$("#idBottomToolbar").show(),$("#idBottomRToolbar").show(),$("#idPoweredBy").show(),ATON.focusOn3DView())},subPopup:e=>{ATON.FE.popupClose(),e()},popupQR:()=>{let e="<div class='atonPopupTitle'>Share</div>";if(e+="<div class='atonQRcontainer' id='idQRcode'></div><br><br>",!ATON.FE.popupShow("<div class='atonPopupTitle'>Share</div><div class='atonQRcontainer' id='idQRcode'></div><br><br>"))return;let t=window.location.href;new QRCode(document.getElementById("idQRcode"),t)},popupScreenShot:()=>{let e=ATON.Utils.takeScreenshot(256);R.checkAuth((t=>{let o="<div class='atonPopupTitle'>Screenshot</div>";o+="This is a preview of what your screenshot will look like:<br><br>",o+="<img src='"+e.src+"'><br>",o+="Resolution: <input id='isShotSize' type='number' min='100' max='4000' value='256'>px<br>",o+="<div class='atonBTN' id='btnScreenShot' style='width:90%'><img src='"+R.PATH_RES_ICONS+"sshot.png'>SHOT</div>",void 0!==t.username&&(o+="<div class='atonBTN atonBTN-green' id='btnSetCover' style='width:90%'>Set as Cover</div>"),ATON.FE.popupShow(o)&&($("#btnScreenShot").click((()=>{let e=parseInt($("#isShotSize").val());e<100||(ATON.FE.popupClose(),ATON.Utils.takeScreenshot(e,"shot.png"))})),$("#btnSetCover").click((()=>{ATON.FE.popupClose(),ATON.Utils.postJSON(ATON.PATH_RESTAPI+"cover/scene/",{sid:ATON.SceneHub.currID,img:e.src},(e=>{console.log(e)}))})))}))},popupVRC:()=>{let e="",t=ATON.VRoadcast.getNumUsers();e+=t>1?"<div class='atonPopupTitle'>Collaborative Session ("+t+" users)</div>":"<div class='atonPopupTitle'>Collaborative Session</div>",e+="<input id='idVRCusername' type='text' size='10' placeholder='username...' style='display:none'>",e+="<div id='idVRCusernameBTN' class='atonBTN' style='width:150px; display:none'>"+ATON.VRoadcast._username+"</div>",e+="<div id='idChatBox' style='width:100%; height:150px; text-align:left;' class='scrollableY'></div>",e+="<input id='idVRCmsg' style='width:90%' type='text' placeholder='message...'>",e+="<div class='atonBTN' id='idVRCdisconnect' style='width:90%'>LEAVE</div>",ATON.FE.popupShow(e,"atonPopupLarge")&&(void 0===ATON.VRoadcast._username?($("#idVRCusername").show(),$("#idVRCusernameBTN").hide()):($("#idVRCusername").val(ATON.VRoadcast._username),$("#idVRCusername").hide(),$("#idVRCusernameBTN").show()),void 0!==ATON.VRoadcast.uid&&$("#idVRCusernameBTN").addClass("atonVRCu"+ATON.VRoadcast.uid%6),$("#idChatBox").append(ATON.VRoadcast._elChat),$("#idVRCmsg").keypress((e=>{if("13"==(e.keyCode?e.keyCode:e.which)){let e=$("#idVRCmsg").val();ATON.VRoadcast.setMessage(e),$("#idVRCmsg").val("")}})),$("#idVRCusername").keypress((e=>{if("13"==(e.keyCode?e.keyCode:e.which)){let e=$("#idVRCusername").val();ATON.VRoadcast.setUsername(e),$("#idVRCusername").hide(),$("#idVRCusernameBTN").html(ATON.VRoadcast._username),$("#idVRCusernameBTN").show()}})),$("#idVRCusernameBTN").click((()=>{$("#idVRCusername").show(),$("#idVRCusernameBTN").hide()})),$("#idVRCdisconnect").click((()=>{ATON.VRoadcast.disconnect(),ATON.FE.popupClose()})))},checkAuth:e=>{ATON.Utils.checkAuth((t=>{R._userAuth=t,void 0!==t.username?($("#btn-user").addClass("switchedON"),void 0===ATON.VRoadcast._username&&ATON.VRoadcast.setUsername(t.username)):$("#btn-user").removeClass("switchedON"),e&&e(t)}))},popupUser:()=>{R.checkAuth((e=>{if(void 0!==e.username){let t="<img src='"+R.PATH_RES_ICONS+"user.png'><br>";if(t+="<b>'"+e.username+"'</b><br><br>",Object.keys(R._uiProfiles)){t+="UI Profile:<br><div class='select' style='width:150px;'><select id='idUIProfiles'>";for(let e in R._uiProfiles)t+="<option value='"+e+"'>"+e+"</option>";t+="</select><div class='selectArrow'></div></div><br><br>"}if(t+="<div class='atonBTN atonBTN-red atonBTN-text atonBTN-horizontal' id='idLogoutBTN'>LOGOUT</div>",!ATON.FE.popupShow(t))return;R._uiCurrProfile&&(console.log(R._uiCurrProfile),$("#idUIProfiles").val(R._uiCurrProfile)),$("#idLogoutBTN").click((()=>{$.get(ATON.PATH_RESTAPI+"logout",(e=>{console.log(e),ATON.SceneHub.setEditMode(!1),R.uiSwitchButton("edit",!1),ATON.fireEvent("Logout"),$("#btn-user").removeClass("switchedON")})),ATON.FE.popupClose()})),$("#idSHUscenes").click((()=>{ATON.Utils.goToURL("/shu/scenes/")})),$("#idSHUuser").click((()=>{ATON.Utils.goToURL("/shu/auth/")})),$("#idUIProfiles").on("change",(()=>{let e=$("#idUIProfiles").val();R.uiLoadProfile(e),ATON.FE.popupClose()}))}else{let e="<img src='"+R.PATH_RES_ICONS+"user.png'><br>";if(e+="username:<input id='idUsername' type='text' maxlength='15' size='15' ><br>",e+="password:<input id='idPassword' type='password' maxlength='15' size='15' ><br>",e+="<div class='atonBTN atonBTN-green atonBTN-text atonBTN-horizontal' id='idLoginBTN'>LOGIN</div>",!ATON.FE.popupShow(e))return;$("#idLoginBTN").click((()=>{let e=JSON.stringify({username:$("#idUsername").val(),password:$("#idPassword").val()});$.ajax({url:ATON.PATH_RESTAPI+"login",type:"POST",data:e,contentType:"application/json; charset=utf-8",dataType:"json",success:e=>{console.log(e),e&&(ATON.fireEvent("Login",e),$("#btn-user").addClass("switchedON"),ATON.FE.popupClose())}}).fail((e=>{$("#idLoginBTN").html("LOGIN FAILED"),$("#idLoginBTN").attr("class","atonBTN atonBTN-red")}))}))}}))},popupSceneInfo:()=>{let e=ATON.SceneHub.getTitle();void 0===e&&(e=ATON.SceneHub.currID);let t=ATON.SceneHub.getDescription(),o="<div class='atonPopupTitle'>"+e+"</div>";t&&(o+="<div class='atonPopupDescriptionContainer'>"+JSON.parse(t)+"</div>"),o+="<div class='atonBTN atonBTN-green' id='btnOK' style='width:90%'>OK</div>",ATON.FE.popupShow(o)&&$("#btnOK").click((()=>{ATON._onUserInteraction(),ATON.FE.popupClose()}))},computeSelectorRanges:()=>{let e=ATON.bounds.radius;e<=0||(R._selRanges[0]=.001*e,R._selRefRadius=.01*e,R._selRanges[1]=.5*e)},popupSelector:()=>{let e="<div class='atonPopupTitle'>3D Selector</div>",t=ATON.SUI.getSelectorRadius(),o=ATON.Utils.getHumanReadableDistance(t);R.computeSelectorRanges(),e+="Radius (<span id='idSelRadTxt'>"+o+"</span>):<br>",e+="<input id='idSelRad' type='range' min='"+R._selRanges[0]+"' max='"+R._selRanges[1]+"' step='"+R._selRanges[0]+"' style='width:90%'>",ATON.FE.popupShow(e,"atonPopupLarge")&&($("#idSelRad").val(t),$("#idSelRad").on("input change",(()=>{let e=parseFloat($("#idSelRad").val());ATON.SUI.setSelectorRadius(e),$("#idSelRadTxt").html(ATON.Utils.getHumanReadableDistance(e))})))},popupNav:()=>{let e="<div class='atonPopupTitle'>Navigation</div>";e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMfp'></div>",e+="<div style='text-align:left'>Switch between first-person and orbit navigation mode</div>",e+="</div>",ATON.Utils.isConnectionSecure()&&(e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMvr'></div>",e+="<div style='text-align:left'>Immersive VR mode</div>",e+="</div>",ATON.Utils.isMobile()&&(e+="<div style='display:block; width:90%; min-height:50px; vertical-align:top'>",e+="<div style='display:inline-block; width:60px; float:left' id='idNMdevori'></div>",e+="<div style='text-align:left'>Enable or disable device-orientation mode</div>",e+="</div>")),R.popupShow(e)&&(R.uiAddButtonFirstPerson("idNMfp"),R.uiAddButtonDeviceOrientation("idNMdevori"),R.uiAddButtonVR("idNMvr"))},popupModalToken:(e,t)=>{if(void 0===t)return;ATON.FE.popupClose();let o="<div class='atonPopupTitle'>Token Required</div>";e&&(o+=e),o+="<br><input id='idTokStr' style='width:90%' type='text' placeholder='paste your token here'><br>",o+="<br><div class='atonBTN atonBTN-green atonBTN-horizontal atonBTN-text' id='btnTokenOK'>OK</div>",R.popupShow(o)&&$("#btnTokenOK").click((()=>{let e=$("#idTokStr").val();void 0===e||e.length<2||(ATON.FE.popupClose(),t(e))}))},popupNewNode:e=>{void 0===e&&(e=ATON.NTYPES.SCENE);let t="";e===ATON.NTYPES.SCENE&&(t="<div class='atonPopupTitle'>New Scene Node</div>"),e===ATON.NTYPES.SEM&&(t="<div class='atonPopupTitle'>New Semantic Node</div>"),t+="<strong>ID</strong>: <input id='idNID' type='text' size='20' placeholder='node-id'><br>",t+="<div class='atonBTN atonBTN-green atonBTN-horizontal atonBTN-text' id='btnNewNID'><img src='"+ATON.FE.PATH_RES_ICONS+"add.png'>Add</div><br>",R.popupShow(t)&&$("#btnNewNID").click((()=>{let t=$("#idNID").val().trim();void 0===t||t.length<3||new ATON.Node(t,e).attachToRoot()}))}};const b=R;let w={auType:"audio/wav",auExt:".wav",auBitsPerSecond:9e3,auStreamInterval:1e3,auMinVol:1,init:()=>{w._bAudioRecording=!1,w._bStreaming=!1,w.recorder=void 0},realizeAudioRecorder:e=>{if(void 0!==w.recorder)w.recorder.reset(),e&&e();else{if(!ATON.Utils.isConnectionSecure())return;if(!navigator.mediaDevices)return;void 0===w._ds&&(w._ds=setInterval(w._streamChunk,w.auStreamInterval)),navigator.mediaDevices.getUserMedia({video:!1,audio:!0,channelCount:1,echoCancellation:!0}).then((async function(t){w.recorder=RecordRTC(t,{type:"audio",mimeType:w.auType,bitsPerSecond:w.auBitsPerSecond,audioBitsPerSecond:w.auBitsPerSecond,sampleRate:22050,desiredSampRate:22050,disableLogs:!0,numberOfAudioChannels:1}),e&&e()}))}},isAudioRecording:()=>w._bAudioRecording,_stopRecAndSend:e=>{void 0!==w.recorder?w.recorder.stopRecording((()=>{w.recorder.getDataURL((t=>{ATON.VRoadcast.socket&&void 0!==ATON.VRoadcast.uid?(ATON.VRoadcast.socket.compress(!1).emit("UTALK",{audio:t,uid:ATON.VRoadcast.uid}),e&&e()):e&&e()}))})):e&&e()},_onAuBlob:e=>{e&&ATON.VRoadcast.socket&&ATON.VRoadcast.socket.emit("UTALK",{blob:e,uid:ATON.VRoadcast.uid,vol:w._auAVGvolume})},startRecording:()=>{w.realizeAudioRecorder((()=>{w.recorder&&(w._bAudioRecording||(console.log("Recording..."),w.recorder.startRecording(),w._bAudioRecording=!0))}))},stopRecording:()=>{w.recorder&&w.recorder.stopRecording((()=>{let e=w.recorder.getBlob();console.log("Stop recording.");let t=new FileReader;t.readAsDataURL(e),t.onloadend=()=>{let e=t.result;ATON.fireEvent("AudioRecordCompleted",e)},w._bAudioRecording=!1}))},startOrStopRecording:()=>{w._bAudioRecording?w.stopRecording():w.startRecording()},_streamChunk:()=>{w.recorder&&w._bStreaming&&w._stopRecAndSend((()=>{w.recorder.startRecording()}))},startMediaStreaming:()=>{w.realizeAudioRecorder((()=>{w.recorder&&(w._bAudioRecording||(console.log("Start MediaStreaming"),w.recorder.startRecording(),w._bAudioRecording=!0,w._bStreaming=!0))}))},stopMediaStreaming:()=>{w.recorder&&w._bAudioRecording&&(console.log("Stop MediaStreaming"),w._stopRecAndSend((()=>{})),w._bStreaming=!1,w._bAudioRecording=!1)},startOrStopMediaStreaming:()=>{w._bAudioRecording?w.stopMediaStreaming():w.startMediaStreaming()}};const y=w;let M={EARTH_R_KM:6371};M.EARTH_D_KM=2*M.EARTH_R_KM,M.init=()=>{M._bActive=!1,M._wpid=void 0,M._currPos=new THREE.Vector2,M._POIs=[],M._currPOI=void 0,M._closestPOI=void 0,M._maxError=40},M.enableTracking=()=>{M._bActive||ATON.Utils.isConnectionSecure()&&navigator.geolocation&&(M._wpid=navigator.geolocation.watchPosition(M._onPosition,M._onError,{enableHighAccuracy:!0}),M._bActive=!0)},M.disableTracking=()=>{M._bActive&&(navigator.geolocation.clearWatch(M._wpid),M._bActive=!1)},M.setMaxError=e=>{e>0&&(M._maxError=e)},M._onError=()=>{console.log("Geolocation error")},M._onPosition=e=>{if(!M._bActive)return;if(!e.coords)return;let t=e.coords.accuracy;t&&t>M._maxError||(M._currPos.x=e.coords.latitude,M._currPos.y=e.coords.longitude,ATON.fireEvent("GeoLocation",e),M._handlePOIs())},M._handlePOIs=()=>{let e=M._POIs.length;if(!(e<=0)){M._closestPOIdist=void 0,M._closestPOI=void 0;for(let t=0;t<e;t++){let e=M._POIs[t],o=M.distance(M._currPos,e.pos);(void 0===M._closestPOIdist||o<M._closestPOIdist)&&(M._closestPOIdist=o,M._closestPOI=t),o<=e.radius?(M._currPOI!==t&&ATON.fireEvent("EnterPOI",{id:t,distance:o}),M._currPOI=t):(void 0!==M._currPOI&&ATON.fireEvent("LeavePOI",{id:M._currPOI,distance:o}),M._currPOI=void 0)}}},M.getCurrentLocation=()=>{if(M._bActive)return M._currPos},M.locationFromLatLon=(e,t)=>new THREE.Vector2(e,t),M.distance_orig=(e,t)=>{let o=ATON.DEG2RAD*(t.x-e.x),i=ATON.DEG2RAD*(t.y-e.y),r=Math.sin(o/2)*Math.sin(o/2)+Math.cos(ATON.DEG2RAD*e.x)*Math.cos(ATON.DEG2RAD*t.x)*Math.sin(i/2)*Math.sin(i/2),n=2*Math.atan2(Math.sqrt(r),Math.sqrt(1-r));return M.EARTH_R_KM*n*1e3},M.distance=(e,t)=>{let o=.5-Math.cos((t.x-e.x)*ATON.DEG2RAD)/2+Math.cos(e.x*ATON.DEG2RAD)*Math.cos(t.x*ATON.DEG2RAD)*(1-Math.cos((t.y-e.y)*ATON.DEG2RAD))/2;return M.EARTH_D_KM*Math.asin(Math.sqrt(o))*1e3},M.addPOI=(e,t)=>{let o={};return o.pos=new THREE.Vector2(e.x,e.y),o.radius=t,M._POIs.push(o),M._bActive||M.enableTracking(),M._handlePOIs(),M._POIs.length-1},M.getPOIbyIndex=e=>M._POIs[e],M.getClosestPOI=()=>M._closestPOI,M.getClosestPOIdistance=()=>M._closestPOIdist;const C=M;let L={init:()=>{L._id=$("meta[name='aton\\:appid']").attr("content"),L._data={},L.setup=void 0,L.update=void 0,L._bRunning=!1},_sendDataPatch:(e,t,o)=>new Promise(((i,r)=>{if(void 0===e)return void r("No storage ID specified");if(e.length<3)return void r("Storage ID too short");if(void 0===t)return void r("No storage patch");if(void 0===L._id)return void r("No app-ID");void 0===o&&(o=ATON.PATCH_ADD);let n={};n.wappid=L._id,n.fid=e,n.data=t,n.mode=o===ATON.PATCH_DEL?"DEL":"ADD";let s=JSON.stringify(n);$.ajax({url:ATON.PATH_RESTAPI+"patch/wapp",type:"POST",data:s,contentType:"application/json; charset=utf-8",dataType:"json",success:t=>{void 0!==t?(L._data[e]=t,i(t)):r("Error writing on server")}})})),getAppID:()=>L._id,addToStorage:(e,t)=>L._sendDataPatch(e,t,ATON.PATCH_ADD),deleteFromStorage:(e,t)=>L._sendDataPatch(e,t,ATON.PATCH_DEL),getStorage:e=>new Promise(((t,o)=>{void 0!==L._id?void 0!==e?$.getJSON(ATON.PATH_WAPPS+L._id+"/data/"+e+".json",(o=>{console.log(o),L._data[e]=o,t(o)})):o("No storage ID specified"):o()})),realize:(e,t)=>{let o={};return o.setup=e,o.update=t,o.run=()=>{L.run(o)},o.params=new URLSearchParams(window.location.search),o},realizeAndRun:(e,t)=>{let o=L.realize(e,t);L.run(o)},run:e=>{L._bRunning||(L._bRunning=!0,e.setup?e.setup():(ATON.FE.realize(),console.log("App [Warn]: your App should define a setup() routine")),e.update&&ATON.addUpdateRoutine(e.update))}};const H=L;let D={PASS_BASE:"p_base",PASS_AA:"p_aa",PASS_AO:"p_ao",PASS_SSR:"p_ssr",PASS_BLOOM:"p_bloom",PASS_DOF:"p_dof",PASS_GAMMA:"p_gamma",init:()=>{if(void 0===ATON._renderer)return;let e=ATON._renderer.getPixelRatio(),t=ATON._renderer.getSize(new THREE.Vector2);const o=new THREE.WebGLRenderTarget(t.width*e,t.height*e,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,encoding:ATON._stdEncoding});o.texture.name="EffectComposer.rt1",D.composer=new THREE.EffectComposer(ATON._renderer,o),D.passes={},ATON._renderer.autoClear=!1;let i=window.innerWidth*ATON._stdpxd,r=window.innerHeight*ATON._stdpxd;D.passes[D.PASS_BASE]=new THREE.RenderPass(ATON._mainRoot,ATON.Nav._camera),D.composer.addPass(D.passes[D.PASS_BASE]),D.passes[D.PASS_AO]=new THREE.SAOPass(ATON._mainRoot,ATON.Nav._camera,!1,!0),D.passes[D.PASS_AO].params.saoBias=1,D.passes[D.PASS_AO].params.saoScale=100,D.passes[D.PASS_AO].params.saoIntensity=.2,new THREE.ShaderPass(THREE.SobelOperatorShader).uniforms.resolution.value.set(i,r),D.passes[D.PASS_BLOOM]=new THREE.UnrealBloomPass(new THREE.Vector2(i,r),1.5,.4,.85),D.passes[D.PASS_BLOOM].threshold=.9,D.passes[D.PASS_BLOOM].strength=1,D.passes[D.PASS_BLOOM].radius=1.2,D.passes[D.PASS_DOF]=new THREE.BokehPass(ATON._mainRoot,ATON.Nav._camera,{focus:5,aperture:.001,maxblur:.01,width:i,height:r}),D.composer.addPass(D.passes[D.PASS_AO]),D.composer.addPass(D.passes[D.PASS_BLOOM]),D.composer.addPass(D.passes[D.PASS_DOF]),D.togglePass(D.PASS_AO,!1),D.togglePass(D.PASS_BLOOM,!1),D.togglePass(D.PASS_DOF,!1),console.log(D.composer)},togglePass:(e,t)=>{void 0!==D.composer&&(ATON.device.lowGPU||void 0!==D.passes[e]&&(D.passes[e].enabled=void 0===t?!D.passes[e].enabled:t))},isPassEnabled:e=>void 0!==D.composer&&(void 0!==D.passes[e]&&D.passes[e].enabled),setAOintensity:e=>{void 0!==D.composer&&void 0!==D.passes[D.PASS_AO]&&(D.passes[D.PASS_AO].params.saoIntensity=e)},getAOintensity:()=>void 0===D.composer||void 0===D.passes[D.PASS_AO]?0:D.passes[D.PASS_AO].params.saoIntensity,setBloomStrength:e=>{void 0!==D.composer&&void 0!==D.passes[D.PASS_BLOOM]&&(D.passes[D.PASS_BLOOM].strength=e)},getBloomStrength:()=>void 0===D.composer||void 0===D.passes[D.PASS_BLOOM]?0:D.passes[D.PASS_BLOOM].strength,setBloomThreshold:e=>{void 0!==D.composer&&void 0!==D.passes[D.PASS_BLOOM]&&(D.passes[D.PASS_BLOOM].threshold=e)},getBloomThreshold:()=>void 0===D.composer||void 0===D.passes[D.PASS_BLOOM]?0:D.passes[D.PASS_BLOOM].threshold,setDOFfocus:e=>{if(void 0===D.composer)return;if(void 0===D.passes[D.PASS_DOF])return;let t=D.passes[D.PASS_DOF].uniforms;void 0!==t&&(t.focus.value=e)},getDOFfocus:()=>{if(void 0===D.composer)return 0;if(void 0===D.passes[D.PASS_DOF])return 0;let e=D.passes[D.PASS_DOF].uniforms;return void 0===e?0:e.focus.value},setDOFaperture:e=>{if(void 0===D.composer)return;if(void 0===D.passes[D.PASS_DOF])return;let t=D.passes[D.PASS_DOF].uniforms;void 0!==t&&(t.aperture.value=e)}};const V=D;let x={STD_XPF_TRANSITION_DURATION:1,SEM_PREFIX:"XPF",SEMGROUP_PREFIX:"GXPF",init:()=>{x._list=[],x._iCurr=void 0,x._iNext=void 0,x._geom=void 0,x._mesh=void 0,x._mat=void 0,x._size=50,x._gSem=[],x._semIMGMasks={},x._semCanvas=void 0,x._semCTX=void 0,x._semCurr=void 0,x._shColor=new THREE.Color(0,0,1),x._shOpacity=.2,x._txCache={},x._pathMod=void 0,x._realizeBaseMat(),x._elVid=void 0,x._vidPlaying=!1},_realizeBaseMat:()=>{x._uniforms={tBase:{type:"t"},tSem:{type:"t"},tSemHint:{type:"t"},semHL:{type:"vec4",value:new THREE.Vector4(0,1,0,.15)},opacity:{type:"float",value:1},shColor:{type:"vec4",value:new THREE.Vector4(0,0,1,.2)},time:{type:"float",value:0}},x._mat=new THREE.ShaderMaterial({uniforms:x._uniforms,vertexShader:"\n            varying vec3 vPositionW;\n            varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            varying vec2 vUv;\n\n            void main(){\n                vUv = uv;\n\n                vPositionW = vec3( vec4( position, 1.0 ) * modelMatrix);\n                vNormalW   = normalize( vec3( vec4( normal, 0.0 ) * modelMatrix ) );\n                vNormalV   = normalize( vec3( normalMatrix * normal ));\n\n                gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n            }\n        ",fragmentShader:"\n            varying vec3 vPositionW;\n\t\t    varying vec3 vNormalW;\n            varying vec3 vNormalV;\n            varying vec2 vUv;\n\n            uniform float time;\n            uniform sampler2D tBase;\n            uniform sampler2D tSem;\n            uniform sampler2D tSemHint;\n            //uniform sampler2D tDepth;\n\n            uniform vec4 semHL, shColor;\n            uniform float opacity;\n\n\t\t    void main(){\n                vec4 frag = texture2D(tBase, vUv);\n                vec4 sem  = texture2D(tSem, vUv);\n                vec4 semH = texture2D(tSemHint, vUv);\n                float shv = max( max(semH.r,semH.g), semH.b);\n\n                float t = (1.0 * cos(time*2.0));\n                t = clamp(t, 0.0,1.0);\n\n                frag = mix(frag, semHL, (sem.r * semHL.a));\n\n                frag = mix(frag, shColor, (t * shv * shColor.a));\n\n                frag.a = opacity;\n\n                gl_FragColor = frag;\n\t\t    }\n        ",depthTest:!1,depthWrite:!1}),x.setSemanticHintMapOpacity(.2)},setPathModifier:e=>{if(void 0!==e){x._pathMod=e;for(let t in x.list)x.list[t].setPathModifier(e)}},update:()=>{if(ATON.Nav.isTransitioning())return;if(x._list.length<1)return;let e,t,o,i,r=x._list.length,n=ATON.Nav._currPOV.pos,s=ATON.Nav._vDir;x._uniforms.time.value+=ATON._dt,void 0===x._dirLNode&&(x._dirLNode=new THREE.Vector3);for(let a=0;a<r;a++){let r=x._list[a],d=n.distanceToSquared(r._location);(void 0===e||d<e)&&(e=d,t=a),a!==x._iCurr&&(x._dirLNode.x=r._location.x-n.x,x._dirLNode.y=r._location.y-n.y,x._dirLNode.z=r._location.z-n.z,x._dirLNode=x._dirLNode.normalize(),x._dirLNode.dot(s)>.8&&(void 0===o||d<o)&&(o=d,i=a))}i!==x._iNext&&(x.toggleSUI(i,!0),ATON.fireEvent("NextXPF",i)),x._iNext=i,x.querySemanticMasks(),t!==x._iCurr&&(void 0!==x._iCurr&&x._gSem[x._iCurr].hide(),x.setCurrentXPF(t))},realizeBaseGeometry:()=>{void 0===x._geom&&(x._group=new THREE.Group,ATON._rootVisibleGlobal.add(x._group),x._geom=new THREE.SphereBufferGeometry(1,40,40),x._geom.scale(-x._size,x._size,x._size),x._geom.castShadow=!1,x._geom.receiveShadow=!1,x._mesh=new THREE.Mesh(x._geom,x._mat),x._mesh.frustumCulled=!1,x._mesh.renderOrder=-100,x._mesh.layers.enable(ATON.NTYPES.SCENE),x._group.add(x._mesh),x._mesh.visible=!1)},setBaseGeometry:e=>{},add:e=>{if(void 0===e)return;x.realizeBaseGeometry();let t=x._list.length;x._list.push(e);let o=e.getMesh();o&&x._group.add(o);let i=ATON.getOrCreateSemanticNode(x.SEMGROUP_PREFIX+t);x._gSem.push(i),i.attachToRoot(),t>0||(ATON.Nav.toggleLocomotionValidator(!1),ATON._bqScene=!0)},clear:()=>{x._iCurr=void 0,x._iNext=void 0,x._semCurr=void 0;for(let e=0;e<x._list.length;e++){let t=x._list[e];t=null,x._gSem[e]&&(x._gSem[e].removeChildren(),x._gSem[e]=null)}x._gSem=[],x._list=[]},getNumXPFs:()=>x._list.length,getMainGroup:()=>x._group,getSemanticGroup:e=>x._gSem[e],getCurrentSemanticGroup:()=>{if(void 0!==x._iCurr)return x._gSem[x._iCurr]},_preloadBaseLayer:(e,t)=>{if(void 0!==x._txCache[e])return x._txCache[e];let o=x._list[e]._pathbaselayer;x._pathMod&&(o=x._pathMod(o)),ATON.Utils.textureLoader.load(o,(o=>{o.encoding=ATON._stdEncoding,o.generateMipmaps=!0,x._txCache[e]=o,t&&t(o)}))},_clearTexCache:()=>{if(void 0!==x._iCurr)for(let e in x._txCache)x._txCache[e]&&e!==x._iCurr&&(x._txCache[e].dispose(),x._txCache[e]=void 0)},_setBaseLayerTexture:(e,t)=>{x._mat.map=t,x._mat.needsUpdate=!0,x._mesh.position.copy(e.getLocation()),x._mesh.rotation.set(e.getRotation().x,e.getRotation().y,e.getRotation().z)},updateCurrentXPFbaseLayer:e=>{if(void 0===x._iCurr)return;let t=x._list[x._iCurr];if(void 0===t)return;let o=t._pathbaselayer;if(x._pathMod&&(o=x._pathMod(o)),ATON.Utils.isVideo(o)){if(void 0===x._elVid){let e="<video id='idXPFVideo' loop crossOrigin='anonymous' playsinline style='display:none'>";e+="<source src='"+o+"'>",e+="</video>",$(e).appendTo("body"),x._elVid=document.getElementById("idXPFVideo"),x._elVid.onplaying=()=>{console.log("XPF VideoPano playing"),x._vidPlaying=!0},x._elVid.onpause=()=>{console.log("XPF VideoPano paused"),x._vidPlaying=!1},x._elVid.addEventListener("touchstart",(function(){x._elVid.play()})),enableInlineVideo(x._elVid)}let i=new THREE.VideoTexture(x._elVid);return i.encoding=ATON._stdEncoding,x._mat.map=i,x._mat.needsUpdate=!0,x._uniforms.tBase.value=i,x._mesh.position.copy(t.getLocation()),x._mesh.rotation.set(t.getRotation().x,t.getRotation().y,t.getRotation().z),void(e&&e(i))}ATON.Utils.textureLoader.load(o,(o=>{o.encoding=ATON._stdEncoding,o.generateMipmaps=!0,x._mat.map=o,x._mat.needsUpdate=!0,x._uniforms.tBase.value=o,x._mesh.position.copy(t.getLocation()),x._mesh.rotation.set(t.getRotation().x,t.getRotation().y,t.getRotation().z),e&&e(o)}))},playOrPauseXPFVideoStream:()=>{void 0!==x._elVid&&(x._vidPlaying?x._elVid.pause():x._elVid.play())},updateCurrentXPFsemLayer:e=>{let t=x._list.indexOf(e);t<0||t===x._iCurr&&x.loadSemanticMasksIfAny(x._iCurr)},setCurrentXPF:(e,t)=>{x.toggleSUI(e,!1),x._iCurr=e,x._iNext=void 0,x._mesh.visible=!0,x._gSem[e].show(),x.updateCurrentXPFbaseLayer(t),ATON.fireEvent("CurrentXPF",e),ATON.fireEvent("NextXPF",void 0),x.loadSemanticMasksIfAny(e)},toggleSUI:(e,t)=>{if(void 0===e)return;let o=x._list[e];void 0!==o&&o._lnode.toggleSUI(t)},loadSemanticMasksIfAny:e=>{let t=x._list[e];if(void 0!==t){x._semIMGMasks={},x._uniforms.tSemHint.value=0,void 0!==t._semHintURL&&(x._uniforms.tSemHint.value=ATON.Utils.textureLoader.load(t._semHintURL));for(let e in t._semMasksURLs){void 0===x._semCanvas&&(x._semCanvas=document.createElement("canvas"),x._semCanvas.width=2048,x._semCanvas.height=2048,x._semCTX=x._semCanvas.getContext("2d"));let o=t._semMasksURLs[e],i=new Image;i.src=o,x._semIMGMasks[e]=i}}},getXPFbyIndex:e=>x._list[e],getCurrentXPFindex:()=>x._iCurr,getCurrentXPF:()=>{if(void 0!==x._iCurr)return x._list[x._iCurr]},getNextXPFindex:()=>x._iNext,getNextXPF:()=>{if(void 0!==x._iNext)return x._list[x._iNext]},getDistanceToXPFindex:e=>{if(void 0===e)return;let t=x._list[e];return void 0!==t?ATON.Nav._currPOV.pos.distanceTo(t.getLocation()):void 0},showSUIonlyForXPF:e=>{let t=x._list.length;if(!(t<1))for(let o=0;o<t;o++){let t=x._list[o]._lnode;t&&(o==e?t.toggleSUI(!0):t.toggleSUI(!1))}},requestTransitionByIndex:(e,t)=>{let o=x._list[e];void 0!==o&&(void 0===t&&(t=x.STD_XPF_TRANSITION_DURATION),ATON.XR._bPresenting&&(t=0),x.setCurrentXPF(e),ATON.Nav.requestTransitionToLocomotionNode(o.getLocomotionNode(),t))},requestTransitionToTarget:(e,t,o)=>{if(void 0===e)return;let i=new ATON.POV;i.setTarget(e),i.setPosition(ATON.Nav._currPOV.pos),t&&i.setFOV(t),ATON.Nav.requestPOV(i,o)},requestTransitionToDirection:(e,t,o)=>{if(void 0===e)return;let i=new THREE.Vector3;i.x=e.x+ATON.Nav._currPOV.pos.x,i.y=e.y+ATON.Nav._currPOV.pos.y,i.z=e.z+ATON.Nav._currPOV.pos.z,x.requestTransitionToTarget(i,t,o)},setHomeXPF:e=>{let t=x._list[e];if(void 0===t)return;let o=t.getLocomotionNode(),i=(new ATON.POV).setPosition(o.pos).setTarget(o.pos.x,o.pos.y,o.pos.z+1);ATON.Nav.setHomePOV(i)},getSemanticMaskURLfromXPFindex:(e,t)=>{let o=x._list[e];if(void 0!==o)return o.getSemanticMaskURL(t)},getSemanticMaskURLfromCurrentXPF:e=>{if(void 0!==x._iCurr)return x.getSemanticMaskURLfromXPFindex(x._iCurr,e)},setSemanticColor:(e,t)=>{void 0===t&&(t=.15),x._uniforms.semHL.value=new THREE.Vector4(e.r,e.g,e.b,t)},setSemanticOpacity:e=>{void 0===e&&(e=.15),x._uniforms.semHL.value.w=e},setSemanticHintMapOpacity:e=>{void 0===e&&(e=.2),x._shOpacity=e,x._uniforms.shColor.value.w=e},setSemanticHintMapColor:(e,t)=>{void 0!==e&&(x._shColor=e,x._uniforms.shColor.value.x=e.r,x._uniforms.shColor.value.y=e.g,x._uniforms.shColor.value.z=e.b,void 0!==t&&x.setSemanticHintMapOpacity(t))},querySemanticMasks:()=>{if(void 0===x._semCTX)return;if(void 0===ATON._queryDataScene)return;if(void 0===ATON._queryDataScene.uv)return;let e,t=x._semCTX,o=ATON._queryDataScene.uv;for(let i in x._semIMGMasks){let r=x._semIMGMasks[i],n=parseInt(r.width*o.x),s=parseInt(r.height*(1-o.y));if(t.drawImage(r,0,0),t.getImageData(n,s,1,1).data[0]>127){e=i;break}}if(void 0===e)return void 0!==x._semCurr&&ATON.fireEvent("SemanticMaskLeave",x._semCurr),x._semCurr=void 0,x._uniforms.tSem.value=0,x._uniforms.shColor.value.w=x._shOpacity,void(x._mat.needsUpdate=!0);x.highlightSemanticMaskInCurrentXPF(e),x._semCurr=e},highlightSemanticMaskInCurrentXPF:e=>{if(void 0===e)return void 0!==x._semCurr&&ATON.fireEvent("SemanticMaskLeave",x._semCurr),x._semCurr=void 0,x._uniforms.tSem.value=0,x._uniforms.shColor.value.w=x._shOpacity,void(x._mat.needsUpdate=!0);if(x._semCurr===e)return;let t=x.getSemanticMaskURLfromCurrentXPF(e);x._uniforms.tSem.value=ATON.Utils.textureLoader.load(t),x._mat.needsUpdate=!0,ATON.fireEvent("SemanticMaskHover",e),x._uniforms.shColor.value.w=0,void 0!==x._semCurr&&ATON.fireEvent("SemanticMaskLeave",x._semCurr)},loadFromPhotoscanFile:(e,t)=>{if(void 0===e)return;e=ATON.Utils.resolveCollectionURL(e);let o=ATON.Utils.getBaseFolder(e),i=0;$.ajax({url:e,dataType:"text",success:function(e){e=e.split(/\r\n|\n/);for(let t in e){let r=e[t];if(!r.startsWith("#")){let e=r.split(/\s{2,}|\t/);if(e.length>10){let t=new ATON.XPF,r=o+e[0],n=parseFloat(e[1]),s=parseFloat(e[2]),a=parseFloat(e[3]),d=ATON.DEG2RAD*parseFloat(e[4]);ATON.DEG2RAD,parseFloat(e[5]),ATON.DEG2RAD,parseFloat(e[6]),t.setLocation(n,a,-s),t.setBaseLayer(r),t.setRotation(0,-d,0),x.add(t),i++}}}console.log("Num panoramas parsed: "+i),t&&t()}})}};const I=x;let F={init:()=>{F.list=[]},anyCopyrightFound:()=>F.list.length>0,extract:e=>{if(void 0===e)return;if(void 0===e.asset)return;let t={};if(e.asset.copyright&&(t.copyright=e.asset.copyright),e.asset.extras)for(let o in e.asset.extras)"string"==typeof e.asset.extras[o]&&(t[o]=e.asset.extras[o]);if(0!==Object.keys(t).length){e.asset.generator&&(t.generator=e.asset.generator);for(let e in F.list){let o=F.list[e];if(F.compare(t,o))return}F.list.push(t),console.log(t)}},compare:(e,t)=>{if(void 0===e||void 0===t)return!1;const o=Object.keys(e),i=Object.keys(t);if(o.length!==i.length)return!1;for(let i of o)if(e[i]!==t[i])return!1;return!0}};const U=F;let k={REST_API_CESIUMION_DEF_TOKEN:"https://api.cesium.com/v2/tokens/default",THRES_ORI:.01,THRES_POS:1e-6,init:()=>{k._tsets=[],k._tsET=20,k._tsB=!1,k._bTileBVH=!0,k._tsTasks=[],k.tsSchedCB=e=>{k._tsTasks.push(e)},k.estimateTSErrorTarget(),k._tsuSync=0,k._bPCs=!1,k._pqLRU=void 0,k._pqDownload=void 0,k._pqParse=void 0},clear:()=>{for(let e in k._tsets)k._tsets[e]=null;k._tsets=[],k._bPCs=!1},getTSetsErrorTarget:()=>k._tsET,setTSetsErrorTarget:e=>{k._tsET=e;const t=k._tsets.length;if(!(t<=0))for(let o=0;o<t;o++)k._tsets[o].errorTarget=e},setTSetsDisplayBounds:e=>{k._tsB=e;const t=k._tsets.length;if(!(t<=0))for(let o=0;o<t;o++)k._tsets[o].displayBoxBounds=e},updateTSetsCamera:e=>{void 0===e&&(e=ATON.Nav._camera);const t=k._tsets.length;if(!(t<=0))for(let o=0;o<t;o++){const t=k._tsets[o];for(let e=0;e<t.cameras.length;e++)t.deleteCamera(t.cameras[e]);t.setCamera(e),ATON._renderer.xr.isPresenting?t.setResolution(e,300,300):t.setResolutionFromRenderer(e,ATON._renderer)}},estimateTSErrorTarget:()=>{let e=8;(ATON.device.lowGPU||ATON.device.isMobile)&&(e+=4),ATON.XR._bPresenting&&(e+=3),e>25&&(e=25),console.log("Estimated TSet error target: "+e),k.setTSetsErrorTarget(e)},loadTileSetFromURL:(e,t,o)=>{if(void 0===t)return;let i=new TILES.TilesRenderer(e);if(!i)return;ATON._assetReqNew(e),i.displayBoxBounds=k._tsB,i.fetchOptions.mode="cors",o&&(i.fetchOptions.headers={},i.fetchOptions.headers.Authorization=`Bearer ${o.accessToken}`,i.preprocessURL=e=>(e=new URL(e),/^http/.test(e.protocol)&&e.searchParams.append("v",o.v),e.toString())),i.errorTarget=k._tsET,i.optimizeRaycast=!1,void 0===k._pqLRU?(i.lruCache.maxSize=500,i.lruCache.minSize=150,i.lruCache.unloadPercent=.2,i.downloadQueue.schedulingCallback=k.tsSchedCB,i.parseQueue.schedulingCallback=k.tsSchedCB,i.downloadQueue.maxJobs=6,i.parseQueue.maxJobs=1,k._pqLRU=i.lruCache,k._pqDownload=i.downloadQueue,k._pqParse=i.parseQueue):(i.lruCache=k._pqLRU,i.downloadQueue=k._pqDownload,i.parseQueue=k._pqParse),i.setCamera(ATON.Nav._camera),i.setResolutionFromRenderer(ATON.Nav._camera,ATON._renderer),i.manager.addHandler(/\.gltf$/,ATON._aLoader),i.manager.addHandler(/\.ktx2$/,ATON._ktx2Loader),t.add(i.group),$.getJSON(e,(e=>{ATON.CC.extract(e)}));let r=0,n=new THREE.Box3,s=new THREE.Sphere;const a=new THREE.Matrix4;let d=new THREE.Vector3,l=!1;i.onLoadTileSet=()=>{if(console.log("TileSet loaded"),o||t.bUseGeoCoords){let e;console.log("TileSet using GeoCoords"),i.getOrientedBounds(n,a)?(d.setFromMatrixPosition(a),e=d.length()):i.getBoundingSphere(s)&&(d=s.center.clone(),e=d.length());const t=d.normalize(),o=new THREE.Vector3(0,1,0),r=ATON.Utils.rotationBetweenDirections(t,o);i.group.quaternion.x=r.x,i.group.quaternion.y=r.y,i.group.quaternion.z=r.z,i.group.quaternion.w=r.w,i.group.position.y=-e}else i.getBounds(n)?(n.getBoundingSphere(s),t.autocenter&&(n.getCenter(i.group.position),i.group.position.multiplyScalar(-1))):i.getBoundingSphere(s)&&t.autocenter&&(i.group.position.copy(s.center),i.group.position.multiplyScalar(-1))},i.onLoadModel=o=>{r<2?r++:2===r&&(r++,ATON.recomputeSceneBounds(),void 0===ATON.Nav.homePOV&&ATON.Nav.computeAndRequestDefaultHome(.5),ATON._assetReqComplete(e)),o.traverse((e=>{if(e.layers.enable(t.type),e.isMesh?(e.castShadow=!0,e.receiveShadow=!0,k._bTileBVH&&e.geometry&&(e.geometry.computeBoundsTree({}),ATON.Utils._bvhBounds>0&&ATON.Utils._addBVHbounds(e,ATON.Utils._bvhBounds)),ATON._bqScene=!0):(l=!0,k._bPCs=!0,e.layers.disable(t.type),e.material=ATON.MatHub.materials.point),t.userData.cMat&&(e.material=t.userData.cMat),e.material){let t=e.material.map;t&&(t.minFilter=THREE.LinearMipmapLinearFilter,t.magFilter=THREE.LinearFilter,t.encoding=ATON._stdEncoding)}}))},i.onDisposeModel=(e,t)=>{ATON.Utils.cleanupVisitor(e),e=null},l||ATON.Utils.setPicking(t,t.type,!0),k._tsets.push(i)},loadCesiumIONAsset:(e,t)=>{let o=ATON.getAPIToken("cesium.ion");if(null==o&&(console.log("A valid Cesium ION token is required"),o=prompt("Please enter a valid Cesium ION token:"),null==o||""==o))return;let i=new URL(`https://api.cesium.com/v1/assets/${e}/endpoint`);i.searchParams.append("access_token",o),fetch(i,{mode:"cors"}).then((e=>e.ok?e.json():Promise.reject(`${e.status} : ${e.statusText}`))).then((e=>{i=new URL(e.url);const r=i.searchParams.get("v");k.loadTileSetFromURL(i.toString(),t,{accessToken:e.accessToken,v:r}),ATON.setAPIToken("cesium.ion",o)}))},update:()=>{const e=k._tsets.length;if(e<1)return;for(let t=0;t<e;t++)k._tsets[t].update();if(!k.canRequestRefinement())return;let t=k._tsTasks.shift();void 0!==t&&(t(),t=null)},canRequestRefinement:()=>!(ATON.Nav.isTransitioning()||ATON.Nav._dOri>k.THRES_ORI||ATON.Nav._dPos>k.THRES_POS)};const B=k;let q={};window.ATON=q,q.Node=t,q.POV=class{constructor(e){this.pos=new THREE.Vector3(1,0,0),this.target=new THREE.Vector3(0,0,0),this.up=ATON.STD_UPVECTOR,this.fov=void 0,this.nextPOV=void 0,this.prevPOV=void 0,this.as(e)}as(e){if(void 0!==e)return ATON.Nav.povlist[e]=this,this.id=e,this}setPosition(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this}setTarget(e,t,o){return e instanceof THREE.Vector3?this.target.copy(e):this.target.set(e,t,o),this}setFOV(e){return this.fov=e,this}addKeywords(e){let t=e.split(",");void 0===this.kwords&&(this.kwords={});for(let e in t){let o=t[e].trim();o.length>0&&(this.kwords[o]=!0)}return this}hasKeyword(e){if(void 0!==this.kwords)return void 0!==this.kwords[e]}setNextPOV(e){if(e)return this.nextPOV=e,this}setPrevPOV(e){if(e)return this.prevPOV=e,this}},q.LightProbe=class{constructor(e,t,o){this.pos=new THREE.Vector3(0,0,0),this._res=void 0!==e?e:64,this._near=void 0!==t?t:1,this._far=void 0!==o?o:ATON.Nav.STD_FAR,this._envtex=void 0,this._CC=void 0,void 0===ATON._pmremGenerator&&(ATON._pmremGenerator=new THREE.PMREMGenerator(ATON._renderer),ATON._pmremGenerator.compileCubemapShader())}setPosition(e,t,o){return e instanceof THREE.Vector3?this.pos.copy(e):this.pos.set(e,t,o),this}setNear(e){return this._near=e,this}setFar(e){return this._far=e,this}_createCCtarget(){this._CCtarget||(this._CCtarget=new THREE.WebGLCubeRenderTarget(this._res,{format:THREE.RGBEFormat,generateMipmaps:!0,minFilter:THREE.LinearMipmapLinearFilter,encoding:ATON._stdEncoding}))}update(){return this._envtex&&this._envtex.dispose(),ATON._rootVisibleGlobal.position.set(-this.pos.x,-this.pos.y,-this.pos.z),ATON._render(),this._envtex=ATON._pmremGenerator.fromScene(ATON._mainRoot,0,this._near,this._far).texture,ATON._rootVisibleGlobal.position.set(0,0,0),ATON._renderer.shadowMap.enabled&&ATON._dMainL&&(ATON._dMainL.shadow.needsUpdate=!0),this}getEnvTex(){return this._envtex}assignToNode(e){}},q.XPF=class{constructor(e){this.id=e,this._geom=void 0,this._mesh=void 0,this._pathbaselayer=void 0,this._size=20,this._location=new THREE.Vector3(0,0,0),this._rotation=new THREE.Vector3(0,0,0),this._lnode=ATON.Nav.addLocomotionNode(this._location),this._pathMod=void 0,this._semMasksURLs={},this._semHintURL=void 0}setSize(e){this._size=e}realizeSUI(){return void 0===this._lnode||this._lnode.realizeSUI(),this}realizeGeometry(){return void 0!==this._geom||(this._geom=new THREE.SphereBufferGeometry(1,60,60),this._geom.scale(-this._size,this._size,this._size),this._geom.castShadow=!1,this._geom.receiveShadow=!1,this._mat=new THREE.MeshBasicMaterial({depthTest:!1,depthWrite:!1}),this._mesh=new THREE.Mesh(this._geom,this._mat),this._mesh.frustumCulled=!1,this._mesh.renderOrder=-100),this}getMesh(){return this._mesh}getLocomotionNode(){return this._lnode}setRotation(e,t,o){return e instanceof THREE.Vector3?this._rotation.copy(e):this._rotation.set(e,t,o),void 0===this._mesh||this._mesh.rotation.copy(this._rotation),this}getRotation(){return this._rotation}setLocation(e,t,o){return e instanceof THREE.Vector3?this._location.copy(e):this._location.set(e,t,o),this._lnode&&this._lnode.setLocation(this._location),void 0===this._mesh||this._mesh.position.copy(this._location),this}getLocation(){return this._location}hasGeometry(){return void 0!==this._geom}setPathModifier=e=>(this._pathMod=e,this);updateBaseLayer(){}setBaseLayer(e){if(void 0===e)return this;this._pathbaselayer=ATON.Utils.resolveCollectionURL(e);let t=this;return this._pathMod&&(this._pathbaselayer=this._pathMod(this._pathbaselayer)),this.hasGeometry()?(ATON.Utils.isVideo(this._pathbaselayer)||ATON.Utils.textureLoader.load(t._pathbaselayer,(e=>{e.encoding=ATON._stdEncoding,e.generateMipmaps=!0,t._mat.map=e,t._mat.map.needsUpdate=!0,t._mat.needsUpdate=!0,console.log("XPF base layer "+t._pathbaselayer+" loaded")})),this):this}setSemanticMask(e,t){return void 0===e||(this._semMasksURLs[e]=ATON.Utils.resolveCollectionURL(t),ATON.XPFNetwork.updateCurrentXPFsemLayer(this)),this}removeSemanticMask(e){return void 0===e||(this._semMasksURLs[e]=void 0,ATON.XPFNetwork.updateCurrentXPFsemLayer(this)),this}removeAllSemanticMasks(){return this._semMasksURLs={},this}getSemanticMaskURL(e){return this._semMasksURLs[e]}setSemanticHintMap(e){return void 0===e||(this._semHintURL=ATON.Utils.resolveCollectionURL(e),ATON.XPFNetwork.updateCurrentXPFsemLayer(this)),this}removeSemanticHintMap(){return this._semHintURL=void 0,ATON.XPFNetwork.updateCurrentXPFsemLayer(this),this}},q.EventHub=i,q.Utils=a,q.CC=U,q.SceneHub=l,q.MatHub=n,q.Nav=T,q.AudioHub=u,q.XR=v,q.SUI=O,q.UI=A,q.VRoadcast=E,q.SemFactory=f,q.FE=b,q.MediaRec=y,q.GeoLoc=C,q.App=H,q.FX=V,q.XPFNetwork=I,q.MRes=B,q.STD_UPVECTOR=new THREE.Vector3(0,1,0),q.ROOT_NID=".",q.RAD2DEG=180/Math.PI,q.DEG2RAD=Math.PI/180,q.PATCH_ADD=0,q.PATCH_DEL=1,q.NTYPES={},q.NTYPES.SCENE=3,q.NTYPES.SEM=4,q.NTYPES.UI=5,q.BASE_URL=window.location.origin,q.PATH_RESTAPI=`${q.BASE_URL}/api/`,q.PATH_RESTAPI_SCENE=`${q.PATH_RESTAPI}scene/`,q.PATH_WAPPS=`${q.BASE_URL}/a/`,q.PATH_MODS=`${q.BASE_URL}/mods/`,q.PATH_DRACO_LIB=`${q.BASE_URL}/dist/draco/`,q.PATH_BASIS_LIB=`${q.BASE_URL}/dist/basis/`,q.PATH_IFC_LIB="ifc/",q.PATH_COLLECTION=`${q.BASE_URL}/collections/`,q.PATH_SCENES=`${q.BASE_URL}/scenes/`,q.PATH_RES=`${q.BASE_URL}/res/`,q.PATH_FE=`${q.BASE_URL}/s/`,q.SHADOWS_NEAR=.1,q.SHADOWS_FAR=50,q.SHADOWS_SIZE=15,q.SHADOWS_RES=1024,q.AMB_L=.2,q.setPathCollection=e=>{q.PATH_COLLECTION=e},q.setPathScenes=e=>{q.PATH_SCENES=e},q._onUserInteraction=()=>{q._elPanoVideo&&!q._vpanoPlaying&&q._elPanoVideo.play(),q.XPFNetwork._elVid&&!q.XPFNetwork._vidPlaying&&q.XPFNetwork._elVid.play(),q.AudioHub._listener&&q.AudioHub._listener.context&&"suspended"===q.AudioHub._listener.context.state&&q.AudioHub._listener.context.resume()},q.checkAuth=(e,t)=>{$.ajax({type:"GET",url:q.PATH_RESTAPI+"user",xhrFields:{withCredentials:!0},dataType:"json",success:o=>{void 0!==o?e(o):t()},error:()=>{t&&t()}})},q._setupBaseListeners=()=>{let e=q._renderer.domElement;window.addEventListener("resize",q._onResize,!1),window.onorientationchange=q._readDeviceOrientationMode,screenfull.isEnabled&&screenfull.on("change",(()=>{q._bFS=screenfull.isFullscreen,q.fireEvent("Fullscreen",q._bFS),q._bFS?console.log("Now fullscreen"):console.log("Exit fullscreen")})),e.addEventListener("mousemove",q._updateScreenMove,!1),e.addEventListener("mousedown",(e=>{1===e.button&&q.fireEvent("MouseMidButton"),2===e.button&&q.fireEvent("MouseRightButton")})),e.addEventListener("wheel",q._onMouseWheel,!1),q._bPointerDown=!1,Hammer(e).on("doubletap",(e=>{q._bPointerDown=!1,q._onUserInteraction(),q.fireEvent("DoubleTap",e.srcEvent)})),Hammer(e).on("tap",(e=>{if(q._bPointerDown=!1,q._onUserInteraction(),q._updateScreenMove(e.srcEvent),q._handleQueries(),q.fireEvent("Tap",e.srcEvent),void 0===q._hoveredUI)return;let t=q.getUINode(q._hoveredUI);t&&t.onSelect&&t.onSelect()})),q.on("DoubleTap",(e=>{q.defaultDoubleTapFromScreenCoords(e)})),q._kModShift=!1,q._kModCtrl=!1,q._bListenKeyboardEvents=!0,window.addEventListener("keydown",(e=>{q._onUserInteraction(),"Shift"===e.key&&(q._kModShift=!0),"Control"===e.key&&(q._kModCtrl=!0),q._bListenKeyboardEvents&&q.fireEvent("KeyPress",e.key)}),!1),window.addEventListener("keyup",(e=>{"Shift"===e.key&&(q._kModShift=!1),"Control"===e.key&&(q._kModCtrl=!1),q._bListenKeyboardEvents&&q.fireEvent("KeyUp",e.key)}),!1),q.on("KeyPress",(e=>{if("+"===e){let e=q.Nav.getFOV()+1;q.Nav.setFOV(e)}if("-"===e){let e=q.Nav.getFOV()-1;q.Nav.setFOV(e)}}))},q._onResize=()=>{if(q.Nav._camera.aspect=window.innerWidth/window.innerHeight,q.Nav._camera.updateProjectionMatrix(),q._renderer.setSize(window.innerWidth,window.innerHeight),q.FX.composer&&(q.FX.composer.setSize(window.innerWidth,window.innerHeight),q.FX.passes[q.FX.PASS_AA])){let e=q.FX.passes[q.FX.PASS_AA].material.uniforms;e&&e.resolution.value.set(1/window.innerWidth,1/window.innerHeight)}console.log("onResize")},q._onMouseWheel=e=>{e.preventDefault(),q.fireEvent("MouseWheel",e.deltaY)},q.focusOn3DView=()=>{q._renderer.domElement.focus()},q._SUIactivation=()=>{const e=q.getUINode(q._hoveredUI);return void 0!==e&&void 0!==e.onSelect&&(e.onSelect(),!0)},q._stdActivation=()=>{if(q._SUIactivation())return;if(!q.Nav._bControl)return;if(void 0!==q.XPFNetwork._semCurr&&q.fireEvent("SemanticMaskSelect",q.XPFNetwork._semCurr),q.XR._bPresenting){if(T.requestTransitionToLocomotionNodeInSightIfAny(q.XR.STD_TELEP_DURATION))return;return"immersive-vr"===q.XR._sessionType&&q.XR.teleportOnQueriedPoint(),void q.FE.playAudioFromSemanticNode(q._hoveredSemNode)}if(q.Nav.isFirstPerson()||q.Nav.isDevOri()){if(T.requestTransitionToLocomotionNodeInSightIfAny(.5))return;if(q.Nav.currentQueryValidForLocomotion()){let e=q._queryDataScene.p,t=q.Nav._vDir,o=new THREE.Vector3(e.x,e.y+q.userHeight,e.z),i=new THREE.Vector3(o.x+t.x,o.y+t.y,o.z+t.z),r=(new q.POV).setPosition(o).setTarget(i).setFOV(q.Nav._currPOV.fov);q.Nav.requestPOV(r,.5)}return}let e=q.getSemanticNode(q._hoveredSemNode);q._queryDataSem&&e?q.Nav.requestPOVbyNode(e,.5):q._queryDataScene&&q.Nav.requestRetarget(q._queryDataScene.p,void 0,.5)},q.defaultDoubleTapFromScreenCoords=e=>{q._updateScreenMove(e),q._handleQueryScene(),q._stdActivation()},q.isFullscreen=()=>q._bFS,q.toggleFullScreen=()=>{screenfull.toggle()},q.realize=e=>{console.log("Initialize ATON..."),q.Utils.init(),q.Utils.profileDevice(),q._clock=new THREE.Clock(!0),q.bounds=new THREE.Sphere,q._worldScale=1,q._bFS=!1,q._renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),q._renderer.setSize(window.innerWidth,window.innerHeight),q.Utils.profileRenderingCapabilities(),q._stdpxd=1,q._renderer.setPixelRatio(q._stdpxd),q._fps=60,q._dt=.01,q._dtAccum=0,q._avgFPScount=0,q._avgFPSaccum=0,q._avgFPS=60,q._bDynamicDensity=!0,q._dRenderBudgetMinFPS=20,q._dRenderBudgetMaxFPS=55,q._aniMixers=[],q._stdEncoding=THREE.LinearEncoding,q._renderer.outputEncoding=q._stdEncoding,q._renderer.toneMapping=THREE.LinearToneMapping,q._renderer.toneMappingExposure=1,e||q._renderer.setAnimationLoop(q._onFrame),q._maxAnisotropy=q._renderer.capabilities.getMaxAnisotropy(),q.userHeight=1.7,e||document.body.appendChild(q._renderer.domElement);let t=q._renderer.domElement;t.id="idView3D",t.style.outline="none",t.style.border="none",q.UI.init(),q._vpanoPlaying=!1,q._bUserInts=0,q.EventHub.init(),q.MatHub.init(),q._assetsManager={},q._aLoader=new THREE.GLTFLoader,q._numReqLoad=0,q._collMod=void 0,q._ktx2Loader=new THREE.KTX2Loader,q._ktx2Loader.setTranscoderPath(q.PATH_BASIS_LIB),q._ktx2Loader.detectSupport(q._renderer),q._dracoLoader=new THREE.DRACOLoader,q._dracoLoader.setDecoderPath(q.PATH_DRACO_LIB),q._dracoLoader.setWorkerLimit(2),q._dracoLoader.preload(),q._aLoader.setDRACOLoader(q._dracoLoader),q._aLoader.setKTX2Loader(q._ktx2Loader),THREE.DefaultLoadingManager.addHandler(/\.ktx2$/,q._ktx2Loader),q._updRoutines=[],q._pmremGenerator=void 0,q._lps=[],q._bAutoLP=!1,q._envMapInt=1,q._numLPbounces=2,q._lpbCount=0,q._bShadowsFixedBound=!1,q._shadowsFixedBoundCenter=void 0,q._shadowsNear=q.SHADOWS_NEAR,q._shadowsFar=q.SHADOWS_FAR,q._shadowsSize=q.SHADOWS_SIZE,q._shadowsRes=q.SHADOWS_RES,q.initGraphs(),q.SceneHub.init(),q.MRes.init(),q.CC.init(),q.AudioHub.init(),q.Nav.init(),q.XR.init(),q.SUI.init(),q.VRoadcast.init(),q.MediaRec.init(),q.SemFactory.init(),q.App.init(),q.GeoLoc.init(),q.XPFNetwork.init(),q.device.lowGPU||q.device.isMobile||q.FX.init(),q.FX.composer||(q._render=()=>{q._renderer.render(q._mainRoot,q.Nav._camera)}),q._queryDataScene=void 0,q._queryDataSem=void 0,q._queryDataUI=void 0,q._hoveredSemNode=void 0,q._hoveredUI=void 0,q._bq=!0,q._bQuerySemOcclusion=!0,q._bQueryNormals=!0,q._bPauseQuery=!1,q._bCenteredQuery=!1,q._bqScene=!1,q._bqSem=!1,q._qSync=0,q._qSyncInt=1,q._tgiDur=void 0,q._tgiPer=void 0,q._tHover=void 0,q._bMainPanoInfinite=!0,q._matMainPano=void 0,q._mMainPano=void 0,q._screenPointerCoords=new THREE.Vector2(0,0),q._rcScene=new THREE.Raycaster,q._rcScene.layers.set(q.NTYPES.SCENE),q._rcScene.firstHitOnly=!0,q._rcSemantics=new THREE.Raycaster,q._rcSemantics.layers.set(q.NTYPES.SEM),q._rcSemantics.firstHitOnly=!0,q._rcUI=new THREE.Raycaster,q._rcUI.layers.set(q.NTYPES.UI),q._rcUI.firstHitOnly=!0,q._setupBaseListeners(),q.device.isMobile&&q._readDeviceOrientationMode(),q._gizmo=void 0,q._bGizmo=!1,q.focusOn3DView()},q.setCollectionPathModifier=e=>{q._collMod=e},q.setTimedGazeDuration=e=>{q._tgiDur=e},q.getTimedGazeProgress=()=>{if(void 0!==q._tgiDur)return q._tgiPer},q.getElapsedTime=()=>q._clock.elapsedTime,q.renderPause=()=>{q._renderer.setAnimationLoop(void 0)},q.renderResume=()=>{q._renderer.setAnimationLoop(q._onFrame)},q._setupLoadManager=()=>{q._loadManager=new THREE.LoadingManager,q._loadManager.onStart=(e,t,o)=>{console.log("Started loading file: "+e+".\nLoaded "+t+" of "+o+" files."),q.fireEvent("NodeRequestFired",e)},q._loadManager.onLoad=()=>{console.log("Loading complete!"),q.fireEvent("AllNodeRequestsCompleted")},q._loadManager.onProgress=(e,t,o)=>{},q._loadManager.onError=e=>{console.log("There was an error loading "+e)}},q.setDefaultPixelDensity=e=>{q._stdpxd=e,q._renderer.setPixelRatio(e),q.FX.composer&&q.FX.composer.setPixelRatio(e),void 0!==q._renderer.xr&&(q.device.isMobile?q._renderer.xr.setFramebufferScaleFactor(q._stdpxd*q.XR.MOBILE_DENSITY_F):q._renderer.xr.setFramebufferScaleFactor(q._stdpxd))},q.resetPixelDensity=()=>{q._renderer.setPixelRatio(q._stdpxd)},q._readDeviceOrientationMode=()=>{90===Math.abs(window.orientation)?(console.log("Landscape Mode"),q.fireEvent("MobileLandscapeMode")):(console.log("Portrait Mode"),q.fireEvent("MobilePortraitMode")),setTimeout(q._onResize,500)},q.snodes={},q.semnodes={},q.uinodes={},q.createSceneNode=e=>new q.Node(e,q.NTYPES.SCENE),q.getSceneNode=e=>{if(void 0!==e)return q.snodes[e]},q.getOrCreateSceneNode=e=>{let t=q.getSceneNode(e);return void 0!==t?t:q.createSceneNode(e)},q.getRootScene=()=>q._rootVisible,q.createSemanticNode=e=>new q.Node(e,q.NTYPES.SEM),q.getSemanticNode=e=>{if(void 0!==e)return q.semnodes[e]},q.getOrCreateSemanticNode=e=>{let t=q.getSemanticNode(e);return void 0!==t?t:q.createSemanticNode(e)},q.getRootSemantics=()=>q._rootSem,q.createUINode=e=>new q.Node(e,q.NTYPES.UI),q.getUINode=e=>{if(void 0!==e)return q.uinodes[e]},q.getRootUI=()=>q._rootUI,q.setWorldScale=e=>{q._rootVisible.scale.set(e,e,e),q._rootSem.scale.set(e,e,e),q._worldScale=e},q.getWorldScale=()=>q._worldScale,q._assetReqNew=e=>{q._numReqLoad++,q.fireEvent("NodeRequestFired",e)},q._assetReqComplete=e=>{q.fireEvent("NodeRequestCompleted",e),q._numReqLoad--,q._numReqLoad<=0&&q._onAllReqsCompleted()},q._onAllReqsCompleted=()=>{q.recomputeSceneBounds(),q.getRootScene().assignLightProbesByProximity(),q.fireEvent("AllNodeRequestsCompleted"),q._postAllReqsCompleted(),setTimeout((()=>{q.updateLightProbes(),q._renderer.shadowMap.enabled&&q._bShadowsFixedBound&&0===q._aniMixers.length&&(q._dMainL.shadow.autoUpdate=!1,console.log("Lazy shadows"))}),1e3)},q._postAllReqsCompleted=e=>{void 0===e&&(e=q._rootVisible);for(let t in e.children){let o=e.children[t];o&&o.toggle&&(q._postAllReqsCompleted(o),o.toggle(o.visible))}},q.recomputeSceneBounds=e=>{e?q.bounds.union(e):(q.bounds.center.copy(q._rootVisible.getBound().center),q.bounds.radius=q._rootVisible.getBound().radius),console.log(q.bounds),q.bounds.radius<=0||(q._renderer.shadowMap.enabled&&(q._rootVisible.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),q.adjustShadowsParamsFromSceneBounds(),q._bShadowsFixedBound&&q.updateDirShadows()),q._bAutoLP&&(void 0===q._lps[0]?q.addLightProbe((new q.LightProbe).setPosition(q.bounds.center).setNear(q.bounds.radius)):q._lps[0].setPosition(q.bounds.center).setNear(q.bounds.radius),console.log("Auto LP")),q.FX.composer&&q.FX.setDOFaperture(1/(30*q.bounds.radius)),q._mMainPano&&q._mMainPano.position.copy(q.bounds.center))},q.registerNodeResourceHandler=(e,t)=>{q._resHandler||(q._resHandler={}),q._resHandler[e]=t,console.log("Registered handler for extension: "+e)},q.initGraphs=()=>{q._mainRoot=new THREE.Scene,q._mainRoot.background=new THREE.Color(.7,.7,.7),q._rootVisibleGlobal=new THREE.Scene,q._mainRoot.add(q._rootVisibleGlobal),q._rootVisible=q.createSceneNode().setAsRoot(),q._rootVisibleGlobal.add(q._rootVisible),q._rootSem=q.createSemanticNode().setAsRoot(),q._mainRoot.add(q._rootSem),q._rootUI=q.createUINode().setAsRoot(),q._mainRoot.add(q._rootUI),q.ambLight=new THREE.AmbientLight(new THREE.Color(1,1,1)),q._rootVisibleGlobal.add(q.ambLight),q.plight=new THREE.PointLight,q.plight.intensity=0,q._rootVisibleGlobal.add(q.plight)},q.enablePointLight=()=>{q.plight.intensity=2},q.disablePointLight=()=>{q.plight.intensity=0},q.setBackgroundColor=e=>{q._mainRoot.background=e},q.setFog=(e,t)=>{void 0!==e&&(void 0===t&&(t=200),q._rootVisibleGlobal.fog=new THREE.Fog(e,1,t),q.setBackgroundColor(e))},q.disableFog=()=>{q._rootVisibleGlobal.fog=null},q.setAutoLP=e=>{q._bAutoLP=e},q.setNeutralAmbientLight=e=>{q.ambLight.color=new THREE.Color(e,e,e)},q.addLightProbe=e=>{void 0!==e&&(q._lps.push(e),q.setNeutralAmbientLight(0),void 0!==q.SUI.gLPIcons&&O.addLPIcon(e))},q.getNumLightProbes=()=>q._lps.length,q._updLP=()=>{for(let e in q._lps)q._lps[e].update();q._rootVisible.traverse((e=>{let t=e.userData.LP;void 0!==t&&t instanceof q.LightProbe&&(e.material.envMap=t.getEnvTex(),e.material.envMapIntensity=q._envMapInt,e.material.needsUpdate=!0)}))},q.setLightProbesNumBounces=e=>{e<1||(q._numLPbounces=e)},q.dirtyLightProbes=e=>{void 0===e&&(e=q._numLPbounces),q._lpbCount=e},q.updateLightProbes=()=>{if(!q.XR._bPresenting&&0!==q._lps.length){for(let e=0;e<q._numLPbounces;e++)q._updLP();console.log("LPs updated.")}},q.setMainPanorama=e=>{let t;if(e=q.Utils.resolveCollectionURL(e),void 0===q._mMainPano&&(q._gMainPano=new THREE.SphereBufferGeometry(1,60,60),q._gMainPano.castShadow=!1,q._gMainPano.receiveShadow=!1,q._mMainPano=new THREE.Mesh(q._gMainPano,q._matMainPano),q._mMainPano.frustumCulled=!1,q._mMainPano.renderOrder=-100,q._mMainPano.layers.disable(q.NTYPES.SCENE),q._mMainPano.layers.disable(q.NTYPES.SEM),q._mMainPano.layers.disable(q.NTYPES.UI),q.setMainPanoramaRadius(.8*q.Nav.STD_FAR)),q.Utils.isVideo(e)){if(void 0===q._elPanoVideo){let t="<video id='idPanoVideo' loop crossOrigin='anonymous' playsinline style='display:none'>";e.endsWith("mp4")&&(t+="<source src='"+e+"' type='video/mp4'>"),e.endsWith("webm")&&(t+="<source src='"+e+"' type='video/webm'>"),t+="</video>",$(t).appendTo("body"),q._elPanoVideo=document.getElementById("idPanoVideo"),q._elPanoVideo.onplaying=()=>{console.log("VideoPano playing"),q._vpanoPlaying=!0},q._elPanoVideo.onpause=()=>{console.log("VideoPano paused"),q._vpanoPlaying=!1},q._elPanoVideo.addEventListener("touchstart",(function(){q._elPanoVideo.play()})),enableInlineVideo(q._elPanoVideo)}t=new THREE.VideoTexture(q._elPanoVideo),t.encoding=q._stdEncoding,q._realizeOrUpdateMainPano(t),q.fireEvent("MainPanoVideo")}else{if(e.endsWith(".hdr"))return void(new THREE.RGBELoader).load(e,(e=>{e.minFilter=THREE.LinearMipmapLinearFilter,e.magFilter=THREE.LinearFilter,e.encoding=q._stdEncoding,q._realizeOrUpdateMainPano(e),q.fireEvent("MainPanoHDR")}));if(e.endsWith(".exr"))return void(new THREE.EXRLoader).load(e,(e=>{e.minFilter=THREE.LinearMipmapLinearFilter,e.magFilter=THREE.LinearFilter,e.encoding=q._stdEncoding,q._realizeOrUpdateMainPano(e),q.fireEvent("MainPanoHDR")}));q.Utils.textureLoader.load(e,(e=>{e.encoding=q._stdEncoding,e.generateMipmaps=!0,q._realizeOrUpdateMainPano(e),q.fireEvent("MainPano")}))}},q.playMainPanorama=()=>{q._elPanoVideo&&(q._vpanoPlaying||q._elPanoVideo.play())},q.pauseMainPanorama=()=>{q._elPanoVideo&&q._vpanoPlaying&&q._elPanoVideo.pause()},q.playOrPauseMainPanorama=()=>{q._elPanoVideo&&(q._vpanoPlaying?q._elPanoVideo.pause():q._elPanoVideo.play())},q._realizeOrUpdateMainPano=e=>{if(void 0!==q._matMainPano)return q._matMainPano.map=e,void q.updateLightProbes();q._matMainPano=new THREE.MeshBasicMaterial({map:e,depthTest:!1,depthWrite:!1}),q._mMainPano.material=q._matMainPano,q._bMainPanoInfinite&&(q._mMainPano.onAfterRender=()=>{q.Nav._currPOV&&q._mMainPano.position.copy(q.Nav._currPOV.pos)}),q._rootVisibleGlobal.add(q._mMainPano),q.updateLightProbes()},q.setMainPanoramaRadius=e=>{void 0!==q._gMainPano&&q._gMainPano.scale(-e,e,e)},q.setMainPanoramaRotation=e=>{void 0!==q._mMainPano&&q._mMainPano.rotation.set(0,e,0)},q.setMainPanoramaInfinite=e=>{q._bMainPanoInfinite=e,void 0!==q._mMainPano&&(q._mMainPano.onAfterRender=e?()=>{q.Nav._currPOV&&q._mMainPano.position.copy(q.Nav._currPOV.pos)}:void 0)},q.setMainPanoramaLocation=e=>{q._bMainPanoInfinite||void 0!==q._mMainPano&&q._mMainPano.position.copy(e)},q.setMainLightDirection=e=>{let t=e.clone();t.normalize(),t.x*=.5*q.SHADOWS_FAR,t.y*=.5*q.SHADOWS_FAR,t.z*=.5*q.SHADOWS_FAR,void 0===q._dMainL&&(q._dMainL=new THREE.DirectionalLight(new THREE.Color(1,1,1),1),q._dMainL.castShadow=!1,q._dMainLtgt=new THREE.Object3D,q._rootVisibleGlobal.add(q._dMainLtgt),q._dMainL.target=q._dMainLtgt,q._rootVisibleGlobal.add(q._dMainL),q._dMainLpos=new THREE.Vector3),q._dMainLdir=t,q._dMainL.position.set(-t.x,-t.y,-t.z),q._renderer.shadowMap.enabled&&(q._dMainL.shadow.needsUpdate=!0),q.toggleMainLight(!0)},q.getMainLightDirection=()=>{if(void 0===q._dMainLdir)return;let e=q._dMainLdir.clone();return e.normalize(),e},q.toggleMainLight=e=>{if(void 0===q._dMainL)return;q._dMainL.visible=e;let t=q._lps.length;e?(t>0?q.setNeutralAmbientLight(0):q.setNeutralAmbientLight(q.AMB_L),q.updateDirShadows()):(t>0&&q.setNeutralAmbientLight(0),q.setNeutralAmbientLight(1))},q.isMainLightEnabled=()=>void 0!==q._dMainL&&!!q._dMainL.visible,q.setExposure=e=>{q._renderer.toneMappingExposure=e},q.getExposure=()=>q._renderer.toneMappingExposure,q.adjustShadowsParamsFromSceneBounds=()=>{if(void 0===q._dMainL)return;let e=q._rootVisible.getBound().radius,t=q._rootVisible.getBound().center;e<=0||e>=q.SHADOWS_SIZE?(q._bShadowsFixedBound=!1,q._shadowsSize=q.SHADOWS_SIZE):(q._bShadowsFixedBound=!0,q._shadowsFixedBoundCenter=t,q._shadowsSize=1.5*e),q._dMainL.shadow.map&&(q._dMainL.shadow.map.dispose(),q._dMainL.shadow.map=null),q._dMainL.shadow.camera.left=-q._shadowsSize,q._dMainL.shadow.camera.right=q._shadowsSize,q._dMainL.shadow.camera.bottom=-q._shadowsSize,q._dMainL.shadow.camera.top=q._shadowsSize,q._dMainL.shadow.mapSize.width=q._shadowsRes,q._dMainL.shadow.mapSize.height=q._shadowsRes,q._dMainL.shadow.camera.near=q._shadowsNear,q._dMainL.shadow.camera.far=q._shadowsFar;let o=-2e-4*e;o<-.001&&(o=-.001),q._dMainL.shadow.bias=o},q.toggleShadows=e=>{if(void 0!==q._dMainL)if(e){if(q.XR.isPresenting())return;q._dMainL.castShadow=!0,q._renderer.shadowMap.enabled=!0,q.device.isMobile?q._renderer.shadowMap.type=THREE.PCFShadowMap:q._renderer.shadowMap.type=THREE.PCFSoftShadowMap,q._rootVisible.traverse((e=>{e.isMesh&&(e.castShadow=!0,e.receiveShadow=!0)})),q.adjustShadowsParamsFromSceneBounds(),q.updateDirShadows(),q._dMainL.shadow.needsUpdate=!0,console.log("Shadows ON")}else q._dMainL.castShadow=!1,q._renderer.shadowMap.enabled=!1,console.log("Shadows OFF")},q.updateDirShadows=()=>{if(void 0===q._dMainLdir)return;if(void 0===q._dMainLpos)return;let e=q._shadowsFixedBoundCenter;void 0===e?(e=q.Nav.getCurrentEyeLocation(),q._dMainLpos.x=e.x+q.Nav._vDir.x*q._shadowsSize,q._dMainLpos.y=e.y+q.Nav._vDir.y*q._shadowsSize,q._dMainLpos.z=e.z+q.Nav._vDir.z*q._shadowsSize):(q._dMainLpos.x=e.x,q._dMainLpos.y=e.y,q._dMainLpos.z=e.z),q._dMainL.position.set(q._dMainLpos.x-q._dMainLdir.x,q._dMainLpos.y-q._dMainLdir.y,q._dMainLpos.z-q._dMainLdir.z),q._dMainLtgt.position.copy(q._dMainLpos)},q._updateEnvironment=()=>{q._renderer.shadowMap.enabled&&(q._bShadowsFixedBound||q.updateDirShadows())},q.setGlobalAudio=(e,t)=>{void 0!==e&&(void 0===t&&(t=!0),e=q.Utils.resolveCollectionURL(e),void 0===q._auMain||null===q._auMain?q._auMain=new THREE.Audio(q.AudioHub._listener):q._auMain.isPlaying&&q._auMain.stop(),q.AudioHub._loader.load(e,(e=>{q._auMain.setBuffer(e),q._auMain.setLoop(t),q._auMain.play()})))},q._markFPS=()=>{if(q._numReqLoad>0)return;if(q._dt<0)return;const e=1/q._dt;q._avgFPScount+=1,q._dtAccum+=q._dt,q._avgFPSaccum+=e,q._dtAccum<1||(q._fps=q._avgFPSaccum/q._avgFPScount,q._avgFPSaccum=0,q._avgFPScount=0,q._dtAccum=0,q._handleDynamicRenderProfiles())},q.toggleDynamicDensity=e=>{q._bDynamicDensity=e},q.setDynamicRenderingFPS=(e,t)=>{e>=t||(e&&(q._dRenderBudgetMinFPS=e),t&&(q._dRenderBudgetMaxFPS=t))},q._handleDynamicRenderProfiles=()=>{let e=q._renderer.getPixelRatio();q._fps<q._dRenderBudgetMinFPS&&(q._bDynamicDensity&&(e-=.1,e>=.3&&(q._renderer.setPixelRatio(e),q.FX.composer&&q.FX.composer.setPixelRatio(e),console.log("Density: "+e.toPrecision(2)))),q.fireEvent("RequestLowerRender")),q._fps>q._dRenderBudgetMaxFPS&&(q._bDynamicDensity&&(e+=.1,e<=1.5&&(q._renderer.setPixelRatio(e),q.FX.composer&&q.FX.composer.setPixelRatio(e),console.log("Density: "+e.toPrecision(2)))),q.fireEvent("RequestHigherRender"))},q._onFrame=()=>{q._dt=q._clock.getDelta(),q._markFPS(),q.XR._bPresenting?q.XR.update():q.Nav._controls.update(q._dt),q._handleQueries(),q.Nav.update(),q.VRoadcast.update(),q.SUI.update(),q.MatHub.update(),q._updateEnvironment(),q._updateAniMixers(),q._updateRoutines(),q.MRes.update(),q.XPFNetwork.update(),q._render()},q._render=()=>{!q.FX.composer||q.XR._bPresenting?q._renderer.render(q._mainRoot,q.Nav._camera):q.FX.composer.render()},q.addUpdateRoutine=e=>{void 0!==e&&q._updRoutines.push(e)},q.deleteAllUpdateRoutines=()=>{q._updRoutines=[]},q._updateRoutines=()=>{let e=q._updRoutines.length;if(!(e<=0))for(let t=0;t<e;t++)q._updRoutines[t]()},q._updateAniMixers=()=>{let e=q._aniMixers.length;if(!(e<1))for(let t=0;t<e;t++)q._aniMixers[t].update(q._dt)},q._updateScreenMove=e=>{e.preventDefault&&e.preventDefault(),q._bCenteredQuery||(q._screenPointerCoords.x=e.clientX/window.innerWidth*2-1,q._screenPointerCoords.y=-e.clientY/window.innerHeight*2+1)},q.toggleCenteredQuery=e=>{q._bCenteredQuery=e,e&&(q._screenPointerCoords.x=0,q._screenPointerCoords.y=0)},q.toggleQueries=e=>{q._bq=e},q._registerRCS=()=>{q._rcRR=0,q._rcHandlers=[],q._rcHandlers.push(q._handleQueryScene),q._rcHandlers.push(q._handleQuerySemantics),q._rcHandlers.push(q._handleQueryUI)},q._handleQueries=()=>{if(!q._bq)return;if(q._bPauseQuery)return;if(q.Nav._bInteracting)return;if(q._numReqLoad>0)return;if(q.Nav.isTransitioning())return;if(q._handleQueryUI(),q._bqScene&&q._handleQueryScene(),q._bqSem&&q._handleQuerySemantics(),q.Nav._bLocValidator&&q.Nav.locomotionValidator(),void 0===q._tgiDur)return;if(void 0===q._tHover)return;const e=q._clock.elapsedTime-q._tHover;e>=q._tgiDur?(q._stdActivation(),q._tHover=void 0,q._tgiPer=void 0):q._tgiPer=e/q._tgiDur},q._handleQueryScene=()=>{if(q.XR.isPresenting()?q.XR.setupQueryRay(q._rcScene):q._rcScene.setFromCamera(q._screenPointerCoords,q.Nav._camera),q._hitsScene=[],q._rcScene.intersectObjects(q._mainRoot.children,!0,q._hitsScene),q._hitsScene.length<=0)return void(q._queryDataScene=void 0);const e=q._hitsScene[0];q._queryDataScene={},q._queryDataScene.p=e.point,q._queryDataScene.d=e.distance,q._queryDataScene.o=e.object,q._queryDataScene.uv=e.uv,q._bQueryNormals&&e.face&&e.face.normal&&(q._queryDataScene.matrixWorld=(new THREE.Matrix3).getNormalMatrix(e.object.matrixWorld),q._queryDataScene.n=e.face.normal.clone().applyMatrix3(q._queryDataScene.matrixWorld).normalize())},q.getSceneFocalPoint=()=>{if(void 0===q._queryDataScene)return;let e=q._queryDataScene.p,t=new THREE.Vector3;return t.lerpVectors(e,q.Nav._currPOV.pos,.02),t},q.getSceneQueriedPoint=()=>{if(void 0!==q._queryDataScene)return q._queryDataScene.p},q.getSceneQueriedDistance=()=>{if(void 0!==q._queryDataScene)return q._queryDataScene.d},q.getSceneQueriedNormal=()=>{if(void 0!==q._queryDataScene)return q._queryDataScene.n},q.setQueryRange=(e,t,o)=>{void 0!==o&&o!==q.NTYPES.SCENE||(q._rcScene.near=e,q._rcScene.far=t),void 0!==o&&o!==q.NTYPES.SEM||(q._rcSemantics.near=e,q._rcSemantics.far=t)},q._handleQuerySemantics=()=>{if(q.XR.isPresenting()?q.XR.setupQueryRay(q._rcSemantics):q._rcSemantics.setFromCamera(q._screenPointerCoords,q.Nav._camera),q._hitsSem=[],q._rcSemantics.intersectObjects(q._mainRoot.children,!0,q._hitsSem),q._hitsSem.length<=0){if(q._queryDataSem=void 0,q._hoveredSemNode){q.fireEvent("SemanticNodeLeave",q._hoveredSemNode);let e=q.getSemanticNode(q._hoveredSemNode);e&&e.onLeave&&e.onLeave()}return q._hoveredSemNode=void 0,void(q._tHover=void 0)}const e=q._hitsSem[0];if(q._bQuerySemOcclusion&&q._queryDataScene&&q._queryDataScene.d<e.distance){if(q._queryDataSem=void 0,q._hoveredSemNode){q.fireEvent("SemanticNodeLeave",q._hoveredSemNode);let e=q.getSemanticNode(q._hoveredSemNode);e&&e.onLeave&&e.onLeave()}return q._hoveredSemNode=void 0,void(q._tHover=void 0)}q._queryDataSem={},q._queryDataSem.p=e.point,q._queryDataSem.d=e.distance,q._queryDataSem.o=e.object,q._queryDataSem.list=[];const t=q._queryDataSem.list;let o=e.object.parent;for(;o;)o.nid&&o.nid!==q.ROOT_NID&&t.push(o.nid),o=o.parent;const i=t[0];if(i&&q._hoveredSemNode!==i){if(q._hoveredSemNode){q.fireEvent("SemanticNodeLeave",q._hoveredSemNode);let e=q.getSemanticNode(q._hoveredSemNode);e&&e.onLeave&&e.onLeave(),q._tHover=void 0}q._hoveredSemNode=i,q.fireEvent("SemanticNodeHover",i);let e=q.getSemanticNode(i);e&&e.onHover&&e.onHover(),q._tHover=q._clock.elapsedTime}},q._handleQueryUI=()=>{if(q.XR.isPresenting()?q.XR.setupQueryRay(q._rcUI):q._rcUI.setFromCamera(q._screenPointerCoords,q.Nav._camera),q._hitsUI=[],q._rcUI.intersectObjects(q._mainRoot.children,!0,q._hitsUI),q._hitsUI.length<=0){if(q._queryDataUI=void 0,q._hoveredUI){q.fireEvent("UINodeLeave",q._hoveredUI);const e=q.getUINode(q._hoveredUI);e&&e.onLeave&&e.onLeave()}return q._hoveredUI=void 0,void(q._tHover=void 0)}const e=q._hitsUI[0];if(q._queryDataScene&&q._queryDataScene.d<e.distance){if(q._queryDataUI=void 0,q._hoveredUI){q.fireEvent("UINodeLeave",q._hoveredUI);const e=q.getUINode(q._hoveredUI);e&&e.onLeave&&e.onLeave()}return q._hoveredUI=void 0,void(q._tHover=void 0)}q._queryDataUI={},q._queryDataUI.p=e.point,q._queryDataUI.d=e.distance,q._queryDataUI.o=e.object,q._queryDataUI.list=[];const t=q._queryDataUI.list;let o=e.object.parent;for(;o;)o.nid&&o.nid!==q.ROOT_NID&&t.push(o.nid),o=o.parent;const i=t[0];if(i&&q._hoveredUI!==i){if(q._hoveredUI){q.fireEvent("UINodeLeave",q._hoveredUI);const e=q.getUINode(q._hoveredUI);e&&e.onLeave&&e.onLeave(),q._tHover=void 0}q._hoveredUI=i,q.fireEvent("UINodeHover",i);const e=q.getUINode(i);e&&e.onHover&&e.onHover(),q._tHover=q._clock.elapsedTime}},q.getHoveredSemanticNode=()=>{if(void 0!==q._hoveredSemNode)return q.getSemanticNode(q._hoveredSemNode)},q.setAPIToken=(e,t)=>{window.sessionStorage.setItem("ATON.tokens."+e,t)},q.getAPIToken=e=>window.sessionStorage.getItem("ATON.tokens."+e),q.clearToken=e=>{window.sessionStorage.removeItem("ATON.tokens."+e)},q.useGizmo=e=>{q._bGizmo=e,q._setupGizmo()},q._setupGizmo=()=>{q._bGizmo?void 0!==q.Nav._camera&&void 0!==q._renderer&&(void 0===q._gizmo?(q._gizmo=new THREE.TransformControls(q.Nav._camera,q._renderer.domElement),q._rootUI.add(q._gizmo),q._gizmo.setMode("rotate"),q._gizmo.addEventListener("dragging-changed",(function(e){let t=e.value;q.Nav.setUserControl(!t),q._bPauseQuery=t,t||(q.recomputeSceneBounds(),q.updateLightProbes(),console.log(q._gizmo.object))}))):(q._gizmo.camera=q.Nav._camera,q._gizmo.detach())):q._gizmo&&q._gizmo.detach()}})();