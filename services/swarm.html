<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        
        <title>VRoadcast Traces</title>
        <script src="js/plotly.min.js"></script>
        <script src="js/utils.js"></script>
        <link rel="stylesheet" type="text/css" href="css/records.css">
    </head>
    <body>
        <!-- Plotly chart will be drawn inside this DIV -->
        <div class="sessionView">
            <div id="idSwarmView" style="width:100%; height:100%"></div>
        </div>

        <div style="position:fixed; bottom:5px; left:5px;">
            <b>Swarm temporal range: </b>
            <span id="idTimeRange"></span>
        </div>
<script>

var wH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

var timerange = [ 0.0, 0.0 ];
var tMin = undefined;
var tMax = undefined;

var data = [];
var req  = 0;

var drawFinalPlot = function(){
    var layout = {
        height: wH,

        paper_bgcolor: "#CCC",

        margin: {
            l: 0,
            r: 0,
            b: 0,
            t: 0
            }
        };

    Plotly.newPlot('idSwarmView', data, layout);

    document.getElementById("idTimeRange").innerHTML = tMin+"s to "+tMax+"s";
};

var plotSwarm = function(scenename){

    console.log("SCENE "+scenename);
    req++;

    Plotly.d3.csv('record/'+scenename+'.swarm.csv', function(err, rows){
/*
        function unpack(rows, key) {
            var A = rows.map(
                function(row){
                    //var b = (row['Minutes'] >= timerange[0].min && row['Seconds'] >= timerange[0].sec && row['Minutes'] < timerange[1].min && row['Seconds'] < timerange[1].sec);
                    return row[key];
                });

            return A;
            }
*/
        function unpack2(rows, key){
            var A = [];

            rows.forEach(function (row){
                var t = parseInt(row['Time']);
                //console.log(t);

                if (tMin === undefined || t < tMin) tMin = t;
                if (tMax === undefined || t > tMax) tMax = t;

                var b = (t >= timerange[0] && t < timerange[1]);
                if (b || timerange[1]<=timerange[0]) A.push(row[key]);
                });

            return A;
            }

        var swarmLocomotion = {
            x: unpack2(rows, 'swarmX'),
            y: unpack2(rows, 'swarmY'),
            z: unpack2(rows, 'swarmZ'),
            //t: unpack2(rows, 'Time'),
            users: unpack2(rows, 'Users'), 
/*
            mode: 'markers',
            marker: {
                color: 'rgb(0, 0, 127)',
                size: 30,
                symbol: 'circle',
                opacity: 0.004
            },
*/
            mode: 'lines',
            line: {
                color: 'rgb(0, 0, 127)',
                width: 10
                },

            type: 'scatter3d',
            name: 'Swarm Locomotion'
            };

    data.push(swarmLocomotion);

    req--;
    if (req <= 0) drawFinalPlot();
    });
};


var tRange = getURLparams().t;
if (tRange){
    tR = tRange.split(',');
    timerange[0] = tR[0];
    timerange[1] = tR[1];
}


var scene = getURLparams().s;
if (scene){
    plotSwarm(scene);
}

</script>

        </div>
    </body>
</html>
