<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
        
        <title>VRoadcast Traces</title>
        <script src="js/plotly.min.js"></script>
        <script src="js/utils.js"></script>
        <link rel="stylesheet" type="text/css" href="css/records.css">
    </head>
    <body>
        <!-- Plotly chart will be drawn inside this DIV -->
        <div class="sessionView">
            <div id="idSessionView" style="width:100%; height:100%"></div>
        </div>

        <div style="position:fixed; bottom:5px; left:5px;">
            <b>Sessions temporal range: </b>
            <span id="idTimeRange"></span>
        </div>
<script>

var wH = window.innerHeight || document.documentElement.clientHeight || document.body.clientHeight;

var timerange = [ 0.0, 0.0 ];
var tMin = undefined;
var tMax = undefined;

var data = [];
var req  = 0;

var uColors = [
    {
        locomotion: 'rgb(127, 0, 0)',
        focus: 'rgb(255, 127, 127)',
    },
    {
        locomotion: 'rgb(127, 127, 0)',
        focus: 'rgb(255, 255, 127)',
    },
    {
        locomotion: 'rgb(0, 127, 0)',
        focus: 'rgb(127, 255, 127)',
    },
    {
        locomotion: 'rgb(0, 127, 127)',
        focus: 'rgb(127, 255, 255)',
    },
    {
        locomotion: 'rgb(0, 0, 127)',
        focus: 'rgb(127, 127, 255)',
    },
    {
        locomotion: 'rgb(127, 0, 127)',
        focus: 'rgb(255, 127, 255)',
    }
];

var drawFinalPlot = function(){
    var layout = {
        height: wH,
        margin: {
            l: 0,
            r: 0,
            b: 0,
            t: 0
            }
        };

    Plotly.newPlot('idSessionView', data, layout);

    document.getElementById("idTimeRange").innerHTML = tMin+"s to "+tMax+"s";
};

var plotUser = function(uid){

    console.log("USER "+uid);
    req++;

    Plotly.d3.csv('record/U'+uid+'.csv', function(err, rows){
/*
        function unpack(rows, key) {
            var A = rows.map(
                function(row){
                    //var b = (row['Minutes'] >= timerange[0].min && row['Seconds'] >= timerange[0].sec && row['Minutes'] < timerange[1].min && row['Seconds'] < timerange[1].sec);
                    return row[key];
                });

            return A;
            }
*/
        function unpack2(rows, key){
            var A = [];

            rows.forEach(function (row){
                var t = parseInt(row['Time']);
                //console.log(t);

                if (tMin === undefined || t < tMin) tMin = t;
                if (tMax === undefined || t > tMax) tMax = t;

                var b = (t >= timerange[0] && t < timerange[1]);
                if (b || timerange[1]<=timerange[0]) A.push(row[key]);
                });

            return A;
            }

        var locomotion = {
            x: unpack2(rows, 'px'),
            y: unpack2(rows, 'py'),
            z: unpack2(rows, 'pz'),
            t: unpack2(rows, 'Time'),

            mode: 'lines',
            //width: 4,
            //color: uColors[uid].locomotion,

            marker: {
                size: 12,
                color: uColors[uid].locomotion,
                opacity: 1.0,
                width: 10
                },

            type: 'scatter3d',
            name: 'USER'+uid + ' Locomotion'
            };

        var focus = {
            x: unpack2(rows, 'fx'),
            y: unpack2(rows, 'fy'),
            z: unpack2(rows, 'fz'),
            t: unpack2(rows, 'Time'), 
            
            mode: 'markers',
            marker: {
                color: uColors[uid].focus,
                size: 10,
                symbol: 'circle',
                opacity: 0.1
            },
            type: 'scatter3d',
            name: 'USER'+uid + ' Focus'
            };

    //[locomotion, focus];
    data.push(locomotion);
    data.push(focus);

    //console.log(focus);

    req--;
    if (req <= 0) drawFinalPlot();
    });
};


var tRange = getURLparams().t;
if (tRange){
    tR = tRange.split(',');
    timerange[0] = tR[0];
    timerange[1] = tR[1];
}


var uString = getURLparams().u;
if (uString){
    uIDs = uString.split(',');

    for (let u = 0; u < uIDs.length; u++){
        plotUser(uIDs[u]);
        }
}

</script>

        </div>
    </body>
</html>
