<!doctype html>
<html lang="en">

<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">

<title>ATONIZER</title>
<link rel="stylesheet" type="text/css" href="../../css/aton.css">

<script type="text/javascript" src="../../vendors/jquery.min.js"></script>

<script>
//============================================================================
let configdata = undefined;
let bProcessing = false;
let bCanProcess = false;

let onTaskCompleted = function(){
    $("#idProcessBTN").attr("class","atonBTN atonBTN-green atonizerProcessBTN");
    
    console.log("Completed.");
    bProcessing = false;
};

let requestProcess = function(){
    if (bProcessing) return;
    if (!bCanProcess) return;

    bProcessing = true;
    $("#idProcessBTN").attr("class","atonBTN atonBTN-red atonizerProcessBTN");

    // Build args
    let args = {};
    args.infolder  = $("#inFolder").val();
    
    if (document.getElementById('inPlaceConv').checked) args.outfolder = $("#inFolder").val();
    else {
        let idproj = $("#outProject").val();
        idproj = idproj.replace(/[^\w\s]/gi, '');
        idproj = idproj.replace(/ /g,'');
        idproj += "/";

        args.outfolder = $("#outFolder").val() + idproj;
        }
    args.pattern = $("#pattern").val();

    //console.log(args);
    //return;

    // Fire request
    let udata = JSON.stringify(args);    
    $.ajax({
        url: "./api/process",
        type:"POST",
        data: udata,
        contentType:"application/json; charset=utf-8",
        dataType:"json",
        success: onTaskCompleted
    });
};

let onSwitchInplace = function(){
    if (document.getElementById('inPlaceConv').checked) $("#idOutBlock").hide();
    else $("#idOutBlock").show();

    bCanProcess = validateFields();
}

let validateFields = function(){
    let b = true;
    let bmsg = "PROCESS";

    let bInPlace = document.getElementById('inPlaceConv').checked;

    let pstring = $('#outProject').val();
    if (pstring.length < 2 && !bInPlace){
        b = false;
        bmsg = "Missing Project ID";
        }

    if (b){
        $("#idProcessBTN").attr("class","atonBTN atonBTN-green atonizerProcessBTN");
        }
    else {
        $("#idProcessBTN").attr("class","atonBTN atonBTN-red atonizerProcessBTN");
        }

    $("#idProcessBTN").html("<h3>"+bmsg+"</h3>");
    
    return b;
}

window.addEventListener( 'load', ()=>{

    bCanProcess = validateFields();

    $('#outProject').on('keyup', ()=>{
        bCanProcess = validateFields();
        });

    // Request config
    $.getJSON("./config", function( data ){
        configdata = data;

        if (!data.infolders) return;

        console.log(data);

        for (let p in data.infolders){
            let path = data.infolders[p];
            $("#inFolder").append("<option value='"+path+"'>"+path+"</option>");
            }

        if (!data.outfolders) return;

        for (let p in data.outfolders){
            let path = data.outfolders[p];
            $("#outFolder").append("<option value='"+path+"'>"+path+"</option>");
            }
        });


});
</script>
</head>


<body class="atonizerBody">
	<div style="text-align: center;">
		<h1>ATONIZER</h1>
    </div>
    
    <div class="atonizerBlockGroup">
        <!-- INPUT -->
        <div class="atonizerBlockTitle">INPUT</div>
        <div class="atonizerBlock">

            <div class="atonizerOptionBlock" style="width: 70%;">
                <label for="inFolder">Input folder</label><br>
                <div class="select">
                    <select id="inFolder"></select>
                    <div class="selectArrow"></div>
                </div>
            </div>

            <div class="atonizerOptionBlock">
                <label for="pattern">Pattern</label><br>
                <div class="select" style="width: 100px;">
                    <select id="pattern">
                        <option value="*.obj">*.obj</option>
                        <option value="*.osg">*.osg</option>
                    </select>
                    <div class="selectArrow"></div>
                </div>
            </div>
        </div>
            
        <!-- OUTPUT -->
        <div class="atonizerBlockTitle">OUTPUT</div>
        <div class="atonizerBlock">

            <div class="atonizerOptionBlock">
                <label for="inPlaceConv">Convert in-place</label><br>
                <input id="inPlaceConv" type="checkbox" onchange="onSwitchInplace()">
            </div>

            <span id="idOutBlock">
            <div class="atonizerOptionBlock" style="width: 50%;">
                <label for="outFolder">Output Folder</label><br>
                <div class="select">
                    <select id="outFolder"></select>
                    <div class="selectArrow"></div>
                </div>
            </div>

            <div class="atonizerOptionBlock">
                <label for="outProject">Project ID</label><br>
                <input id="outProject" type="text" size="20" placeholder="project">
            </div>
            </span>
        </div>

        <!-- OPTIONS -->
        <div class="atonizerBlockTitle"  onclick="$('#idOptionsBlock').toggle()">OPTIONS</div>
        <div class="atonizerBlock" id="idOptionsBlock">

            <!-- Trans -->
            <div class="atonizerOptionBlock" style="max-width:300px; width:50%;">
                <div class="atonizerSubtitle">TRANSFORM</div>
                <div style="text-align: right;">
                    <label for="yup">From Y-up to Z-up</label>
                    <input id="yup" type="checkbox"><br>

                    <label for="translate">Translate (x,y,z)</label>
                    <input id="translate" type="text"><br>

                    <label for="scale">Scale (x,y,z)</label>
                    <input id="scale" type="text"><br>
                </div>
            </div>

            <!-- Geom -->
            <div class="atonizerOptionBlock" style="max-width:300px; width:50%;">
                <div class="atonizerSubtitle">GEOMETRY</div>
                <div style="text-align: right;">
                    <!--
                    <label for="compressGeometry">Compress Geometry</label>
                    <input id="compressGeometry" type="checkbox"  checked><br>
                    -->

                    <label for="smoothNorm">Smooth Normals</label>
                    <input id="smoothNorm" type="checkbox"><br>

                    <label for="simplifyGeometry">Simplification (0: none, 10: max)</label>
                    <input id="simplifyGeometry" type="number" min="0" max="10" value="0">
                </div>
            </div>

            <!-- Tex -->
            <div class="atonizerOptionBlock" style="max-width:300px; width:50%;">
                <div class="atonizerSubtitle">TEXTURES</div>
                <div style="text-align: right;">
                    <label for="inlineTex">Inline Textures</label>
                    <input id="inlineTex" type="checkbox"><br>
                </div>
            </div>

        </div>

        <!-- PROCESS -->
        <div id="idProcessBTN" class="atonBTN atonBTN-green atonizerProcessBTN" onclick="requestProcess();"></div>

    </div>


</body>
</html>
